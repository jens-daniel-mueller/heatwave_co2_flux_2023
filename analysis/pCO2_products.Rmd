---
title: "pCO2 products"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r load_libraries_specific, include = FALSE}

library(stars)
library(lubridate)
library(ggnewscale)
library(khroma)

```

# Read data

```{r define_paths}

path_pCO2_products <-
  "/nfs/kryo/work/datasets/gridded/ocean/2d/observation/pco2/"

path_reccap2 <-
  "/nfs/kryo/work/datasets/gridded/ocean/interior/reccap2/"

```

```{r read_region_mask}

region_masks_all <-
  read_ncdf(
    paste(
      path_reccap2,
      "supplementary/RECCAP2_region_masks_all_v20221025.nc",
      sep = ""
    )
  ) %>%
  as_tibble()

```


```{r read_nc_metadata, eval=FALSE}

library(ncdf4)
nc <-
  nc_open(paste0(
    path_pCO2_products,
    "VLIZ-SOM_FFN/VLIZ-SOM_FFN_vBAMS2024.nc"
  ))

print(nc)

```


```{r read_VLIZ_SOM_FFN}

SOM_FFN <-
  read_ncdf(
    paste0(
      path_pCO2_products,
      "VLIZ-SOM_FFN/VLIZ-SOM_FFN_vBAMS2024.nc"
    ),
    var = c("dco2", "atm_co2", "sol", "kw", "spco2_smoothed", "fgco2_smoothed"),
    make_units = FALSE
  )

SOM_FFN <- SOM_FFN %>%
  as_tibble()

SOM_FFN <-
  SOM_FFN %>%
  mutate(across(dco2:fgco2_smoothed, ~ replace(., . >= 1e+19, NA)))

SOM_FFN <-
  SOM_FFN %>%
  mutate(area = earth_surf(lat, lon),
         year = year(time),
         month = month(time))

SOM_FFN <-
  SOM_FFN %>% 
  mutate(lon = if_else(lon < 0, lon + 360, lon))

```

# Biome mask

```{r prepare_region_mask, fig.asp=0.5}

land_mask <- region_masks_all %>%
  filter(seamask == 0)

map <- ggplot(land_mask,
              aes(lon, lat)) +
  geom_tile(fill = "grey80") +
  coord_quickmap(expand = 0) +
  theme(axis.title = element_blank())


region_masks_all <- region_masks_all %>%
  filter(seamask == 1) %>% 
  select(lon, lat, atlantic:southern) %>% 
  pivot_longer(atlantic:southern,
               names_to = "region",
               values_to = "biome") %>%
  mutate(biome = as.character(biome))

region_masks_all <- region_masks_all %>%
  filter(biome != "0")

region_masks_all <- region_masks_all %>%
  mutate(biome = paste(region, biome, sep = "_"))


# map +
#   geom_raster(data = region_masks_all,
#               aes(lon, lat, fill = biome))


region_masks_all <- region_masks_all  %>% 
  mutate(biome = case_when(
    biome == "atlantic_1" ~ "NA-SPSS",
    biome == "atlantic_2" ~ "NA-STSS",
    biome == "atlantic_3" ~ "NA-STPS",
    biome == "atlantic_4" ~ "AEQU",
    biome == "atlantic_5" ~ "SA-STPS",
    biome == "atlantic_6" ~ "MED",
    biome == "pacific_1" ~ "NP-SPSS",
    biome == "pacific_2" ~ "NP-STSS",
    biome == "pacific_3" ~ "NP-STPS",
    biome == "pacific_4" ~ "PEQU-W",
    biome == "pacific_5" ~ "PEQU-E",
    biome == "pacific_6" ~ "SP-STSS",
    biome == "indian_1" ~ "Arabian Sea",
    biome == "indian_2" ~ "Bay of Bengal",
    biome == "indian_3" ~ "Equatorial Indian",
    biome == "indian_4" ~ "Southern Indian",
    # biome == "arctic_1" ~ "ARCTIC-ICE",
    # biome == "arctic_2" ~ "NP-ICE",
    # biome == "arctic_3" ~ "NA-ICE",
    # biome == "arctic_4" ~ "Barents",
    str_detect(biome, "arctic") ~ "Arctic",
    biome == "southern_1" ~ "SO-STSS",
    biome == "southern_2" ~ "SO-SPSS",
    biome == "southern_3" ~ "SO-ICE",
    TRUE ~ "other"
  ))

region_masks_all <-
  region_masks_all %>%
  filter(biome != "other")


map +
  geom_tile(data = region_masks_all,
            aes(lon, lat, fill = region)) +
  scale_fill_muted()

region_masks_all %>%
  group_split(region) %>%
  # head(2) %>%
  map(~ map +
        geom_tile(data = .x,
                    aes(lon, lat, fill = biome)) +
        labs(title = .x$region) +
        scale_fill_okabeito())

key_biomes <- c("global",
                "NA-SPSS",
                "NA-STPS",
                "NP-SPSS",
                "PEQU-E",
                "SO-SPSS")


map +
  geom_tile(data = region_masks_all %>% filter(biome %in% key_biomes),
            aes(lon, lat, fill = biome)) +
  labs(title = "Selected key biomes") +
  scale_fill_muted()

```


# pCO2 products

## Climatology maps

```{r climatology_maps, fig.asp=0.5}

SOM_FFN_annual_mean_maps <-
  SOM_FFN %>%
  group_by(year, lon, lat) %>%
  summarise(across(dco2:fgco2_smoothed,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_climatology <-
  SOM_FFN_annual_mean_maps %>%
  filter(year >= 1990,
         year <= 2022) %>%
  group_by(lon, lat) %>%
  summarise(across(dco2:fgco2_smoothed,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_2023_anomaly <-
  bind_rows(
    SOM_FFN_climatology %>% mutate(reference = "climatology"),
    SOM_FFN_annual_mean_maps %>%
      filter(year == 2023) %>%
      select(-year) %>% 
      mutate(reference = "2023")
  )

SOM_FFN_2023_anomaly <-
  SOM_FFN_2023_anomaly %>%
  pivot_longer(-c(lon, lat, reference)) %>%
  pivot_wider(names_from = reference,
              values_from = value) %>%
  mutate(anomaly = `2023` - climatology)

SOM_FFN_2023_anomaly %>%
  group_split(name) %>%
  # head(1) %>%
  map(~ map +
        geom_tile(data = .x,
                  aes(lon, lat, fill = climatology)) +
        labs(title = .x$name) +
        scale_fill_viridis_c())

```

## Anomaly maps

```{r anomaly_maps}


SOM_FFN_2023_anomaly %>%
  group_split(name) %>%
  # head(1) %>%
  map(~ map +
        geom_tile(data = .x,
                  aes(lon, lat, fill = anomaly)) +
        labs(title = .x$name) +
        scale_fill_divergent())


```


## Regional means and integrals



```{r global_means_and_integrals}

SOM_FFN <-
  inner_join(SOM_FFN,
             region_masks_all)

SOM_FFN_monthly_global <-
  SOM_FFN %>%
  group_by(time) %>% 
  summarise(across(dco2:spco2_smoothed, 
                   ~weighted.mean(., area, na.rm = TRUE)),
            across(fgco2_smoothed, 
                   ~sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>% 
  ungroup()

SOM_FFN_monthly_biome <-
  SOM_FFN %>%
  group_by(time, region, biome) %>% 
  summarise(across(dco2:spco2_smoothed, 
                   ~weighted.mean(., area, na.rm = TRUE)),
            across(fgco2_smoothed, 
                   ~sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>% 
  ungroup()
  
SOM_FFN_monthly <- 
  bind_rows(SOM_FFN_monthly_global %>% 
              mutate(biome = "global",
                     region = "global"),
            SOM_FFN_monthly_biome)

rm(SOM_FFN_monthly_global,
   SOM_FFN_monthly_biome)


SOM_FFN_monthly <-
SOM_FFN_monthly %>%
  mutate(year = year(time),
         month = month(time),
         .after = time)

SOM_FFN_monthly <-
  SOM_FFN_monthly %>%
  pivot_longer(-c(time:month, biome, region))




```


### Seasonality

```{r seasonality_overview}

SOM_FFN_monthly %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < 2022),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(year >= 2022),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.y = element_blank())


```


```{r seasonality_key_biomes, fig.asp=1.5}

SOM_FFN_monthly %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < 2022),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(year >= 2022),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      facet_grid(name ~ biome, scales = "free_y") +
      theme(legend.title = element_blank(),
            axis.title.y = element_blank())
  )

```






```{r regional_seasonality, fig.asp=1.5, eval=FALSE}

SOM_FFN_monthly %>%
  pivot_longer(-c(time:month, biome)) %>%
  filter(
    # biome %in% c("global", "NA-SPSS", "NA-STPS", "NP-SPSS"),
    name %in% c(
      "dco2_mean",
      "atm_co2_mean",
      "sol_mean",
      "kw_mean",
      "spco2_smoothed_mean",
      "fgco2_smoothed_integral"
    )
  ) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < 2022),
                aes(col = year)) +
      scale_color_viridis_c(direction = -1) +
      new_scale_color() +
      geom_path(
        data = . %>% filter(year >= 2022),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(values = c("orange", "red")) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      facet_grid(name ~ biome, scales = "free_y") +
      theme(legend.title = element_blank())
  )


```

