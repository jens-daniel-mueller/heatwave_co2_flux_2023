---
title: "pCO2 products"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r load_libraries_specific, include = FALSE}

library(stars)
library(lubridate)
library(ggnewscale)
library(khroma)
library(broom)
library(scico)

```

# Read data

```{r define_paths}

path_pCO2_products <-
  "/nfs/kryo/work/datasets/gridded/ocean/2d/observation/pco2/"

path_reccap2 <-
  "/nfs/kryo/work/datasets/gridded/ocean/interior/reccap2/"

```

```{r read_region_mask}

print("RECCAP2_region_masks_all_v20221025.nc")

region_masks_all <-
  read_ncdf(
    paste(
      path_reccap2,
      "supplementary/RECCAP2_region_masks_all_v20221025.nc",
      sep = ""
    )
  ) %>%
  as_tibble()

```

```{r read_nc_metadata, eval=FALSE}

library(ncdf4)
nc <-
  nc_open(paste0(
    path_pCO2_products,
    "VLIZ-SOM_FFN/VLIZ-SOM_FFN_vBAMS2024.nc"
  ))

print(nc)

```


```{r read_VLIZ_SOM_FFN}

print("VLIZ-SOM_FFN/VLIZ-SOM_FFN_vBAMS2024.nc")

SOM_FFN <-
  read_ncdf(
    paste0(
      path_pCO2_products,
      "VLIZ-SOM_FFN/VLIZ-SOM_FFN_vBAMS2024.nc"
    ),
    var = c("dco2", "atm_co2", "sol", "kw", "spco2_smoothed", "fgco2_smoothed"),
    make_units = FALSE
  )

SOM_FFN <- SOM_FFN %>%
  as_tibble()

SOM_FFN <-
  SOM_FFN %>%
  rename(spco2 = spco2_smoothed, fgco2 = fgco2_smoothed)

SOM_FFN <-
  SOM_FFN %>%
  mutate(across(dco2:fgco2, ~ replace(., . >= 1e+19, NA)))

SOM_FFN <-
  SOM_FFN %>%
  mutate(area = earth_surf(lat, lon),
         year = year(time),
         month = month(time))

SOM_FFN <-
  SOM_FFN %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

# Analysis settings

```{r analysis_settings}

key_biomes <- c("global",
                "NA-SPSS",
                "NA-STPS",
                "NP-SPSS",
                "PEQU-E",
                "SO-SPSS")

name_quadratic_fit <- c("atm_co2", "spco2")

start_year <- 1990

name_divergent <- c("dco2", "fgco2")

```

# Anomaly detection

For the detection of anomalies at any point in time and space, we fit regression models and compare the fitted to the actual value.

We use linear regression models for all parameters, except for `r print(name_quadratic_fit)``, which are approximated with quadratic fits.

The regression models are fitted to data from the period `r print(paste(start_year, "- 2022"))``, and extrapolated to 2023.


```{r anomaly_detection_function}

anomaly_determination <- function(df) {
  
  # Linear regression models
  
  df_lm <-
    df %>%
    filter(year <= 2022,
           !(name %in% name_quadratic_fit)) %>%
    nest(data = -name) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year, data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_lm_2023 <-
    full_join(
      df_lm %>%
        unnest(tidied) %>%
        select(name, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * 2023) %>%
        select(name, fit) %>%
        mutate(year = 2023),
      df %>%
        filter(year == 2023,
               !(name %in% name_quadratic_fit))
    ) %>%
    mutate(resid = value - fit)
  
  
  df_lm <-
    bind_rows(
      df_lm %>%
        unnest(augmented) %>%
        select(name, year, value, fit = .fitted, resid = .resid),
      df_lm_2023
    )
  
  rm(df_lm_2023)
  
  # Quadratic regression models
  
  df_quadratic <-
    df %>%
    filter(year <= 2022,
           name %in% name_quadratic_fit) %>%
    nest(data = -name) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year + I(year ^ 2), data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_quadratic_2023 <-
    full_join(
      df_quadratic %>%
        unnest(tidied) %>%
        select(name, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * 2023 + `I(year^2)` * 2023 ^ 2) %>%
        select(name, fit) %>%
        mutate(year = 2023),
      df %>%
        filter(year == 2023,
               name %in% name_quadratic_fit)
    ) %>%
    mutate(resid = value - fit)
  
  
  df_quadratic <-
    bind_rows(
      df_quadratic %>%
        unnest(augmented) %>%
        select(name, year, value, fit = .fitted, resid = .resid),
      df_quadratic_2023
    )
  
  rm(df_quadratic_2023)
  
  # Join linear and quadratic regression results
  
  df_regression <-
    bind_rows(df_lm,
              df_quadratic)
  
  rm(df_lm,
     df_quadratic)
  
  
  return(df_regression)
  
}

```

```{r anomaly_detection_function_nested}

# my_sum <- function(df, col_to_sum,...) {
# 
#     col_to_sum <- enquo(col_to_sum)
#     group_by <- quos(...)
# 
#     df %>%
#         group_by(!!!group_by) %>%
#         summarise(total_sum = sum(!!col_to_sum)) %>% 
#         ungroup()
# }
# 
# transactions %>% my_sum(amount, accountid, month)

anomaly_determination <- function(df) {
  
  # Linear regression models
  
  df_lm <-
    df %>%
    filter(year <= 2022,
           !(name %in% name_quadratic_fit)) %>%
    nest(data = -name) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year, data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_lm_2023 <-
    full_join(
      df_lm %>%
        unnest(tidied) %>%
        select(name, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * 2023) %>%
        select(name, fit) %>%
        mutate(year = 2023),
      df %>%
        filter(year == 2023,
               !(name %in% name_quadratic_fit))
    ) %>%
    mutate(resid = value - fit)
  
  
  df_lm <-
    bind_rows(
      df_lm %>%
        unnest(augmented) %>%
        select(name, year, value, fit = .fitted, resid = .resid),
      df_lm_2023
    )
  
  rm(df_lm_2023)
  
  # Quadratic regression models
  
  df_quadratic <-
    df %>%
    filter(year <= 2022,
           name %in% name_quadratic_fit) %>%
    nest(data = -name) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year + I(year ^ 2), data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_quadratic_2023 <-
    full_join(
      df_quadratic %>%
        unnest(tidied) %>%
        select(name, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * 2023 + `I(year^2)` * 2023 ^ 2) %>%
        select(name, fit) %>%
        mutate(year = 2023),
      df %>%
        filter(year == 2023,
               name %in% name_quadratic_fit)
    ) %>%
    mutate(resid = value - fit)
  
  
  df_quadratic <-
    bind_rows(
      df_quadratic %>%
        unnest(augmented) %>%
        select(name, year, value, fit = .fitted, resid = .resid),
      df_quadratic_2023
    )
  
  rm(df_quadratic_2023)
  
  # Join linear and quadratic regression results
  
  df_regression <-
    bind_rows(df_lm,
              df_quadratic)
  
  rm(df_lm,
     df_quadratic)
  
  
  return(df_regression)
  
}

```

# Biome mask

```{r prepare_region_mask, fig.asp=0.5}

region_masks_all <-
  region_masks_all %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

land_mask <- region_masks_all %>%
  filter(seamask == 0) %>% 
  select(lon, lat)

map <- ggplot(land_mask,
              aes(lon, lat)) +
  geom_tile(fill = "grey80") +
  scale_y_continuous(breaks = seq(-60,60,30)) +
  scale_x_continuous(breaks = seq(0,360,60)) +
  coord_quickmap(expand = 0, ylim = c(-80, 80)) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
  
region_masks_all <- region_masks_all %>%
  filter(seamask == 1) %>% 
  select(lon, lat, atlantic:southern) %>% 
  pivot_longer(atlantic:southern,
               names_to = "region",
               values_to = "biome") %>%
  mutate(biome = as.character(biome))

region_masks_all <- region_masks_all %>%
  filter(biome != "0")

region_masks_all <- region_masks_all %>%
  mutate(biome = paste(region, biome, sep = "_"))

region_masks_all <- region_masks_all  %>% 
  mutate(biome = case_when(
    biome == "atlantic_1" ~ "NA-SPSS",
    biome == "atlantic_2" ~ "NA-STSS",
    biome == "atlantic_3" ~ "NA-STPS",
    biome == "atlantic_4" ~ "AEQU",
    biome == "atlantic_5" ~ "SA-STPS",
    # biome == "atlantic_6" ~ "MED",
    biome == "pacific_1" ~ "NP-SPSS",
    biome == "pacific_2" ~ "NP-STSS",
    biome == "pacific_3" ~ "NP-STPS",
    biome == "pacific_4" ~ "PEQU-W",
    biome == "pacific_5" ~ "PEQU-E",
    biome == "pacific_6" ~ "SP-STSS",
    biome == "indian_1" ~ "Arabian Sea",
    biome == "indian_2" ~ "Bay of Bengal",
    biome == "indian_3" ~ "Equatorial Indian",
    biome == "indian_4" ~ "Southern Indian",
    # biome == "arctic_1" ~ "ARCTIC-ICE",
    # biome == "arctic_2" ~ "NP-ICE",
    # biome == "arctic_3" ~ "NA-ICE",
    # biome == "arctic_4" ~ "Barents",
    # str_detect(biome, "arctic") ~ "Arctic",
    biome == "southern_1" ~ "SO-STSS",
    biome == "southern_2" ~ "SO-SPSS",
    # biome == "southern_3" ~ "SO-ICE",
    TRUE ~ "other"
  ))

region_masks_all <-
  region_masks_all %>%
  filter(biome != "other")


map +
  geom_tile(data = region_masks_all,
            aes(lon, lat, fill = region)) +
  labs(title = "Considered ocean regions") +
  scale_fill_muted() +
  theme(legend.title = element_blank())

region_masks_all %>%
  group_split(region) %>%
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = biome)) +
         labs(title = paste("Region:", .x$region)) +
         scale_fill_okabeito())


map +
  geom_tile(data = region_masks_all %>% filter(biome %in% key_biomes),
            aes(lon, lat, fill = biome)) +
  labs(title = "Selected biomes to highlight") +
  scale_fill_muted() +
  theme(legend.title = element_blank())


region_masks_all <-
  region_masks_all %>%
  select(-region)

```


# Preprocessing

```{r temporal_boundaries}

SOM_FFN <-
  SOM_FFN %>%
  filter(year >= start_year)

```


```{r biome_mask}

SOM_FFN <-
  full_join(SOM_FFN,
            region_masks_all)

# set all values outside biome mask to NA

SOM_FFN <-
  SOM_FFN %>%
  mutate(across(dco2:fgco2, ~ if_else(is.na(biome), NA, .)))

# map +
#   geom_tile(data = SOM_FFN %>% filter(time == max(time),
#                                       !is.na(fgco2)),
#             aes(lon, lat))

```


# Maps

The following maps show the absolute state of each variable in 2023 as provided through the pCO2 product, the change in that variable from 1990 to 2023, as well es the anomalies in 2023. Changes and anomalies are determined based on the predicted value of a linear regression model fit to the data from 1990 to 2022.

Maps are first presented as annual means, and than as monthly means. Note that the 2023 predictions for the monthly maps are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.


```{r climatology_maps, fig.asp=0.5, eval=FALSE}

SOM_FFN_annual_mean_maps <-
  SOM_FFN %>%
  drop_na() %>% 
  group_by(year, lon, lat) %>%
  summarise(across(dco2:fgco2,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_climatology <-
  SOM_FFN_annual_mean_maps %>%
  drop_na() %>% 
  filter(year <= 2022) %>%
  group_by(lon, lat) %>%
  summarise(across(dco2:fgco2,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_2023_anomaly <-
  bind_rows(
    SOM_FFN_climatology %>% mutate(reference = "climatology"),
    SOM_FFN_annual_mean_maps %>%
      filter(year == 2023) %>%
      select(-year) %>% 
      mutate(reference = "2023")
  )

SOM_FFN_2023_anomaly <-
  SOM_FFN_2023_anomaly %>%
  pivot_longer(-c(lon, lat, reference)) %>%
  pivot_wider(names_from = reference,
              values_from = value) %>%
  mutate(anomaly = `2023` - climatology)

SOM_FFN_2023_anomaly %>%
  filter(!(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = climatology)) +
      labs(title = "Climatology") +
      scale_fill_viridis_c()
  )

SOM_FFN_2023_anomaly %>%
  filter(name %in% name_divergent) %>% 
  group_split(name) %>%
  # head(2) %>%
  map(~ map +
        geom_tile(data = .x,
                  aes(lon, lat, fill = climatology)) +
        labs(title = "Climatology") +
        scale_fill_divergent(.x$name))

```


```{r compute_coarse_resolution_monthly_maps, fig.asp=0.5}

SOM_FFN_coarse <-
  m_grid_horizontal_coarse(SOM_FFN)

SOM_FFN_coarse <-
  SOM_FFN_coarse %>%
  group_by(year, month, lon_grid, lat_grid) %>%
  summarise(across(dco2:fgco2,
                   ~ weighted.mean(., area))) %>%
  ungroup() %>%
  rename(lon = lon_grid, lat = lat_grid) %>%
  drop_na()

```


## Annual means

### 2023 absolute

```{r 2023_annual_mean_maps, fig.asp=0.5}

SOM_FFN_coarse_annual <-
  SOM_FFN_coarse %>%
  group_by(year, lon, lat) %>%
  summarise(across(dco2:fgco2,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_coarse_annual <-
  SOM_FFN_coarse_annual %>% 
  pivot_longer(-c(year:lat))

SOM_FFN_coarse_annual_regression <-
  SOM_FFN_coarse_annual %>%
  group_by(lon, lat) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()
  

SOM_FFN_coarse_annual_regression %>%
  filter(year == 2023,
         !(name %in% name_divergent)) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = "Annual mean 2023") +
         scale_fill_viridis_c(name = .x$name))
  
SOM_FFN_coarse_annual_regression %>%
  filter(year == 2023,
         name %in% name_divergent) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = "Annual mean 2023") +
         scale_fill_divergent(name = .x$name))
  
```

### Change 1990 - 2023

```{r change_1990_2023_annual_mean_maps, fig.asp=0.5}


SOM_FFN_coarse_annual_regression %>%
  filter(year %in% c(min(year), max(year))) %>%
  select(-c(value, resid)) %>% 
  pivot_wider(names_from = year,
              values_from = fit) %>% 
  mutate(change = `2023` - `1990`) %>% 
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = change)) +
         labs(title =  "Change 1990-2023") +
         scale_fill_divergent(name = .x$name))

```

### 2023 anomaly

```{r anomaly_2023_annual_mean_maps, fig.asp=0.5}

SOM_FFN_coarse_annual_regression %>%
  filter(year == 2023) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = resid)) +
         labs(title =  "2023 anomaly") +
         scale_fill_divergent(name = .x$name))

```

## Monthly means

### 2023 absolute

```{r 2023_monthly_mean_maps, fig.asp=1.8}

SOM_FFN_coarse_monthly <-
  SOM_FFN_coarse %>%
  group_by(year, month, lon, lat) %>%
  summarise(across(dco2:fgco2,
                   ~ mean(.))) %>%
  ungroup()

SOM_FFN_coarse_monthly <-
  SOM_FFN_coarse_monthly %>% 
  pivot_longer(-c(year:lat))

SOM_FFN_coarse_monthly_regression <-
  SOM_FFN_coarse_monthly %>%
  group_by(lon, lat, month) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()
  

SOM_FFN_coarse_monthly_regression %>%
  filter(year == 2023,
         !(name %in% name_divergent)) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = "Monthly means 2023") +
         scale_fill_viridis_c(name = .x$name) +
         facet_wrap(~ month, ncol = 2))
  
SOM_FFN_coarse_monthly_regression %>%
  filter(year == 2023,
         name %in% name_divergent) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = "Monthly means 2023") +
         scale_fill_divergent(name = .x$name) +
         facet_wrap(~ month, ncol = 2))
  
```

### Change 1990 - 2023

```{r change_1990_2023_monthly_mean_maps, fig.asp=1.8}


SOM_FFN_coarse_monthly_regression %>%
  filter(year %in% c(min(year), max(year))) %>%
  select(-c(value, resid)) %>% 
  pivot_wider(names_from = year,
              values_from = fit) %>% 
  mutate(change = `2023` - `1990`) %>% 
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = change)) +
         labs(title = "Change 1990-2023") +
         scale_fill_divergent(name = .x$name) +
         facet_wrap(~ month, ncol = 2))

```

### 2023 anomaly

```{r anomaly_2023_monthly_mean_maps, fig.asp=1.8}

SOM_FFN_coarse_monthly_regression %>%
  filter(year == 2023) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = resid)) +
         labs(title = "2023 anomaly") +
         scale_fill_divergent(name = .x$name) +
         facet_wrap(~ month, ncol = 2))

```


# Hovmoeller plots


The following Hovmoeller plots show the value of each variable as provided through the pCO2 product, as well as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to 2022.

Hovmoeller plots are first presented as annual means, and than as monthly means. Note that the predictions for the monthly Hovmoeller plots are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.


## Annual means

### Absolute

```{r hovmoeller_annual_absolute, fig.asp=0.5}

SOM_FFN_hovmoeller_monthly_annual <-
  SOM_FFN %>%
  group_by(year, lat) %>%
  summarise(across(dco2:spco2, 
                   ~weighted.mean(., area, na.rm = TRUE)),
            across(fgco2, 
                   ~sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>% 
  ungroup() %>% 
  drop_na()

SOM_FFN_hovmoeller_monthly_annual <-
  SOM_FFN_hovmoeller_monthly_annual %>%
  pivot_longer(-c(year, lat))

SOM_FFN_hovmoeller_monthly_annual %>%
  group_split(name) %>%
  # head(1) %>%
  map(~ ggplot(data = .x,
                  aes(year, lat, fill = value)) +
        geom_raster() +
        scale_fill_viridis_c(.x$name) +
        coord_cartesian(expand = 0) +
        labs(title = "Annual means",
             y = "Latitude") +
        theme(axis.title.x = element_blank()))


```

### Anomalies


```{r hovmoeller_annual_anomaly, fig.asp=0.5}

SOM_FFN_hovmoeller_monthly_annual_regression <-
  SOM_FFN_hovmoeller_monthly_annual %>%
  group_by(lat) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()

  
SOM_FFN_hovmoeller_monthly_annual_regression %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(.x$name) +
      coord_cartesian(expand = 0) +
      labs(title = "Annual mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )


```


## Monthly means

### Absolute

```{r hovmoeller_monthly_absolute, fig.asp=0.5}

SOM_FFN_hovmoeller_monthly <-
  SOM_FFN %>%
  group_by(year, month, lat) %>%
  summarise(
    across(dco2:spco2,
           ~ weighted.mean(., area, na.rm = TRUE)),
    across(fgco2,
           ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)
  ) %>%
  ungroup() %>%
  drop_na()

SOM_FFN_hovmoeller_monthly <-
  SOM_FFN_hovmoeller_monthly %>%
  pivot_longer(-c(year, month, lat))

SOM_FFN_hovmoeller_monthly <-
  SOM_FFN_hovmoeller_monthly %>% 
  mutate(decimal = year + (month-1) / 12)

SOM_FFN_hovmoeller_monthly %>%
  group_split(name) %>%
  # head(1) %>%
  map(~ ggplot(data = .x,
                  aes(decimal, lat, fill = value)) +
        geom_raster() +
        scale_fill_viridis_c(.x$name) +
        coord_cartesian(expand = 0) +
        theme(axis.title.x = element_blank()))


```

### Anomalies

```{r hovmoeller_monthly_anomalies, fig.asp=0.5}

SOM_FFN_hovmoeller_monthly_regression <-
  SOM_FFN_hovmoeller_monthly %>%
  select(-c(decimal)) %>% 
  group_by(lat, month) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()

  
SOM_FFN_hovmoeller_monthly_regression <-
  SOM_FFN_hovmoeller_monthly_regression %>%
  mutate(decimal = year + (month - 1) / 12)
  
SOM_FFN_hovmoeller_monthly_regression %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(.x$name) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )
  



```

### Anomalies since 2021

```{r hovmoeller_monthly_anomalies_recent_years, fig.asp=0.5}

SOM_FFN_hovmoeller_monthly_regression %>%
  filter(year >= 2021) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(.x$name) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )

```


# Regional means and integrals

The following plots show biome- or global- averaged/integrated values of each variable as provided through the pCO2 product, as well as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to 2022.

Anomalies are first presented relative to the predicted annual mean of each year, hence preserving the seasonality. Furthermore, anomalies are presented relative to the predicted monthly mean values, such that the mean seasonality is removed.


```{r compute_global_means_and_integrals}

SOM_FFN_monthly_global <-
  SOM_FFN %>%
  group_by(time) %>% 
  drop_na() %>% 
  summarise(across(dco2:spco2, 
                   ~weighted.mean(., area, na.rm = TRUE)),
            across(fgco2, 
                   ~sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>% 
  ungroup()

SOM_FFN_monthly_biome <-
  SOM_FFN %>%
  drop_na() %>% 
  group_by(time, biome) %>% 
  summarise(across(dco2:spco2, 
                   ~weighted.mean(., area, na.rm = TRUE)),
            across(fgco2, 
                   ~sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>% 
  ungroup()
  
SOM_FFN_monthly <- 
  bind_rows(SOM_FFN_monthly_global %>% 
              mutate(biome = "Global"),
            SOM_FFN_monthly_biome)

rm(SOM_FFN_monthly_global,
   SOM_FFN_monthly_biome)


SOM_FFN_monthly <-
SOM_FFN_monthly %>%
  mutate(year = year(time),
         month = month(time),
         .after = time)

SOM_FFN_monthly <-
  SOM_FFN_monthly %>%
  pivot_longer(-c(time:month, biome))


```


## Absolute values

### Overview

```{r absolute_global_means_and_integrals_overview}

SOM_FFN_monthly %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < 2022),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(year >= 2022),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values") +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.y = element_blank())


```


### Selected biomes

```{r absolute_global_means_and_integrals_key_biomes, fig.asp=1.5}

SOM_FFN_monthly %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < 2022),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(year >= 2022),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = "Absolute values") +
      facet_grid(name ~ biome, scales = "free_y") +
      theme(legend.title = element_blank(),
            axis.title.y = element_blank())
  )

```

## Anomalies

### Annual mean trends

```{r annual_mean_trends}

SOM_FFN_annual <-
  SOM_FFN_monthly %>%
  group_by(year, biome, name) %>%
  summarise(value = mean(value)) %>%
  ungroup()
  
SOM_FFN_annual %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(year, value)) +
  geom_point() +
  geom_smooth(data = . %>% filter(year <= 2022,
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year <= 2022,
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = "Regression fit\n prior 2023") +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(axis.title = element_blank())

SOM_FFN_annual_regression <-
  SOM_FFN_annual %>%
  group_by(biome) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()
  

SOM_FFN_annual_regression %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(year < 2022),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(year >= 2022),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted)") +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title = element_blank())

SOM_FFN_annual_regression %>%
  filter(biome != "global") %>%
  ggplot(aes(biome, resid)) +
  geom_hline(yintercept = 0) +
  geom_jitter(data = . %>% filter(year < 2022),
             aes(fill = year),
             shape = 21, width = 0.2) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(year >= 2022),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  labs(title = "Residual from fit to annual means (actual - predicted)") +
  facet_grid(name ~ ., scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```


```{r anomalies_from_annual_mean_trends_overview}


SOM_FFN_annual_detrended <-
  full_join(SOM_FFN_monthly,
            SOM_FFN_annual_regression %>% select(-c(value, resid))) %>%
  mutate(resid = value - fit)

SOM_FFN_annual_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < 2022),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(year >= 2022),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean") +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.y = element_blank())

```


```{r anomalies_from_annual_mean_trends_key_biomes, fig.asp=1.5}

SOM_FFN_annual_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < 2022),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(year >= 2022),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = "Anomalies from predicted annual mean") +
      facet_grid(name ~ biome, scales = "free_y") +
      theme(legend.title = element_blank(),
            axis.title.y = element_blank())
  )


```


### Monthly mean trends

```{r monthly_mean_trends}

SOM_FFN_monthly %>% 
  filter(biome %in% key_biomes) %>%
  mutate(month = as.factor(month)) %>% 
  ggplot(aes(year, value, col = month)) +
  # geom_point() +
  geom_smooth(data = . %>% filter(year <= 2022,
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              se = FALSE) +
  geom_smooth(data = . %>% filter(year <= 2022,
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              se = FALSE) +
  scale_color_brewer(
    palette = "Paired",
    name = "Regression fit\n prior 2023") +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(axis.title = element_blank())

SOM_FFN_monthly_regression <-
  SOM_FFN_monthly %>%
  group_by(biome, month) %>%
  nest() %>%
  mutate(anomalies = map(.x = data, ~ anomaly_determination(.x))) %>%
  select(-data) %>%
  unnest(anomalies) %>%
  ungroup()
  

SOM_FFN_monthly_regression %>%
  filter(biome %in% key_biomes) %>%
  group_split(month) %>% 
  # head(1) %>% 
  map( 
    ~ggplot(data = .x,
            aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(year < 2022),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(year >= 2022),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to monthly means (actual - predicted)",
       subtitle = paste("Month:", .x$month)) +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title = element_blank()))


SOM_FFN_monthly_regression %>%
  filter(biome != "global") %>%
  group_split(month) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(biome, resid)) +
      geom_hline(yintercept = 0) +
      geom_jitter(
        data = . %>% filter(year < 2022),
        aes(fill = year),
        shape = 21,
        width = 0.2
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(year >= 2022),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
  labs(title = "Residual from fit to monthly means (actual - predicted)",
       subtitle = paste("Month:", .x$month)) +
      facet_grid(name ~ ., scales = "free_y") +
      theme(
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(
          angle = 90,
          vjust = 0.5,
          hjust = 1
        )
      )
  )


```


```{r anomalies_from_monthly_mean_trends_overview}


SOM_FFN_monthly_detrended <-
  full_join(SOM_FFN_monthly,
            SOM_FFN_monthly_regression %>% select(-c(value, resid, time))) %>%
  mutate(resid = value - fit)

SOM_FFN_monthly_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < 2022),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(year >= 2022),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean") +
  facet_grid(name ~ biome, scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.y = element_blank())

```


```{r anomalies_from_monthly_mean_trends_key_biomes, fig.asp=1.5}

SOM_FFN_monthly_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < 2022),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(year >= 2022),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = "Anomalies from predicted monthly mean") +
      facet_grid(name ~ biome, scales = "free_y") +
      theme(legend.title = element_blank(),
            axis.title.y = element_blank())
  )


```

# Flux anomaly correlation


The following plots aim to unravel the correlation between biome- or globally- integrated monthly flux anomalies and the corresponding anomalies of the means/integrals of each other variable.

Anomalies are first presented are first presented in absolute units. Due to the different flux magnitudes, we need to plot the globally and biome-integrated fluxes separately. Secondly, we normalize the anomalies to the monthly spread (expressed as standard deviation) of the anomalies from 1990 to 2022.

## Monthly anomalies

### Absolute

```{r anomalies_correlation_absolute, fig.asp=1.5}


SOM_FFN_monthly_detrended_anomaly <-
  SOM_FFN_monthly_detrended %>%
  select(year, month, biome, name, resid) %>%
  pivot_wider(names_from = name,
              values_from = resid)


SOM_FFN_monthly_detrended_anomaly %>%
  filter(biome == "Global") %>%
  pivot_longer(dco2:spco2)  %>%
  ggplot(aes(value, fgco2)) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(year <= 2022),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(year > 2022),
             aes(fill = as.factor(month)),
             shape = 21,
             size = 3)  +
  scale_fill_scico_d(palette = "buda",
                     guide = guide_legend(reverse = TRUE,
                                            order = 1),
                     name = "month\nof 2023") +
  labs(title = "Globally integrated fluxes") +
  facet_wrap( ~ name, ncol = 3, scales = "free_x") +
  theme(axis.title.x = element_blank())

SOM_FFN_monthly_detrended_anomaly %>%
  filter(biome != "Global") %>%
  pivot_longer(dco2:spco2) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year <= 2022),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(year > 2022),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = "month\nof 2023"
      ) +
      facet_wrap(~ biome, ncol = 3, scales = "free_x") +
      labs(title = "Biome integrated fluxes",
           x = .x$name)
  )




```

### Relative to spread

```{r anomalies_correlation_realtive_to_spread, fig.asp=2}

SOM_FFN_monthly_detrended_anomaly_spread <-
  SOM_FFN_monthly_detrended_anomaly %>%
  pivot_longer(-c(month, biome, year)) %>%
  filter(year < 2023) %>%
  group_by(month, biome, name) %>%
  summarise(spread = sd(value)) %>%
  ungroup()



SOM_FFN_monthly_detrended_anomaly_relative <-
  full_join(
    SOM_FFN_monthly_detrended_anomaly_spread,
    SOM_FFN_monthly_detrended_anomaly %>%
      pivot_longer(-c(month, biome, year))
  )

SOM_FFN_monthly_detrended_anomaly_relative <- 
SOM_FFN_monthly_detrended_anomaly_relative %>% 
  mutate(value = value / spread) %>% 
  select(-spread) %>% 
  pivot_wider() %>% 
  pivot_longer(-c(month, biome, year, fgco2))


SOM_FFN_monthly_detrended_anomaly_relative %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2)) +
      geom_vline(xintercept = 0) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year <= 2022),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(year > 2022),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = "month\nof 2023"
      ) +
      facet_wrap(~ biome, ncol = 3) +
      coord_fixed() +
      labs(x = .x$name)
  )




```


