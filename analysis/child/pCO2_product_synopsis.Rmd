---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r load_libraries_read_data, include = FALSE}

library(ggnewscale)
library(khroma)
library(scico)
library(ggtext)
library(biscale)
library(scales)
library(ggh4x)
library(cmocean)
library(patchwork)
library(kableExtra)
library(collapse)

```

# Read data

```{r read_map}

map <-
  read_rds(here::here("data/map.rds"))

key_biomes <-
  read_rds(here::here("data/key_biomes.rds"))

key_biomes <- 
key_biomes[!str_detect(key_biomes, "NP")]


biome_mask <-
  read_rds(here::here("data/biome_mask.rds"))

region_biomes <-
  read_rds(here::here("data/region_biomes.rds"))

biome_mask <-
  bind_rows(biome_mask,
            biome_mask %>%
              filter(!str_detect(biome, "SO-")) %>%
              mutate(biome = "Global"))


```

```{r core_variables_for_analysis}

name_core <- c("fgco2", "fgco2_int", "fgco2_hov",
               "sfco2", "atm_fco2", "dfco2",
               "kw_sol", "temperature", "salinity",
               "dissic", "talk", "sdissic", "stalk", "cstar", 
               "no3", "o2",
               "mld", "thetao", "so",
               "intpp", "chl",
               "sfco2_therm","sfco2_nontherm","sfco2_total",
               "resid_fgco2_dfco2", "resid_fgco2_kw_sol", "resid_fgco2_dfco2_kw_sol")


all_product_list <- c("OceanSODA",
                      "SOM_FFN",
                      "fCO2-Residual",
                      "CMEMS",
                      "ETHZ_CESM",
                      "FESOM-REcoM")

gobm_product_list <- c("ETHZ_CESM",
                       "FESOM-REcoM")


pco2_product_list <- c("OceanSODA",
                      "SOM_FFN",
                      "fCO2-Residual",
                      "CMEMS"
                      )

color_products <- c(
  "OceanSODA" = "#672933",
  "SOM_FFN" = "#d1495b",
  "fCO2-Residual" = "#edae49",
  "CMEMS" = "#AD8E55",
  "ETHZ_CESM" = "#66a182",
  "FESOM-REcoM" = "#00798c"
)

warm_color <- "#c33c57"
cold_color <- "#3f6fb3"


warm_cool_gradient <- 
rev(c(
  "#61195a",
  "#6f185f",
  "#8d1e62",
  "#aa2960",
  "#c33c57",
  "#da5351",
  "#e77155",
  "#f09264",
  "#f09264",
  "#fbd297",
  "#fefefe",
  "#c6e8ea",
  "#97d4db",
  "#79bcd0",
  "#5ca2c6",
  "#4a88bc",
  "#3f6fb3",
  "#3e56a2",
  "#3c3f82",
  "#2f2c5a",
  "#272648"
))

# cmocean("balance")(100)

```


```{r read_all_files}

files <- list.files(here::here("data/"),
                    pattern = "FESOM-REcoM")

file_types <- str_remove(files, paste0("FESOM-REcoM_",{{year_anom}},"_"))
file_types <- str_remove(file_types, ".csv")

for(i_file_type in file_types) {
  
  print(i_file_type)
  # i_file_type <- file_types[1]
  
  files <- list.files(here::here("data/"),
                      pattern = paste({{year_anom}}, i_file_type, sep = "_"),
                      full.names = TRUE)
  
  length(files)
  print(files)
  
  
  pco2_product <-
    read_csv(files, id = "product")
  
  pco2_product <-
    pco2_product %>%
    mutate(
      product = str_extract(
        product,
        "OceanSODA|SOM_FFN|CMEMS|fCO2-Residual|ETHZ_CESM|FESOM-REcoM"
      )
    )
  
  if (!str_detect(files[1], "slope")) {
    pco2_product <-
      pco2_product %>%
      mutate(
        name = factor(name, levels = name_core),
        product = factor(product, levels = all_product_list)
      ) %>%
      filter(!is.na(name))
  } else {
    pco2_product <-
      pco2_product %>%
      mutate(product = factor(product, levels = all_product_list))
  }
  
  assign(paste("pco2_product", i_file_type, sep = "_"), pco2_product)

}

```

# Define labels and breaks

```{r define_labels_and_breaks_OIA_variables_change}

labels_breaks <- function(i_name) {
  
  if (i_name == "dco2") {
    i_legend_title <- "ΔpCO<sub>2</sub><br>(µatm)"
  }
  
  if (i_name == "dfco2") {
    i_legend_title <- "ΔfCO<sub>2</sub><br>(µatm)"
  }
  
  if (i_name == "atm_co2") {
    i_legend_title <- "pCO<sub>2,atm</sub><br>(µatm)"
  }
  
  if (i_name == "atm_fco2") {
    i_legend_title <- "fCO<sub>2,atm</sub><br>(µatm)"
  }
  
  if (i_name == "sol") {
    i_legend_title <- "K<sub>0</sub><br>(mol m<sup>-3</sup> µatm<sup>-1</sup>)"
  }
  
  if (i_name == "kw") {
    i_legend_title <- "k<sub>w</sub><br>(m yr<sup>-1</sup>)"
  }
  
  if (i_name == "kw_sol") {
    i_legend_title <- "k<sub>w</sub> K<sub>0</sub><br>(mol yr<sup>-1</sup> m<sup>-2</sup> µatm<sup>-1</sup>)"
  }
  
  if (i_name == "spco2") {
    i_legend_title <- "pCO<sub>2,ocean</sub><br>(µatm)"
  }
  
  if (i_name == "sfco2") {
    i_legend_title <- "fCO<sub>2,ocean</sub><br>(µatm)"
  }
  
  if (i_name == "intpp") {
    i_legend_title <- "NPP<sub>int</sub><br>(mol s<sup>-1</sup> m<sup>-2</sup>)"
  }

  if (i_name == "no3") {
    i_legend_title <- "NO<sub>3</sub><br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "o2") {
    i_legend_title <- "O<sub>2</sub><br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "dissic") {
    i_legend_title <- "DIC<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "sdissic") {
    i_legend_title <- "sDIC<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "cstar") {
    i_legend_title <- "C*<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "talk") {
    i_legend_title <- "TA<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "stalk") {
    i_legend_title <- "sTA<br>(μmol kg<sup>-1</sup>)"
  }
  
  if (i_name == "sfco2_total") {
    i_legend_title <- "total"
  }
  
  if (i_name == "sfco2_therm") {
    i_legend_title <- "thermal"
  }
  
  if (i_name == "sfco2_nontherm") {
    i_legend_title <- "non-thermal"
  }
  
  if (i_name == "fgco2") {
    i_legend_title <- "FCO<sub>2</sub><br>(mol m<sup>-2</sup> yr<sup>-1</sup>)"
  }
  
  if (i_name == "fgco2_hov") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC deg<sup>-1</sup> yr<sup>-1</sup>)"
  }
  
  if (i_name == "fgco2_int") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC yr<sup>-1</sup>)"
  }
  
  if (i_name == "thetao") {
    i_legend_title <- "Temp.<br>(°C)"
  }
  
  if (i_name == "temperature") {
    i_legend_title <- "SST<br>(°C)"
  }
  
  if (i_name == "salinity") {
    i_legend_title <- "SSS"
  }
  
  if (i_name == "so") {
    i_legend_title <- "Salinity"
  }
  
  if (i_name == "chl") {
    i_legend_title <- "lg(Chl-a)<br>(lg(mg m<sup>-3</sup>))"
  }
  
  if (i_name == "mld") {
    i_legend_title <- "MLD<br>(m)"
  }
  
  if (i_name == "press") {
    i_legend_title <- "pressure<sub>atm</sub><br>(Pa)"
  }
  
  if (i_name == "wind") {
    i_legend_title <- "Wind <br>(m sec<sup>-1</sup>)"
  }
  
  if (i_name == "SSH") {
    i_legend_title <- "SSH <br>(m)"
  }
  
  if (i_name == "fice") {
    i_legend_title <- "Sea ice <br>(%)"
  }
  
    
  if (i_name == "resid_fgco2") {
    i_legend_title <-
      "Observed"
  }
    
  if (i_name == "resid_fgco2_dfco2") {
    i_legend_title <-
      "ΔfCO<sub>2</sub>"
  }
    
  if (i_name == "resid_fgco2_kw_sol") {
    i_legend_title <-
      "k<sub>w</sub> K<sub>0</sub>"
  }
    
  if (i_name == "resid_fgco2_dfco2_kw_sol") {
    i_legend_title <-
      "k<sub>w</sub> K<sub>0</sub> X ΔfCO<sub>2</sub>"
  }
    
  if (i_name == "resid_fgco2_sum") {
    i_legend_title <-
      "∑"
  }
    
  if (i_name == "resid_fgco2_offset") {
    i_legend_title <-
      "Obs. - ∑"
  }
  
  all_labels_breaks <- lst(i_legend_title)
  
  return(all_labels_breaks)
  
}

x_axis_labels <-
  c(
    "dco2" = labels_breaks("dco2")$i_legend_title,
    "dfco2" = labels_breaks("dfco2")$i_legend_title,
    "atm_co2" = labels_breaks("atm_co2")$i_legend_title,
    "atm_fco2" = labels_breaks("atm_fco2")$i_legend_title,
    "sol" = labels_breaks("sol")$i_legend_title,
    "kw" = labels_breaks("kw")$i_legend_title,
    "kw_sol" = labels_breaks("kw_sol")$i_legend_title,
    "intpp" = labels_breaks("intpp")$i_legend_title,
    "no3" = labels_breaks("no3")$i_legend_title,
    "o2" = labels_breaks("o2")$i_legend_title,
    "dissic" = labels_breaks("dissic")$i_legend_title,
    "sdissic" = labels_breaks("sdissic")$i_legend_title,
    "cstar" = labels_breaks("cstar")$i_legend_title,
    "talk" = labels_breaks("talk")$i_legend_title,
    "stalk" = labels_breaks("stalk")$i_legend_title,
    "spco2" = labels_breaks("spco2")$i_legend_title,
    "sfco2" = labels_breaks("sfco2")$i_legend_title,
    "sfco2_total" = labels_breaks("sfco2_total")$i_legend_title,
    "sfco2_therm" = labels_breaks("sfco2_therm")$i_legend_title,
    "sfco2_nontherm" = labels_breaks("sfco2_nontherm")$i_legend_title,
    "fgco2" = labels_breaks("fgco2")$i_legend_title,
    "fgco2_hov" = labels_breaks("fgco2_hov")$i_legend_title,
    "fgco2_int" = labels_breaks("fgco2_int")$i_legend_title,
    "thetao" = labels_breaks("thetao")$i_legend_title,
    "temperature" = labels_breaks("temperature")$i_legend_title,
    "salinity" = labels_breaks("salinity")$i_legend_title,
    "so" = labels_breaks("so")$i_legend_title,
    "chl" = labels_breaks("chl")$i_legend_title,
    "mld" = labels_breaks("mld")$i_legend_title,
    "press" = labels_breaks("press")$i_legend_title,
    "wind" = labels_breaks("wind")$i_legend_title,
    "SSH" = labels_breaks("SSH")$i_legend_title,
    "fice" = labels_breaks("fice")$i_legend_title,
    "resid_fgco2" = labels_breaks("resid_fgco2")$i_legend_title,
    "resid_fgco2_dfco2" = labels_breaks("resid_fgco2_dfco2")$i_legend_title,
    "resid_fgco2_kw_sol" = labels_breaks("resid_fgco2_kw_sol")$i_legend_title,
    "resid_fgco2_dfco2_kw_sol" = labels_breaks("resid_fgco2_dfco2_kw_sol")$i_legend_title,
    "resid_fgco2_sum" = labels_breaks("resid_fgco2_sum")$i_legend_title,
    "resid_fgco2_offset" = labels_breaks("resid_fgco2_offset")$i_legend_title
  )


```

# Functions

## Seasonality plots

```{r seasonality_plot_function}

p_season <- function(df, 
                     dim_row = "name", 
                     dim_col = "product", 
                     title = NULL, 
                     var = "resid",
                     scales = "free_y") {
  
  p <- ggplot(data = df,
              aes(month, !!ensym(var)))
  
  if(var == "resid"){
      p <- p +
        geom_hline(yintercept = 0, linewidth =0.5)
    
  }
  
  
  
  p <- p +
      geom_path(data = . %>% filter(year != {{year_anom}}),
                aes(group = as.factor(year),
                    col = as.factor(paste(min(year), max(year), sep = "-"))), 
                alpha = 0.5)+
      geom_path(data = . %>% 
                  filter(year != {{year_anom}}) %>% 
                  group_by_at(vars(month, dim_col, dim_row)) %>% 
                  summarise(!!ensym(var) := mean(!!ensym(var))),
                aes(col = "Climatological\nmean"), 
                linewidth = 1) +
    scale_color_manual(values = c("grey", "black"),
                       guide = guide_legend(order = 2,
                                            reverse = TRUE)) +
    new_scale_color()+
    geom_path(data = . %>% filter(year == {{year_anom}}),
                aes(col = as.factor(year)),
                linewidth = 1) +
      scale_color_manual(
        values = warm_color,
        guide = guide_legend(order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = title,
           x = "Month")
  
    if(df %>% filter(name == "fgco2") %>% nrow() > 0 & "value" %in% names(df)){
    
    df_sink <- df %>% 
      filter(year == {{year_anom}},
             name == "fgco2")
    
      p <- p +
          geom_point(data = df_sink %>% filter(value < 0),
             aes(shape = "Sink"), fill = "white") +
          geom_point(data = df_sink %>% filter(value >= 0),
             aes(shape = "Source"), fill = "white") +
        scale_shape_manual(values = c(25,24))
    
  }
  
  
  if (!(is.null(dim_col))) {
    p <- p +
      facet_grid(
        as.formula(paste(dim_row, "~", dim_col)),
        scales = scales,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      )
    
    
  } else {
    p <- p +
      facet_grid(
        as.formula(paste(dim_row, "~ .")),
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      )
  }
  
  p <- p +
    theme(
      strip.text.y.left = element_markdown(),
      strip.placement = "outside",
      strip.background.y = element_blank(),
      axis.title.y = element_blank(),
      legend.title = element_blank()
    )
  
  p
  
}
```

## fCO2 decomposition

```{r fCO2_decomposition_function, eval=FALSE}

fco2_decomposition <- function(df, ...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat, month)
  # group_by <- quos(biome, year, month)
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    df %>%
    filter(name %in% c("temperature", "sfco2"))
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    inner_join(
      pco2_product_biome_monthly_fCO2_decomposition %>%
        filter(name == "temperature") %>%
        select(-c(value, fit)) %>%
        pivot_wider(values_from = resid),
      pco2_product_biome_monthly_fCO2_decomposition %>%
        filter(name == "sfco2") %>%
        select(-c(value, resid)) %>%
        pivot_wider(values_from = fit)
    )
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    mutate(sfco2_therm = (sfco2 * exp(0.0423 * temperature)) - sfco2)
  
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    inner_join(
      pco2_product_biome_monthly_fCO2_decomposition,
      df %>%
        filter(name %in% c("sfco2")) %>%
        select(-c(value, fit, name)) %>%
        rename(sfco2_total = resid)
    )
  
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    mutate(sfco2_nontherm = sfco2_total - sfco2_therm)
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    select(-c(temperature, sfco2)) %>%
    pivot_longer(starts_with("sfco2"),
                 values_to = "resid")
  
}


```

## Flux attribution

```{r flux_attribution_function, eval=FALSE}

flux_attribution <- function(df, ...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat, month)
  
  pco2_product_flux_attribution <-
    df %>%
    filter(name %in% c("dfco2", "kw_sol", "fgco2"))
  
  
  pco2_product_flux_attribution <-
    inner_join(
      pco2_product_flux_attribution %>%
        select(-c(value, fit)) %>%
        pivot_wider(values_from = resid,
                    names_prefix = "resid_"),
      pco2_product_flux_attribution %>%
        select(-c(value, resid)) %>%
        filter(name != "fgco2") %>%
        pivot_wider(values_from = fit)
    )
  
    pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    mutate(
      resid_fgco2_dfco2 = resid_dfco2 * kw_sol,
      resid_fgco2_kw_sol = resid_kw_sol * dfco2,
      resid_fgco2_dfco2_kw_sol = resid_dfco2 * resid_kw_sol
      # resid_fgco2_sum = resid_fgco2_dfco2 + resid_fgco2_kw_sol + resid_fgco2_dfco2_kw_sol
    )
  
  # pco2_product_flux_attribution <-
  #   pco2_product_flux_attribution %>%
  #   mutate(resid_fgco2_offset = resid_fgco2 - resid_fgco2_sum)
  
  pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    select(product, !!!group_by, starts_with("resid_fgco2")) %>%
    pivot_longer(starts_with("resid_"),
                 values_to = "resid")
  
  
  pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    filter(str_detect(name, "dfco2|kw_sol")) %>% 
    mutate(name = factor(
      name,
      levels = c(
        "resid_fgco2",
        "resid_fgco2_dfco2",
        "resid_fgco2_kw_sol",
        "resid_fgco2_dfco2_kw_sol",
        "resid_fgco2_sum",
        "resid_fgco2_offset"
      )
    ))
  
}

```

# Maps

The following maps show the anomalies of each variable in `r {{year_anom}}` as provided through the pCO2 product. Anomalies are determined based on the predicted value of a linear regression model fit to the available data from 1990 to `r {{year_anom}}-1`.

Maps are first presented as annual means, and than as monthly means. Note that the 2023 predictions for the monthly maps are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

Note: The increase the computational speed, I regridded all maps to 5X5° grid.

## Annual means

### `r {{year_anom}}` anomaly

```{r anomaly_year_annual_mean_maps, fig.asp=1}

pco2_product_map_annual_anomaly %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      # labs(title =  paste({{year_anom}}, "anomaly")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      facet_wrap( ~ product, ncol = 2) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


```

```{r anomaly_year_annual_mean_maps_cesm}

plot_list <- 
pco2_product_map_annual_anomaly %>%
  filter(year == {{year_anom}},
         product == "ETHZ_CESM",
         name %in% c(
           "fgco2",
           "dfco2",
           "kw_sol",
           "temperature",
           "salinity",
           "sdissic",
           "stalk",
           "no3",
           "mld",
           "intpp",
           "chl"
         )) %>%
  group_split(name) %>% 
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(),
            legend.justification = "left")
  )


ggsave(plot = wrap_plots(plot_list,
                         ncol = 3,
                         byrow = FALSE),
       width = 20,
       height = 9,
       filename = "../output/CESM_2023_surface_anomaly_maps.jpg")

```

```{r anomaly_year_annual_mean_maps_fesom}

plot_list <- 
pco2_product_map_annual_anomaly %>%
  filter(year == {{year_anom}},
         product == "FESOM-REcoM",
         name %in% c(
           "fgco2",
           "dfco2",
           "kw_sol",
           "temperature",
           "salinity",
           "dissic",
           "talk",
           "no3",
           "mld",
           "intpp",
           "chl"
         )) %>%
  group_split(name) %>% 
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(),
            legend.justification = "left")
  )


ggsave(plot = wrap_plots(plot_list,
                         ncol = 3,
                         byrow = FALSE),
       width = 20,
       height = 9,
       filename = "../output/FESOM_2023_surface_anomaly_maps.jpg")

rm(plot_list)

```

```{r anomaly_annual_mean_maps_ensemble_mean}

pco2_product_map_annual_anomaly_ensemble <-
  pco2_product_map_annual_anomaly %>% 
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  fgroup_by(name, lon, lat) %>%
  fsummarise(
    resid_sd = fsd(resid),
    resid_mean = fmean(resid),
    value_sd = fsd(value),
    value_mean = fmean(value),
    n = fnobs(resid)
  ) %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n)

pco2_product_map_annual_anomaly_ensemble_coarse <-
  m_grid_horizontal_coarse(pco2_product_map_annual_anomaly_ensemble) %>%
  fgroup_by(name, lon_grid, lat_grid) %>%
  fsummarise(
    resid_sd_coarse = fmean(resid_sd, na.rm = TRUE),
    resid_mean_coarse = fmean(resid_mean, na.rm = TRUE),
    value_sd_coarse = fmean(value_sd, na.rm = TRUE),
    value_mean_coarse = fmean(value_mean, na.rm = TRUE)
  ) %>% 
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_map_annual_anomaly_ensemble <-
  left_join(
    pco2_product_map_annual_anomaly_ensemble,
    pco2_product_map_annual_anomaly_ensemble_coarse
  )

pco2_product_map_annual_anomaly_ensemble %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>%
                   drop_na() %>%
                   filter(abs(resid_mean_coarse) < resid_sd_coarse),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey80", size = 1) +
      labs(title =  paste({{year_anom}}, "pCO2 product ensemble mean anomaly")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "") +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

rm(pco2_product_map_annual_anomaly_ensemble_coarse)

pco2_product_map_annual_anomaly_ensemble %>%
  mutate(product = "Ensemble mean") %>% 
  filter(name == "fgco2") %>% 
  group_split(name) %>%
  head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value_mean)) +
      geom_point(data = .x %>%
                   drop_na() %>%
                   filter(abs(value_mean_coarse) < value_sd_coarse),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey80", size = 1) +
      labs(title =  paste({{year_anom}}, "pCO2 product ensemble mean absolute")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$value_mean, .01), quantile(.x$value_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "") +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

```

```{r anomaly_annual_mean_maps_ensemble_mean_offset, fig.asp=1.5}

pco2_product_map_annual_anomaly_ensemble_offset <-
left_join(
    pco2_product_map_annual_anomaly_ensemble,
    pco2_product_map_annual_anomaly %>% 
      filter(year == {{year_anom}},
             product %in% pco2_product_list)
  ) %>%
  mutate(`Anomaly offset` = resid - resid_mean) %>% 
  select(name, lon, lat, product, `Anomaly offset`)

pco2_product_map_annual_anomaly_ensemble_baseline <-
  pco2_product_map_annual_anomaly %>% 
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    fit_mean = mean(fit),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n)

pco2_product_map_annual_anomaly_ensemble_baseline <-
left_join(
    pco2_product_map_annual_anomaly_ensemble_baseline,
    pco2_product_map_annual_anomaly %>% 
      filter(year == {{year_anom}},
             product %in% pco2_product_list)
  ) %>%
  mutate(`Baseline offset` = fit - fit_mean) %>% 
  select(name, lon, lat, product, `Baseline offset`)

full_join(
  pco2_product_map_annual_anomaly_ensemble_offset,
  pco2_product_map_annual_anomaly_ensemble_baseline
) %>%
  pivot_longer(contains("offset"),
               names_to = "offset") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title =  paste({{year_anom}}, "offset from ensemble mean")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$value, .01), quantile(.x$value, .99)),
        oob = squish
      ) +
      facet_grid(product ~ offset) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(), legend.position = "top")
  )

rm(pco2_product_map_annual_anomaly_ensemble_offset,
   pco2_product_map_annual_anomaly_ensemble_baseline)

gc()

```



```{r anomaly_annual_mean_maps_ensemble_mean_gobm, fig.asp=0.5}

pco2_product_map_annual_anomaly_ensemble_gobm <-
  pco2_product_map_annual_anomaly %>% 
  filter(year == {{year_anom}},
         product %in% gobm_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_range = max(resid) - min(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(gobm_product_list)) %>% 
  select(-n)

pco2_product_map_annual_anomaly_ensemble_gobm %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      labs(title =  paste({{year_anom}}, "GOBM ensemble mean anomaly")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "") +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


plot_list <- 
pco2_product_map_annual_anomaly_ensemble_gobm %>%
  # mutate(product = "Ensemble mean") %>% 
  filter(name %in% c(
           "fgco2",
           # "dfco2",
           # "kw_sol",
           "temperature",
           # "salinity",
           "sdissic",
           # "talk",
           # "no3",
           "mld",
           "intpp",
           "chl"
         )) %>%
  group_split(name) %>% 
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(),
            legend.justification = "left")
  )


ggsave(plot = wrap_plots(plot_list,
                         ncol = 2,
                         byrow = FALSE),
       width = 12,
       height = 6,
       filename = "../output/GOBM_2023_surface_anomaly_maps.jpg")

rm(plot_list,
   pco2_product_map_annual_anomaly_ensemble_gobm)

gc()

```


```{r bivariate_anomaly_year_annual_mean_maps}

bivariate_map <-
  pco2_product_map_annual_anomaly %>%
  filter(year == {{year_anom}}, name %in% c("fgco2", "temperature")) %>%
  select(product, name, lon, lat, resid) %>%
  pivot_wider(names_from = name, values_from = resid) %>%
  drop_na()

dim_set <- 3

bivariate_map <-
  bi_class(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile"
  )

bi_breaks <-
  bi_class_breaks(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile",
    dig_lab = 1
  )

map +
  geom_tile(data = bivariate_map, aes(lon, lat, fill = bi_class)) +
  bi_scale_fill(pal = "BlueGold", dim = dim_set) +
  theme(legend.position = "none") +
  facet_wrap( ~ product, ncol = 2)

ggsave(
  width = 6,
  height = 5,
  dpi = 600,
  filename = "../output/sst_fco2_bivariate_map_products.jpg"
)

bi_legend(
  pal = "BlueGold",
  xlab = labels_breaks("temperature")$i_legend_title,
  ylab = labels_breaks("fgco2")$i_legend_title,
  dim = dim_set,
  pad_width = 2,
  breaks = bi_breaks,
  arrows = FALSE
) +
  theme(
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    axis.ticks = element_blank(),
    axis.text = element_text(size = 10)
  )


ggsave(
  width = 4,
  height = 3,
  dpi = 600,
  filename = "../output/sst_fco2_bivariate_map_products_legend.jpg"
)

```

```{r bivariate_anomaly_year_annual_mean_maps_ensemble_mean}

bivariate_map <- 
pco2_product_map_annual_anomaly_ensemble %>%
  filter(name %in% c("fgco2", "temperature")) %>%
  select(name, lon, lat, resid_mean) %>% 
  pivot_wider(names_from = name,
              values_from = resid_mean) %>% 
  drop_na()


dim_set <- 3

bivariate_map <-
  bi_class(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile"
  )

bi_breaks <-
  bi_class_breaks(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile",
    dig_lab = 1
  )

map +
  geom_tile(data = bivariate_map,
            aes(lon, lat, fill = bi_class)) +
  bi_scale_fill(pal = "BlueGold", dim = dim_set) +
  theme(legend.position = "none")


bivariate_map_raster <-
bivariate_map %>%
    relocate(lon, lat) %>%
    select(lon, lat, bi_class) %>%
    mutate(bi_class_numeric = as.character(as.numeric(as.factor(bi_class))))


bivariate_map_raster_values <- 
bivariate_map_raster %>% 
  distinct(bi_class, bi_class_numeric)

bivariate_map_raster <- rast(
  bivariate_map_raster %>%
    select(-bi_class),
    crs = "+proj=longlat"
)


bivariate_map_raster <- project(bivariate_map_raster, target_crs, method = "near")

bivariate_map_tibble <- bivariate_map_raster %>%
  as.data.frame(xy = TRUE, na.rm = FALSE) %>%
  as_tibble() %>%
  rename(lon = x, lat = y) %>%
  drop_na()

bivariate_map_tibble <-
  right_join(
    bivariate_map_tibble,
    bivariate_map_raster_values %>%
      mutate(bi_class_numeric = as.numeric(bi_class_numeric))
  )


ggplot() +
  geom_raster(data = bivariate_map_tibble,
            aes(x = lon, y = lat, fill = bi_class)) +
  bi_scale_fill(pal = "BlueGold", dim = dim_set) +
  geom_sf(data = worldmap_trans, fill = "grey90", col = "grey90") +
  geom_sf(data = coastline_trans, linewidth = 0.3) +
  geom_sf(data = bbox_graticules_trans, linewidth = 0.5) +
  coord_sf(
    crs = target_crs,
    ylim = lat_lim,
    xlim = lon_lim,
    expand = FALSE
  ) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_rect(colour = "transparent"),
    strip.background = element_blank(),
    legend.position = "none"
  )

ggsave(width = 5,
       height = 2.5,
       dpi = 600,
       filename = "../output/sst_fco2_bivariate_map_ensemble.jpg")

bi_legend(
  pal = "BlueGold",
  xlab = labels_breaks("temperature")$i_legend_title,
  ylab = labels_breaks("fgco2")$i_legend_title,
  dim = dim_set,
  pad_width = 2,
  breaks = bi_breaks,
  arrows = FALSE
) +
  theme(
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    axis.ticks = element_blank(),
    axis.text = element_text(size = 10)
  )

ggsave(width = 4,
       height = 3,
       dpi = 600,
       filename = "../output/sst_fco2_bivariate_map_ensemble_legend.jpg")


```


```{r anomaly_correlation_map}

map +
  geom_tile(data = pco2_product_map_annual_slope, aes(lon, lat, fill = slope)) +
  scale_fill_gradientn(
    colours = warm_cool_gradient,
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    limits = c(
      quantile(pco2_product_map_annual_slope$slope, .01),
      quantile(pco2_product_map_annual_slope$slope, .99)
    ),
    oob = squish
  ) +
  facet_wrap( ~ product) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(), legend.position = "top") +
  labs(title = "Correlation of historic annual flux and SST anomalies")

pco2_product_map_annual_slope_ensemble <-
  pco2_product_map_annual_slope %>% 
  filter(product %in% pco2_product_list) %>%
  fgroup_by(lon, lat) %>%
  fsummarise(
    slope_sd = fsd(slope),
    slope_mean = fmean(slope),
    n = fnobs(slope)
  ) %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n)

pco2_product_map_annual_slope_ensemble_coarse <-
  m_grid_horizontal_coarse(pco2_product_map_annual_slope_ensemble) %>%
  fgroup_by(lon_grid, lat_grid) %>%
  fsummarise(
    slope_sd_coarse = fmean(slope_sd, na.rm = TRUE),
    slope_mean_coarse = fmean(slope_mean, na.rm = TRUE)
  ) %>% 
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_map_annual_slope_ensemble <-
  left_join(
    pco2_product_map_annual_slope_ensemble,
    pco2_product_map_annual_slope_ensemble_coarse
  )


map +
  geom_tile(data = pco2_product_map_annual_slope_ensemble, 
            aes(lon, lat, fill = slope_mean)) +
  geom_point(
    data = pco2_product_map_annual_slope_ensemble %>%
      filter(abs(slope_mean_coarse) < slope_sd_coarse),
    aes(lon, lat, shape = "Ensemble mean\n< StDev"),
    col = "grey80",
    size = 1
  )+
  scale_fill_gradientn(
    colours = warm_cool_gradient,
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    limits = c(
      quantile(pco2_product_map_annual_slope$slope,.01),
      quantile(pco2_product_map_annual_slope$slope, .99)),
    oob = squish,
    name = paste0("Slope<br><br>",
                  labels_breaks("fgco2"),
                  " / <br><br>",
                  labels_breaks("temperature"))
  ) +
  scale_shape(name = "") +
  labs(title = "Correlation of historic annual flux and SST anomalies", 
       subtitle = "pCO2 product ensemble mean") +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(), 
        legend.position = "top")

ggsave(width = 8,
       height = 6,
       dpi = 600,
       filename = "../output/sst_fco2_annual_corrlation_map_ensemble.jpg")


```




## Monthly means

### `r {{year_anom}}` anomaly

```{r anomaly_2023_monthly_mean_maps, fig.asp=1.5}

pco2_product_map_monthly_anomaly %>%
  filter(name %in% name_core,
         year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      facet_grid(month ~ product) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

```

```{r anomaly_2023_monthly_mean_maps_ensemble, fig.asp=1}

pco2_product_map_monthly_anomaly_ensemble <-
  pco2_product_map_monthly_anomaly %>%
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  fgroup_by(name, lon, lat, month) %>%
  fsummarise(
    resid_sd = fsd(resid),
    resid_mean = fmean(resid),
    n = fnobs(resid)
  ) %>%
  filter(n == length(pco2_product_list)) %>%
  select(-n)

pco2_product_map_monthly_anomaly_ensemble_coarse <-
  m_grid_horizontal_coarse(pco2_product_map_monthly_anomaly_ensemble) %>%
  fgroup_by(name, month, lon_grid, lat_grid) %>%
  fsummarise(resid_sd_coarse = fmean(resid_sd, na.rm = TRUE),
             resid_mean_coarse = fmean(resid_mean, na.rm = TRUE)) %>%
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_map_monthly_anomaly_ensemble <-
  left_join(
    pco2_product_map_monthly_anomaly_ensemble,
    pco2_product_map_monthly_anomaly_ensemble_coarse
  )


pco2_product_map_monthly_anomaly_ensemble %>%
  filter(name %in% name_core) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      labs(title =  paste({{year_anom}}, "pCO2 product ensemble mean monthly anomaly")) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      facet_wrap(~ month, ncol = 3) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

rm(
  pco2_product_map_monthly_anomaly_ensemble,
  pco2_product_map_monthly_anomaly_ensemble_coarse
)

gc()

```

### fCO2 decomposition

```{r fCO2_decomposition_monthly_maps, fig.asp=1.8}

# pco2_product_map_monthly_fCO2_decomposition <-
#   fco2_decomposition(pco2_product_map_monthly_anomaly,
#                      year, month, lon, lat)


pco2_product_map_monthly_fCO2_decomposition %>%
  filter(year == {{year_anom}}) %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(title = .x$product) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

pco2_product_map_monthly_fCO2_decomposition %>%
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat, month) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      # geom_point(
      #   data = .x %>% filter(abs(resid_mean) < resid_sd),
      #   aes(lon, lat, shape = "Ensemble mean\n< StDev"),
      #   col = "grey"
      # ) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),,
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 46, name = "") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

```

```{r fCO2_decomposition_annual_maps, fig.asp=1.5}

pco2_product_map_annual_fCO2_decomposition <-
  pco2_product_map_monthly_fCO2_decomposition %>% 
  select(product, year, lat, lon, name, resid) %>% 
  fgroup_by(product, year, lat, lon, name) %>% 
  fmean()

gc()

map +
  geom_tile(data = pco2_product_map_annual_fCO2_decomposition %>% 
              filter(year == {{year_anom}}),
            aes(lon, lat, fill = resid)) +
  scale_fill_gradientn(
    colours = warm_cool_gradient,
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("sfco2"),
    limits = c(quantile(pco2_product_map_annual_fCO2_decomposition$resid, .01), 
               quantile(pco2_product_map_annual_fCO2_decomposition$resid, .99)),
    oob = squish
  ) +
  facet_grid(product ~ name,
             labeller = labeller(name = x_axis_labels)) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "top")



pco2_product_map_annual_fCO2_decomposition_ensemble <-
  pco2_product_map_annual_fCO2_decomposition %>%
  filter(product %in% pco2_product_list, year == {{year_anom}}) %>%
  group_by(name, lon, lat) %>%
  summarize(resid_sd = sd(resid),
            resid_mean = mean(resid),
            n = n()) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>%
  select(-n)


pco2_product_map_annual_fCO2_decomposition_ensemble_coarse <-
  m_grid_horizontal_coarse(pco2_product_map_annual_fCO2_decomposition_ensemble) %>%
  fgroup_by(name, lon_grid, lat_grid) %>%
  fsummarise(resid_sd_coarse = fmean(resid_sd, na.rm = TRUE),
             resid_mean_coarse = fmean(resid_mean, na.rm = TRUE)) %>%
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_map_annual_fCO2_decomposition_ensemble <-
  left_join(
    pco2_product_map_annual_fCO2_decomposition_ensemble,
    pco2_product_map_annual_fCO2_decomposition_ensemble_coarse
  )
  
  
pco2_product_map_annual_fCO2_decomposition_ensemble %>% 
  mutate(product = "Ensemble mean") %>% 
  group_split(product) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>%
                   drop_na() %>%
                   filter(abs(resid_mean_coarse) < resid_sd_coarse),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey80", size = 1) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "")+
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_wrap(~ name,
                 labeller = labeller(name = x_axis_labels),
                 ncol = 1) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

ggsave(width = 6,
       height = 9,
       dpi = 600,
       filename = "../output/fco2_decomposition_ensemble_mean.jpg")

```

### Flux attribution

```{r flux_attribution_seasonal_maps, fig.asp=1.8}

# pco2_product_map_monthly_flux_attribution <-
#   flux_attribution(pco2_product_map_monthly_anomaly,
#                    year, month, lon, lat)

pco2_product_map_monthly_flux_attribution %>%
  filter(year == {{year_anom}}) %>% 
  drop_na() %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(subtitle = .x$product) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(), 
            legend.position = "bottom") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top",
            strip.text.x.top = element_markdown())
  )



pco2_product_map_monthly_flux_attribution %>%
  filter(year == {{year_anom}}) %>% 
  drop_na() %>% 
  filter(product %in% pco2_product_list) %>%
  group_by(name, lon, lat, month) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  drop_na() %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      # geom_point(data = .x %>% filter(abs(resid_mean) < resid_sd),
      #            aes(lon, lat, shape = "Ensemble mean\n< StDev"))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      )+
      scale_shape_manual(values = 46, name = "") +
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.title = element_markdown(),
        legend.position = "top",
        strip.text.x.top = element_markdown()
      )
  )



```

```{r flux_attribution_annual_maps, fig.asp=1.8}

pco2_product_map_annual_flux_attribution <-
  pco2_product_map_monthly_flux_attribution %>% 
  group_by(product, year, lat, lon, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup()

map +
  geom_tile(data = pco2_product_map_annual_flux_attribution %>% 
              filter(year == {{year_anom}}),
            aes(lon, lat, fill = resid)) +
  scale_fill_gradientn(
    colours = warm_cool_gradient,
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("fgco2"),
    limits = c(quantile(pco2_product_map_annual_flux_attribution$resid, .01, na.rm = TRUE), 
               quantile(pco2_product_map_annual_flux_attribution$resid, .99, na.rm = TRUE)),
    oob = squish
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "bottom") +
  facet_grid(product ~ name,
             labeller = labeller(name = x_axis_labels)) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(
    legend.title = element_markdown(),
    legend.position = "top",
    strip.text.x.top = element_markdown()
  )

pco2_product_map_annual_flux_attribution_ensemble <-
pco2_product_map_annual_flux_attribution %>%
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  drop_na()

pco2_product_map_annual_flux_attribution_ensemble_coarse <-
  m_grid_horizontal_coarse(pco2_product_map_annual_flux_attribution_ensemble) %>%
  fgroup_by(name, lon_grid, lat_grid) %>%
  fsummarise(resid_sd_coarse = fmean(resid_sd, na.rm = TRUE),
             resid_mean_coarse = fmean(resid_mean, na.rm = TRUE)) %>%
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_map_annual_flux_attribution_ensemble <-
  left_join(
    pco2_product_map_annual_flux_attribution_ensemble,
    pco2_product_map_annual_flux_attribution_ensemble_coarse
  )
  
pco2_product_map_annual_flux_attribution_ensemble %>% 
  mutate(product = "Ensemble mean") %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>%
                   drop_na() %>%
                   filter(abs(resid_mean_coarse) < resid_sd_coarse),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey80", size = 1) +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      )+
      scale_shape_manual(values = 20, name = "") +
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_wrap(~ name,
                 labeller = labeller(name = x_axis_labels),
                 ncol = 1) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.title = element_markdown(),
        legend.position = "top",
        strip.text.x.top = element_markdown()
      )
  )

ggsave(width = 6,
       height = 9,
       dpi = 600,
       filename = "../output/flux_attribution_ensemble_mean.jpg")

gc()

```

# Hovmoeller plots

The following Hovmoeller plots show the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Hovmoeller plots are presented as monthly means. Note that the predictions for the monthly Hovmoeller plots are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

## Monthly means

### Anomalies

```{r hovmoeller_monthly_anomalies, fig.asp=1.2}

pco2_product_hovmoeller_monthly_anomaly %>%
  filter(name %in% name_core) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid,.01),quantile(.x$resid,.99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap(~ product, ncol = 1)
  )



```

```{r hovmoeller_monthly_anomalies_ensemble_mean, fig.asp=0.4}


pco2_product_hovmoeller_monthly_anomaly_ensemble <-
  pco2_product_hovmoeller_monthly_anomaly %>% 
  group_by(name, decimal, lat) %>%
  summarize(
    resid_range = max(resid) - min(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n > 1)
  

pco2_product_hovmoeller_monthly_anomaly_ensemble %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid_mean)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap( ~ product, ncol = 1)
  )


```

```{r hovmoeller_monthly_anomalies_ensemble_mean_offset, fig.asp=0.8}


left_join(
    pco2_product_hovmoeller_monthly_anomaly_ensemble,
    pco2_product_hovmoeller_monthly_anomaly
  ) %>%
  mutate(resid_offset = resid - resid_mean) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid_offset)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0)+
      labs(title = "Monthly offset from ensemble mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap( ~ product, ncol = 1)
  )




```

# Regional means and integrals

The following plots show biome-, super biome- or global- averaged/integrated values of each variable as provided through the pCO2 product, represented here as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Anomalies are presented relative to the predicted annual mean of each year, hence preserving the seasonality.

## Annual anomalies

```{r absolute_integrals_trends, fig.asp=1}

pco2_product_biome_annual_anomaly_ensemble <-
  pco2_product_biome_annual_anomaly %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, name, biome) %>%
  summarise(resid_sd = sd(resid),
            resid = mean(resid),
            value = mean(value),
            fit = mean(fit)) %>%
  ungroup()


pco2_product_biome_annual_anomaly_ensemble_clim_anom <- 
pco2_product_biome_annual_anomaly_ensemble %>% 
  mutate(year = if_else(year == 2023, "value", "clim")) %>% 
  select(year, name, biome, value) %>% 
  group_by(year, name, biome) %>% 
  fmean() %>% 
  pivot_wider(names_from = year) %>% 
  mutate(anom = value - clim)

pco2_product_biome_annual_anomaly_ensemble_clim_anom %>% 
  filter(biome %in% c("Global", key_biomes)) %>% 
  ggplot(aes(biome, anom)) +
  geom_col() +
  facet_wrap(~ name, scales = "free_y")
  
pco2_product_biome_annual_anomaly_ensemble_clim_anom %>% 
  filter(biome == "Global",
         name == "temperature")

rm(pco2_product_biome_annual_anomaly_ensemble_clim_anom)

full_join(
  pco2_product_biome_annual_anomaly_ensemble %>%
    filter(biome == "Global",
           year == {{year_anom}}),
  pco2_product_biome_annual_anomaly_ensemble %>%
    filter(biome == "Global",
           year != {{year_anom}}) %>%
    group_by(name, biome) %>%
    summarise(resid_sd_historic = sd(resid)) %>%
    ungroup()
) %>% 
  mutate(resid_vs_historic_sd = resid / resid_sd_historic)

(exp(0.0423*0.204)-1)*404

pco2_product_biome_annual_anomaly_ensemble %>%
  filter(biome == "Global") %>% 
  select(year, name, resid) %>% 
  pivot_wider(values_from = resid) %>% 
  arrange(desc(temperature))

lm_fgco2_sst <- pco2_product_biome_annual_anomaly_ensemble %>%
  filter(name %in% c("fgco2_int", "temperature"), 
         biome == "Global",
         year != {{year_anom}}) %>%
  select(year, name, resid) %>% 
  pivot_wider(values_from = resid) %>% 
  lm(data = .,
     fgco2_int ~ temperature)

eq <- substitute(
  italic(y) == a + b %.% italic(x) * "," ~  ~ italic(r) ^ 2 ~ "=" ~ r2,
  list(
    a = format(unname(coef(lm_fgco2_sst)[1]), digits = 2),
    b = format(unname(coef(lm_fgco2_sst)[2]), digits = 2),
    r2 = format(summary(lm_fgco2_sst)$r.squared, digits = 3)
  )
)
eq <- as.character(as.expression(eq))

pco2_product_biome_annual_anomaly_ensemble_lm_fgco2_sst <-
pco2_product_biome_annual_anomaly_ensemble %>%
    filter(
      name %in% c("fgco2_int", "temperature"),
      biome == "Global"
    ) %>%
    select(year, name, resid) %>%
    pivot_wider(values_from = resid) %>% 
    select(year, temperature) %>% 
    mutate(fgco2_predict = predict(lm_fgco2_sst, pick(temperature)))

pco2_product_biome_annual_anomaly_ensemble_lm_fgco2_sst <-
  full_join(
    pco2_product_biome_annual_anomaly_ensemble_lm_fgco2_sst %>% 
      select(-temperature),
    pco2_product_biome_annual_anomaly_ensemble %>%
      filter(name %in% c("fgco2_int"), biome == "Global") %>%
      select(year, name, fit)
  ) %>% 
  mutate(fgco2_predict = fgco2_predict + fit) %>% 
  select(-fit)


bind_rows(
  pco2_product_biome_annual_anomaly_ensemble,
  pco2_product_biome_annual_anomaly_ensemble %>%
    filter(year == max(year)) %>%
    mutate(year = year + 1) %>%
    select(-c(resid, resid_sd))
) %>%
  filter(name %in% c("fgco2_int", "temperature"),
         biome == "Global") %>%
  mutate(name = fct_rev(as.factor(name))) %>% 
  ggplot() +
  geom_path(
    data = pco2_product_biome_monthly_anomaly %>%
      filter(
        product %in% pco2_product_list,
        name %in% c("fgco2_int", "temperature"),
        biome == "Global"
      ) %>%
      group_by(year, month, name, biome) %>%
      summarise(value = mean(value)) %>%
      ungroup(),
    aes(year + month / 12, value),
    col = "grey90"
  ) +
  geom_linerange(
    data = pco2_product_biome_annual_anomaly_ensemble_lm_fgco2_sst %>%
      filter(year %in% c(2023)),
    aes(xmin = year, xmax = year + 1, y = fgco2_predict),
    col = cold_color
  ) +
  # geom_text(x = 1995, y = -1.5, label = eq, parse = TRUE) +
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  geom_step(aes(year, value, col = "Observed")) +
  geom_linerange(aes(
    x = year + 0.5,
    ymin = value - resid_sd,
    ymax = value + resid_sd,
    linetype = "Product SD"
  )) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  scale_linetype(name = "Anomaly uncertainty")+
  guides(
    color = guide_legend(order = 1),
    fill = guide_legend(order = 2),
    linetype = guide_legend(order = 3)
  ) +
  scale_x_continuous(limits = c(1989.5, 2024.8), expand = c(0, 0))+
  facet_grid(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  labs(x = "Year") +
  theme(
    axis.title.y = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

ggsave(width = 6,
       height = 5,
       dpi = 600,
       filename = "../output/timeseries_ensemble_mean_wide.jpg")

bind_rows(
  pco2_product_biome_annual_anomaly,
  pco2_product_biome_annual_anomaly %>%
    filter(year == max(year)) %>%
    mutate(year = year + 1) %>% 
    select(-c(resid))
) %>% 
  filter(name %in% c("fgco2_int", "temperature"),
         biome == "Global") %>%
  ggplot() +
  geom_path(
    data = pco2_product_biome_monthly_anomaly %>%
      filter(name %in% c("fgco2_int", "temperature"),
             biome == "Global"),
    aes(year + month / 12, value),
    col = "grey90"
  )+
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  geom_step(aes(year, value, col = "Observed")) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  guides(
    color = guide_legend(order = 1),
    fill = guide_legend(order = 2)
  ) +
  scale_x_continuous(limits = c(1989.5,2024.5), expand = c(0,0),
                     breaks = c(1990,2010)) +
  facet_grid(
    name ~ product,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    axis.title = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

ggsave(width = 8,
       height = 4,
       dpi = 600,
       filename = "../output/timeseries_products.jpg")


bind_rows(
  pco2_product_biome_monthly_anomaly,
  pco2_product_biome_monthly_anomaly %>%
    filter(year == max(year),
           month == 12) %>%
    mutate(month = month + 1)
) %>%
  mutate(year = year + month/12) %>% 
  filter(name %in% c("fgco2_int", "temperature"),
         product == "OceanSODA",
         biome == "Global",
         year >= 2010) %>%
  ggplot() +
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1/12,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  guides(color = guide_legend(order = 1),
         fill = guide_legend(order = 2))+
  facet_grid(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  coord_cartesian(expand = 0) +
  theme(
    axis.title = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

         
```

```{r absolute_integrals}

pco2_product_biome_annual_anomaly %>%
  filter(year == {{year_anom}},
         name %in% c("fgco2", "fgco2_int", "dfco2",
                     "kw_sol", "temperature",
                     "no3", "mld", "intpp", "chl")) %>%
  mutate(region = case_when(biome == "Global" ~ "Global",
                            # biome %in% super_biomes ~ "Super biomes",
                            TRUE ~ "Biomes"),
         region = factor(region, levels = c("Global", "Biomes"))) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes(biome, value, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(biome, fit, group = product, col = paste0({{year_anom}},"\nlinear\nprediction")),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Absolute") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
            axis.title.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  
```

```{r absolute_anomaly_integrals}

full_join(
  pco2_product_biome_annual_anomaly %>%
    filter(year != {{year_anom}},
           name %in% name_core) %>%
    group_by(product, name, biome) %>% 
    summarise(resid_sd = sd(resid)) %>% 
    ungroup(),
  pco2_product_biome_annual_anomaly %>%
    filter(year == {{year_anom}},
           name %in% name_core)) %>%
  mutate(
    region = case_when(
      biome == "Global" ~ "Global",
      TRUE ~ "Biomes"
    ),
    region = factor(region, levels = c("Global", "Biomes"))
  ) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes(biome, value - fit, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(biome, resid_sd * sign(value - fit), 
                   group = product, col = paste0("Anomaly SD\nexcl.",{{year_anom}})),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Anomalies") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
            axis.title.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  


```

```{r absolute_anomaly_integrals_merged}

pco2_product_biome_annual_anomaly_merged <-
full_join(region_biomes,
          pco2_product_biome_annual_anomaly) %>%
  mutate(region = case_when(biome == "Global" ~ "Global",
                            region == "atlantic" ~ "Atlantic",
                            region == "pacific" ~ "Pacific",
                            region == "indian" ~ "Indian Ocean",
                            TRUE ~ region),
         region = fct_rev(fct_inorder(region))) %>% 
  mutate(
    latitude = case_when(
      biome == "Global" ~ "Global",
      biome %in% c(
        "NA-SPSS",
        "NA-STSS",
        "NA-STPS",
        "NP-SPSS",
        "NP-STSS",
        "NP-STPS"
      ) ~ "Northern\nhemisphere",
      biome %in% c(
        "Arabian Sea",
        "Bay of Bengal",
        "Equatorial Indian",
        "PEQU-W",
        "PEQU-E",
        "AEQU"
      ) ~ "Equatorial\nregions",
      biome %in% c("SA-STPS", "SP-STPS", "Southern Indian", "SO-STSS", "SO-SPSS") ~ "Southern\nhemisphere",
      TRUE ~ "other"
    ),
    latitude = fct_relevel(latitude, c("Global",
                                       "Northern\nhemisphere",
                                       "Equatorial\nregions",
                                       "Southern\nhemisphere"))) %>% 
  mutate(basin = case_when(
    biome == "Global" ~ "",
    str_detect(biome, "NA-|SA-|AEQU") ~ "Atlantic",
    str_detect(biome, "NP-|SP-") ~ "Pacific",
    str_detect(biome, "Indian") ~ "Indian",
    str_detect(biome, "SO-") ~ "Southern\nOcean",
    biome == "PEQU-E" ~ "Pacific-E",
    biome == "PEQU-W" ~ "Pacific-W",
    TRUE ~ "other")) %>% 
  mutate(biome_class = case_when(
    str_detect(biome, "SPSS") ~ "Subpolar\nseasonally\nstratified\n(SPSS)",
    str_detect(biome, "STSS") ~ "Subtropical\nseasonally\nstratified\n(STSS)",
    str_detect(biome, "STPS|Southern Indian") ~ "Subtropical\npermanently\nstratified\n(STPS)",
    TRUE ~ ""),
    biome_class = fct_relevel(biome_class, 
                              "Subtropical\nseasonally\nstratified\n(STSS)", 
                              after = 2)) %>% 
  filter(year == {{year_anom}},
         name %in% c("temperature", "fgco2", "fgco2_int"))

pco2_product_biome_annual_anomaly_merged_ensemble <- 
pco2_product_biome_annual_anomaly_merged %>% 
  filter(product %in% pco2_product_list) %>% 
  group_by(name, biome, basin, region, latitude, biome_class) %>%
  summarise(resid_sd = sd(resid),
            resid = mean(resid))

pco2_product_biome_annual_anomaly_merged_ensemble %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")


pco2_product_biome_annual_anomaly_merged_ensemble %>%
  filter(name != "fgco2_int", !str_detect(biome, "SO-")) %>%
  ggplot(aes(x = basin, y = resid)) +
  geom_hline(yintercept = 0) +
  geom_col(aes(fill = "pCO2 product\nensemble mean"), col = "grey20") +
  geom_linerange(aes(
    ymin = resid - resid_sd,
    ymax = resid + resid_sd,
    col = "pCO2 product\nensemble SD"
  )) +
  scale_color_manual(values = "grey20", name = "") +
  scale_fill_manual(values = "grey90", name = "") +
  new_scale_color() +
  geom_point(
    data = pco2_product_biome_annual_anomaly_merged %>%
      filter(
        name != "fgco2_int",
        product %in% pco2_product_list,
        !str_detect(biome, "SO-")
      ),
    aes(col = product, shape = product)
  ) +
  scale_color_manual(values = color_products, name = "pCO2 products") +
  scale_shape_manual(values = 21:24, name = "pCO2 products") +
  new_scale_color() +
  new_scale("shape") +
  geom_point(
    data = pco2_product_biome_annual_anomaly_merged %>%
      filter(
        name != "fgco2_int",
        product %in% gobm_product_list,
        !str_detect(biome, "SO-")
      ),
    aes(col = product, shape = product),
    position = position_nudge(x = 0.2)
  ) +
  scale_color_manual(values = color_products, name = "GOBMs") +
  scale_shape_manual(values = 21:22, name = "GOBMs") +
  facet_nested(
    name ~ latitude + biome_class,
    scales = "free",
    space = "free_x",
    labeller = labeller(name = x_axis_labels),
    switch = "y",
    nest_line = element_line(linewidth = 0.8),
    solo_line = TRUE,
    strip = strip_nested(
      text_x = list(
        element_text(face = "bold"),
        element_text(face = "bold"),
        element_text(face = "bold"),
        element_text(face = "bold"),
        elem_list_text(),
        elem_list_text(),
        elem_list_text(),
        elem_list_text(),
        elem_list_text(),
        elem_list_text()
      )
    )
  ) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    strip.background.x = element_blank()
  )

ggsave(width = 10,
       height = 6,
       dpi = 600,
       filename = "../output/biome_annual_ensemble_mean.jpg")


p_global <- pco2_product_biome_annual_anomaly_merged_ensemble %>% 
  filter(biome == "Global") %>% 
  ggplot(aes(basin, resid)) +
  geom_hline(yintercept = 0) +
  geom_col(aes(fill = "pCO2 product\nensemble mean"), col = "grey20") +
  geom_linerange(aes(ymin = resid - resid_sd,
                     ymax = resid + resid_sd,
                     col = "pCO2 product\nensemble SD")) +
  scale_color_manual(values = "grey20", name = "") +
  scale_fill_manual(values = "grey90", name = "") +
  new_scale_color()+
  geom_point(
    data = pco2_product_biome_annual_anomaly_merged %>%
      filter(biome == "Global",
             product %in% pco2_product_list),
    aes(col = product),
    # position = position_nudge(x = -0.15),
    shape = 21
  ) +
  scale_color_manual(values = color_products,
                     name = "pCO2 products") +
  new_scale_color()+
  geom_point(data = pco2_product_biome_annual_anomaly_merged %>% 
               filter(biome == "Global",
                      product %in% gobm_product_list),
             aes(col = product),
             position = position_nudge(x = 0.2),
             shape = 21) +
  scale_color_manual(values = color_products,
                     name = "GOBMs") +
  facet_nested(name ~ latitude + biome_class, 
             scales = "free", space = "free_x",
             labeller = labeller(name = x_axis_labels),
             switch = "y",
             nest_line = element_line(),
             solo_line = TRUE) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    strip.background.x = element_blank(),
    legend.position = "none"
  )
  
p_biome <- pco2_product_biome_annual_anomaly_merged_ensemble %>% 
  filter(biome != "Global") %>% 
  ggplot(aes(basin, resid)) +
  geom_hline(yintercept = 0) +
  geom_col(aes(fill = "pCO2 product\nensemble mean"), col = "grey20") +
  geom_linerange(aes(ymin = resid - resid_sd,
                     ymax = resid + resid_sd,
                     col = "pCO2 product\nensemble SD")) +
  scale_color_manual(values = "grey20", name = "") +
  scale_fill_manual(values = "grey90", name = "") +
  new_scale_color()+
  geom_point(
    data = pco2_product_biome_annual_anomaly_merged %>%
      filter(biome != "Global",
             product %in% pco2_product_list),
    aes(col = product),
    # position = position_nudge(x = -0.15),
    shape = 21
  ) +
  scale_color_manual(values = color_products,
                     name = "pCO2 products") +
  new_scale_color()+
  geom_point(data = pco2_product_biome_annual_anomaly_merged %>% 
               filter(biome != "Global",
                      product %in% gobm_product_list),
             aes(col = product),
             position = position_nudge(x = 0.2),
             shape = 21) +
  scale_color_manual(values = color_products,
                     name = "GOBMs") +
  facet_nested(name ~ latitude + biome_class, 
             scales = "free", space = "free_x",
             labeller = labeller(name = ""),
             # switch = "y",
             nest_line = element_line(),
             solo_line = TRUE
             ) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text.y.right = element_text(colour = "transparent",
                                      size = 0),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    strip.background.x = element_blank()
  )


ggsave(cowplot::plot_grid(p_global, p_biome,
                   align = "h",
                   rel_widths = c(1,6)),
       width = 13,
       height = 8,
       dpi = 600,
       filename = "../output/biome_annual_ensemble_mean_with_integrated_flux_and_SO.jpg")

```

### Global region definition

```{r absolute_integrals_global_definitions, fig.asp=0.5}

biome_mask_recompute <- 
bind_rows(
  biome_mask %>%
    select(-biome) %>%
    mutate(region = "Global"),
  biome_mask %>%
    filter(biome != "Global",
           !str_detect(biome, "SO")) %>%
    select(-biome) %>%
    mutate(region = "Global excl. SO"),
  biome_mask %>%
    filter(biome != "Global",
           !str_detect(biome, "SO|SA-|SP-|Southern")) %>%
    select(-biome) %>%
    mutate(region = "Global excl. SH"),
  biome_mask %>%
    filter(str_detect(biome, "NA-|NP")) %>%
    select(-biome) %>%
    mutate(region = "N Atl + N Pac"),
  biome_mask %>%
    filter(str_detect(biome, "NA-|SA-|AEQU")) %>%
    select(-biome) %>%
    mutate(region = "Atl"),
  biome_mask %>%
    filter(str_detect(biome, "NA")) %>%
    select(-biome) %>%
    mutate(region = "N Atl")
) %>%
  mutate(region = fct_inorder(region))

biome_mask_recompute <-
  left_join(pco2_product_map_annual_anomaly %>% 
              filter(year == {{year_anom}},
                     name == "fgco2",
                     product %in% pco2_product_list) %>% 
              group_by(lon, lat) %>% 
              summarise(resid = mean(resid)) %>% 
              ungroup(),
            biome_mask_recompute)


map +
  geom_tile(data = biome_mask_recompute,
            aes(lon, lat, fill = resid)) +
  facet_wrap(~ region, ncol = 1) +
  scale_fill_gradientn(
    colours = warm_cool_gradient,
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("fgco2"),
    limits = c(
      quantile(biome_mask_recompute$resid, .01),
      quantile(biome_mask_recompute$resid, .99)
    ),
    oob = squish
  ) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "top")


pco2_product_biome_annual_anomaly_recompute <-
  full_join(
    pco2_product_biome_annual_anomaly,
    biome_mask %>%
      mutate(area = earth_surf(lat, lon)) %>%
      group_by(biome) %>%
      summarise(area = sum(area)) %>%
      ungroup() %>%
      filter(biome != "Global")
  ) %>% 
  pivot_longer(c(value,resid,fit),
               names_to = "estimate") %>% 
  pivot_wider()

pco2_product_biome_annual_anomaly_recompute <-
bind_rows(
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(biome != "Global") %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global"),
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(biome != "Global",
           !str_detect(biome, "SO")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global excl. SO"),
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(biome != "Global",
           !str_detect(biome, "SO|SA-|SP-|Southern")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global excl. SH"),
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(str_detect(biome, "NA-|NP")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "N Atl + N Pac"),
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(str_detect(biome, "NA-|SA-|AEQU")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Atl"),
  pco2_product_biome_annual_anomaly_recompute %>%
    filter(str_detect(biome, "NA")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "N Atl")) %>% 
  mutate(region = fct_inorder(region)) %>% 
  pivot_longer(-c(product, year, region, estimate)) %>% 
  pivot_wider(names_from = estimate)

pco2_product_biome_annual_anomaly_recompute %>% 
  filter(year == {{year_anom}},
         name %in% c("fgco2", "fgco2_int", "dfco2")) %>%    
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_hline(yintercept = 0) +
      geom_col(aes(region, value, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(region, fit, group = product, col = paste0({{year_anom}},"\nlinear\nprediction")),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Absolute") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )


full_join(pco2_product_biome_annual_anomaly_recompute %>%
  group_by(product, name, region) %>%
  summarise(resid_sd = sd(resid, na.rm = TRUE)) %>%
  ungroup(),
pco2_product_biome_annual_anomaly_recompute %>%  
  filter(year == {{year_anom}})) %>% 
  filter(name %in% c("fgco2",
                     "fgco2_int",
                     "dfco2",
                     "kw_sol",
                     "temperature",
                     "no3",
                     "mld",
                     "intpp",
                     "chl")) %>%    
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_hline(yintercept = 0) +
      geom_col(aes(region, resid, fill = product),
               position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(region, resid_sd * sign(value - fit), 
                   group = product, col = paste0("Anomaly SD\nexcl.",{{year_anom}})),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Anomaly") +
      scale_color_grey() +
      facet_grid(. ~ region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  
```

## Seasonal anomalies

### Annual mean trends

```{r anomalies_from_annual_mean_trends_overview_OceanSODA, fig.asp=1}

pco2_product_biome_monthly_detrended %>%
  filter(biome %in% "NA-STPS",
         name %in% c("temperature"),
         product %in% pco2_product_list) %>%
  select(-c(time, product)) %>% 
  group_by(year, month, biome, name) %>% 
  summarise(across(where(is.numeric), mean)) %>% 
  ungroup()

pco2_product_biome_monthly_detrended %>%
  filter(biome %in% "Global",
         name %in% c("temperature"),
         product %in% pco2_product_list) %>%
  select(-c(time, product)) %>% 
  group_by(year, month, biome, name) %>% 
  summarise(across(where(is.numeric), mean)) %>% 
  ungroup() %>% 
  # mutate(product = "Ensemble mean") %>% 
  p_season(title = NULL,
           dim_col = NULL)

ggsave(width = 7,
       height = 3,
       dpi = 600,
       filename = "../output/seasonality_sst_global.jpg")

pco2_product_biome_monthly_detrended %>%
  filter(biome %in% "Global",
         name %in% c("fgco2_int"),
         product %in% pco2_product_list) %>%
  select(-c(time, product)) %>% 
  group_by(year, month, biome, name) %>% 
  summarise(across(where(is.numeric), mean)) %>% 
  ungroup() %>% 
  # mutate(product = "Ensemble mean") %>% 
  p_season(title = NULL,
           dim_col = NULL)

ggsave(width = 7,
       height = 3,
       dpi = 600,
       filename = "../output/seasonality_fgco2_global.jpg")


```

```{r anomalies_from_annual_mean_trends_overview_pCO2_products}

pco2_product_biome_annual_detrended %>% 
  filter(biome %in% "Global",
         name %in% c("fgco2", "temperature")) %>%
  p_season(title = NULL) +
  theme(legend.position = "top")

ggsave(width = 15,
       height = 6,
       dpi = 600,
       filename = "../output/seasonality_product.jpg")

```

```{r anomalies_from_annual_mean_trends_overview, fig.asp=1.5}

pco2_product_biome_annual_detrended %>% 
  filter(biome %in% "Global",
         name %in% name_core) %>%
  p_season(title = "Anomalies from predicted annual mean | Global")
  
```

```{r anomalies_from_annual_mean_trends_key_biomes, fig.asp=1.5}

pco2_product_biome_annual_detrended %>%
  filter(biome %in% key_biomes,
         name %in% name_core) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(~ p_season(
    df = .x,
    title = paste("Anomalies from predicted annual mean |", .x$biome)
  ))


```

### Monthly mean trends

```{r anomalies_from_monthly_mean_trends_overview, fig.asp=1.5}

pco2_product_biome_monthly_detrended %>% 
  filter(biome %in% "Global",
         name %in% name_core) %>%
  p_season(title = "Anomalies from predicted monthly mean | Global")

```

```{r anomalies_from_monthly_mean_trends_key_biomes, fig.asp=1.5}

pco2_product_biome_monthly_detrended %>%
  filter(biome %in% key_biomes,
         name %in% name_core) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(~ p_season(
    df = .x,
    title = paste("Anomalies from predicted monthly mean |", .x$biome)
  ))


```

# Flux anomaly correlation

The following plots aim to unravel the correlation between biome-, super-biome- or globally- integrated monthly flux anomalies and the corresponding anomalies of the means/integrals of each other variable.

Anomalies are first presented are first presented in absolute units. Due to the different flux magnitudes, we need to plot the globally and biome-integrated fluxes separately. Secondly, we normalize the anomalies to the monthly spread (expressed as standard deviation) of the anomalies from 1990 to 2021.

## Annual anomalies

### Absolute

```{r anomalies_correlation_absolute_annual_biome_key, fig.asp=0.8}


pco2_product_biome_annual_anomaly %>%
  filter(biome %in% c("Global", key_biomes),
         name %in% name_core) %>%
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, biome, fgco2_int))  %>%
  filter(name == "temperature") %>% 
  group_split(name) %>%
  # tail(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_vline(xintercept = 0) +
      geom_hline(yintercept = 0) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        method = "lm",
        fill = "grey",
        col = "grey40",
        fullrange = TRUE
      ) +
      geom_point(
        data = . %>% filter(!year %in% c({{year_anom}}, 1997, 2015)),
        aes(fill = "1990-2022"),
        shape = 21
      ) +
      scale_color_manual(values = "grey60", name = "X") +
      scale_fill_manual(values = "grey60", name = "X") +
      new_scale_fill() +
      new_scale_color() +
      geom_point(
        data = . %>% filter(year %in% c({{year_anom}}, 1997, 2015)),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 3
      )  +
      scale_fill_manual(
        values = rev(warm_cool_gradient[c(17,13,20)]),
        guide = guide_legend(reverse = TRUE,
                             order = 2)
      ) +
      scale_color_manual(
        values = rev(warm_cool_gradient[c(17,13,20)]),
        guide = guide_legend(reverse = TRUE,
                             order = 2)
      ) +
      labs(y = labels_breaks("fgco2_int")$i_legend_title,
           x = labels_breaks(unique(.x$name))$i_legend_title) +
      facet_grid2(
        biome ~ product,
        scales = "free",
        independent = "x"
      ) +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        legend.title = element_blank()
      )
  )

ggsave(width = 12,
       height = 9,
       dpi = 600,
       filename = "../output/flux_sst_anomaly_correlation_biome.jpg")


pco2_product_biome_annual_anomaly_ensemble <-
  pco2_product_biome_annual_anomaly %>%
  filter(name %in% name_core, product %in% pco2_product_list) %>%
  select(-c(value, fit, product)) %>%
  fgroup_by(name, biome, year) %>%
  fsummarise(sd = fsd(resid),
             mean = fmean(resid))

pco2_product_biome_annual_anomaly_ensemble <-
  full_join(
    pco2_product_biome_annual_anomaly_ensemble %>%
      filter(name == "fgco2_int") %>%
      pivot_wider(values_from = c(sd, mean)),
    pco2_product_biome_annual_anomaly_ensemble %>%
      filter(name != "fgco2_int")
  )

pco2_product_biome_annual_anomaly_ensemble %>%
  filter(biome %in% c("Global", key_biomes),
         name == "temperature") %>% 
  group_split(name) %>%
  # tail(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(mean, mean_fgco2_int)) +
      geom_vline(xintercept = 0) +
      geom_hline(yintercept = 0) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        method = "lm",
        fill = "grey",
        col = "grey40",
        fullrange = TRUE
      ) +
      geom_linerange(
        data = . %>% filter(!year %in% c({{year_anom}}, 1997, 2015)),
        aes(ymin = mean_fgco2_int - sd_fgco2_int,
            ymax = mean_fgco2_int + sd_fgco2_int,
            col = "1990-2022")
      ) +
      geom_linerange(
        data = . %>% filter(!year %in% c({{year_anom}}, 1997, 2015)),
        aes(xmin = mean - sd,
            xmax = mean + sd,
            col = "1990-2022")
      ) +
      geom_point(
        data = . %>% filter(!year %in% c({{year_anom}}, 1997, 2015)),
        aes(fill = "1990-2022"),
        shape = 21
      ) +
      scale_color_manual(values = "grey60", name = "X") +
      scale_fill_manual(values = "grey60", name = "X") +
      new_scale_fill() +
      new_scale_color() +
      geom_linerange(
        data = . %>% filter(year %in% c({{year_anom}}, 1997, 2015)),
        aes(ymin = mean_fgco2_int - sd_fgco2_int,
            ymax = mean_fgco2_int + sd_fgco2_int,
            col = as.factor(year)),
        linewidth = 1
      ) +
      geom_linerange(
        data = . %>% filter(year %in% c({{year_anom}}, 1997, 2015)),
        aes(xmin = mean - sd,
            xmax = mean + sd,
            col = as.factor(year)),
        linewidth = 1
      ) +
      geom_point(
        data = . %>% filter(year %in% c({{year_anom}}, 1997, 2015)),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 3
      )  +
      scale_fill_manual(
        values = rev(warm_cool_gradient[c(17,13,20)]),
        guide = guide_legend(reverse = TRUE,
                             order = 2)
      ) +
      scale_color_manual(
        values = rev(warm_cool_gradient[c(17,13,20)]),
        guide = guide_legend(reverse = TRUE,
                             order = 2)
      ) +
      labs(y = labels_breaks("fgco2_int")$i_legend_title,
           x = labels_breaks(unique(.x$name))$i_legend_title) +
      facet_wrap(
        ~ biome,
        scales = "free") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        legend.title = element_blank()
      )
  )

ggsave(width = 9,
       height = 6,
       dpi = 600,
       filename = "../output/flux_sst_anomaly_correlation_biome_ensemble.jpg")


pco2_product_biome_annual_anomaly %>%
  filter(
    biome %in% c("Global", key_biomes),
    name %in% c(
      "fgco2_int",
      "chl",
      "dfco2",
      "sfco2",
      "atm_fco2",
      "temperature",
      "sdissic",
      "no3",
      "int_pp",
      "mld",
      "kw_sol"
    )
  ) %>% 
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, biome, fgco2_int)) %>% 
  group_by(product, name, biome) %>% 
  summarise(correlation = cor(fgco2_int, value)) %>% 
  ungroup() %>% 
  group_by(name) %>% 
  mutate(correlation_mean = mean(abs(correlation), na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(name = fct_reorder(name, correlation_mean)) %>% 
  ggplot(aes(product,name,fill=correlation)) +
  geom_tile() +
  scale_fill_divergent() +
  facet_wrap(~ biome) +
  labs(title = "Correlation with FCO2 on a annual mean basis") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_blank(),
        legend.position = c(0.85,0.1),
        legend.direction = "horizontal")

pco2_product_biome_monthly_anomaly %>%
filter(
    biome %in% c("Global", key_biomes),
    name %in% c(
      "fgco2_int",
      "chl",
      "dfco2",
      "sfco2",
      "atm_fco2",
      "temperature",
      "sdissic",
      "no3",
      "int_pp",
      "mld",
      "kw_sol"
    )
  ) %>% 
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int)) %>% 
  group_by(product, name, biome) %>% 
  summarise(correlation = cor(fgco2_int, value)) %>% 
  ungroup() %>% 
  group_by(name) %>% 
  mutate(correlation_mean = mean(abs(correlation), na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(name = fct_reorder(name, correlation_mean)) %>% 
  ggplot(aes(product,name,fill=correlation)) +
  geom_tile() +
  scale_fill_divergent() +
  facet_wrap(~ biome) +
  labs(title = "Correlation with FCO2 on a monthly mean basis") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_blank(),
        legend.position = c(0.85,0.1),
        legend.direction = "horizontal")


pco2_product_biome_monthly_anomaly %>%
filter(
    biome %in% c("Global", key_biomes),
    name %in% c(
      "fgco2_int",
      "chl",
      "dfco2",
      "sfco2",
      "atm_fco2",
      "temperature",
      "sdissic",
      "no3",
      "int_pp",
      "mld",
      "kw_sol"
    )
  ) %>% 
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int)) %>% 
  group_by(product, name, biome, month) %>% 
  summarise(correlation = cor(fgco2_int, value)) %>% 
  ungroup() %>% 
  group_by(name) %>% 
  mutate(correlation_mean = mean(abs(correlation), na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(name = fct_reorder(name, correlation_mean)) %>% 
  ggplot(aes(month, correlation, col = name)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  facet_grid(product ~ biome) +
  labs(title = "Correlation with FCO2 on a monthly mean basis")
  # theme(axis.text.x = element_text(angle = 90, hjust = 1),
  #       axis.title = element_blank(),
  #       legend.position = c(0.85,0.1),
  #       legend.direction = "horizontal")


```

## Monthly anomalies

### Absolute

```{r anomalies_correlation_absolute_monthly_global, fig.asp=0.7}


pco2_product_biome_monthly_detrended %>%
  filter(biome == "Global") %>%
  select(-c(time, fit, value)) %>% 
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
      aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill =  as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      labs(
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(unique(.x$name))$i_legend_title
      ) +
      facet_grid(biome ~ product,
                 scales = "free_y") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown()
      )
  )


```

```{r anomalies_correlation_absolute_monthly_biomes_key, fig.asp=1.2}


pco2_product_biome_monthly_detrended %>%
  filter(biome %in% key_biomes) %>%
  select(-c(time, fit, value)) %>% 
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
      aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill =  as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      labs(
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(unique(.x$name))$i_legend_title
      ) +
      facet_grid(biome ~ product,
                 scales = "free_y") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown()
      )
  )


```

## fCO2 decomposition

```{r pCO2_decomposition}

pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(biome %in% c("Global",key_biomes)) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(df = .x,
               title  = paste("Anomalies from predicted monthly mean |", .x$biome))
  )


```

## Flux attribution

### Seasonal

```{r flux_attribution, fig.asp=1}

ggplot() +
  geom_hline(yintercept = 0) +
  geom_col(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(biome %in% c("Global", key_biomes),
             product %in% pco2_product_list) %>% 
      group_by(biome, name) %>% 
      summarise(resid = mean(resid)) %>% 
      ungroup(),
    aes("", resid),
    fill = "grey90", col = "grey20"
  ) +
  geom_point(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    shape = 21
  ) +
  scale_fill_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.1)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
             scales = "free_y",
             space = "free_y",
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )


ggplot() +
  geom_hline(yintercept = 0) +
  geom_col(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    position = position_dodge(width = 1),
    alpha = 0.5, col = "grey30"
  ) +
  geom_point(
    data = pco2_product_biome_monthly_flux_attribution %>%
      filter(year == {{year_anom}},
             biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    position = position_dodge(width = 1),
    shape = 21, alpha = 0.5, col = "grey30"
  ) +
  scale_fill_manual(values = color_products) +
  # scale_color_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.2)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
                          scales = "free_y",
             space = "free_y",
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )

pco2_product_biome_monthly_flux_attribution %>%
  filter(year == {{year_anom}},
         biome %in% c("Global", key_biomes)) %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_path(
    aes(month, resid, col = product)
  ) +
  geom_point(
    aes(month, resid, fill = product),
    shape = 21,
    alpha = 0.5,
    col = "grey30"
  ) +
  scale_fill_manual(values = color_products) +
  scale_color_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.2)) +
  scale_x_continuous(position = "top", breaks = seq(1,12,3)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
             scales = "free_y",
             space = "free_y", 
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )


```

```{r flux_attribution_seasonal}



pco2_product_biome_monthly_flux_attribution %>%
  filter(biome %in% c("Global", key_biomes)) %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(
      df = .x,
      title  = paste("Anomalies from predicted monthly mean |", .x$biome)
    ) +
      facet_grid(
        name ~ product,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```

### Annual

```{r flux_attribution_annual, fig.asp=0.5}


# pco2_product_biome_annual_flux_attribution <-
# full_join(
# pco2_product_biome_annual_flux_attribution %>% 
#   filter(year == {{year_anom}}) %>% 
#   select(-year),
# pco2_product_biome_annual_flux_attribution %>% 
#   filter(year != {{year_anom}}) %>% 
#   group_by(product, biome, name) %>% 
#   summarise(resid_mean = mean(abs(resid))) %>% 
#   ungroup())

pco2_product_biome_annual_flux_attribution %>%
  filter(biome %in% c("Global", key_biomes)) %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes("x", resid, fill = product),
               position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(
        aes(
          "x",
          resid_mean * sign(resid),
          group = product,
          col = paste0("Mean\nexcl.",{{year_anom}})
        ),
        position = "dodge2",
        fill = "transparent"
      ) +
      labs(y = labels_breaks(unique("fgco2"))$i_legend_title,
           title = .x$biome) +
      facet_grid(
        .~name,
        labeller = labeller(name = x_axis_labels),
        switch = "x"
      ) +
      scale_color_grey() +
      theme(
        legend.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_markdown(),
        strip.text.x.bottom = element_markdown(),
        strip.placement = "outside",
        strip.background.x = element_blank(),
        legend.position = "top"
      )
  )


```

## Merged seasonality plots

```{r merged_seasonality_ensemble_mean}


pco2_product_biome_monthly_detrended %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("temperature", "fgco2"), biome %in% key_biomes,
         year != {{year_anom}}) %>%
  group_by(month, biome, name) %>% 
  summarise(resid_sd = sd(resid)) %>% 
  ungroup() %>% 
  ggplot(aes(month, resid_sd)) +
  geom_path() +
  facet_grid(name ~ biome, scales = "free_y")



pco2_product_biome_monthly_detrended %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("temperature", "fgco2"), biome %in% key_biomes) %>%
  p_season(dim_col = "biome", 
           title = "Ensemble mean anomalies from predicted monthly mean") +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank()) +
  new_scale_color() +
  scale_color_manual(values = warm_color) +
  geom_path(
    data = pco2_product_biome_monthly_detrended %>%
      filter(
        product %in% gobm_product_list,
        year == {{year_anom}},
        name %in% c("temperature", "fgco2"),
        biome %in% key_biomes
      ) %>%
      group_by(year, month, biome, name) %>%
      summarise(across(where(is.numeric), mean)) %>%
      ungroup(),
    aes(month, resid, col = "2023\nGOBM mean")
  )

ggsave(width = 9,
       height = 4,
       dpi = 600,
       filename = "../output/seasonal_anomaly_ensemble.jpg")

pco2_product_biome_monthly_flux_attribution %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Ensemble mean drivers of flux anomaly",
           scales = "fixed") +
  new_scale_color() +
  scale_color_manual(values = warm_color) +
  geom_path(
    data = pco2_product_biome_monthly_flux_attribution %>%
      filter(
        product %in% gobm_product_list,
        year == {{year_anom}},
        name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
        biome %in% key_biomes
      ) %>%
      group_by(year, month, biome, name) %>%
      summarise(across(where(is.numeric), mean)) %>%
      ungroup(),
    aes(month, resid, col = "2023\nGOBM mean")
  )

ggsave(width = 9,
       height = 4,
       dpi = 600,
       filename = "../output/seasonal_anomaly_attribution_ensemble.jpg")

pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("sfco2_nontherm", "sfco2_therm", "sfco2_total"),
         biome %in% c("Global", key_biomes)) %>%
  p_season(dim_col = "biome",
           title = "Ensemble mean decomposition of fCO2 anomaly")  

ggsave(width = 9,
       height = 4,
       dpi = 600,
       filename = "../output/seasonal_anomaly_fco2_decompospition_ensemble.jpg")

```

```{r merged_seasonality_all_products}

pco2_product_biome_monthly_detrended %>% 
  filter(year == {{year_anom}},
         name %in% c("temperature", "fgco2"),
         biome %in% c("Global", key_biomes)) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Anomalies from predicted monthly mean") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

ggsave(width = 9,
       height = 3,
       dpi = 600,
       filename = "../output/seasonal_anomaly_products.jpg")

pco2_product_biome_monthly_flux_attribution %>%
  filter(year == {{year_anom}},
         name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
         biome %in% c("Global", key_biomes)) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Drivers of flux anomaly") +
  facet_grid(
    name ~ biome,
    scales = "fixed",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

ggsave(width = 9,
       height = 3,
       dpi = 600,
       filename = "../output/seasonal_anomaly_attribution_products.jpg")

pco2_product_biome_monthly_fCO2_decomposition %>% 
  filter(year == {{year_anom}},
         name %in% c("sfco2_nontherm", "sfco2_therm", "sfco2_total"),
         biome %in% c("Global", key_biomes)) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Decomposition of fCO2 anomaly") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

ggsave(width = 9,
       height = 4,
       dpi = 600,
       filename = "../output/seasonal_anomaly_fco2_decompospition_products.jpg")

```


# Biome profiles

The following analysis is available for GOBMs only.

## Annual means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_annual, fig.asp=1}

pco2_product_profiles_annual %>%
  filter(biome %in% key_biomes) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_vline(xintercept = 0) +
      geom_path(aes(resid, depth, group = year), col = "grey30", alpha = 0.3) +
      geom_path(data = .x %>% filter(year == {{year_anom}}),
                aes(resid, depth, col = as.factor(year)),
                linewidth = 1) +
      scale_color_brewer(palette = "Set1") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      coord_cartesian(expand = 0) +
      facet_grid2(biome ~ product,
                  scales = "free_x", independent = "x") +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```

## Monthly means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_monthly, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_vline(xintercept = 0) +
      geom_path(aes(resid, depth, col = as.factor(month)),
                linewidth = 1) +
      scale_color_viridis_d(option = "magma", end = .8) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      coord_cartesian(expand = 0) +
      facet_grid2(biome ~ product,
                  scales = "free_x", independent = "x") +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```

```{r {{year_anom}}_anomaly_profiles_monthly_CESM, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "ETHZ_CESM",
         name %in% c(
           "sdissic",
           "cstar",
           "no3",
           "thetao"
         )) %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Anomalies from monthly baseline (deseasonalized)")

ggsave(width = 10,
       height = 8,
       dpi = 600,
       filename = "../output/CESM_2023_anomaly_profiles.jpg")

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "ETHZ_CESM") %>%
  arrange(month) %>% 
  group_by(biome, name, depth) %>% 
  mutate(resid = resid - first(resid)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Monthly anomaly evolution relative to January 2023")

ggsave(width = 16,
       height = 8,
       filename = "../output/CESM_2023_anomaly_profiles_change.jpg")



# pco2_product_profiles_monthly %>%
#   filter(
#     biome %in% "NA-STPS",
#     depth == 5,
#     product == "ETHZ_CESM",
#     name %in% c("dissic", "talk", "sdissic", "stalk", "so")
#   ) %>%
#   filter(month %in% seq(1, 12, 3)) %>%
#   ggplot(aes(year + month / 12, value, col = as.factor(month))) +
#   geom_point() +
#   scale_color_viridis_d(option = "magma",
#                         end = .8,
#                         name = paste("Month of\nyear")) +
#   geom_smooth(method = "lm", se = FALSE) +
#   facet_wrap( ~ name, scales = "free_y", ncol = 1)
# 
# 
# pco2_product_profiles_monthly %>%
#   filter(
#     biome %in% "NA-STPS",
#     depth == 5,
#     product == "ETHZ_CESM",
#     name %in% c("dissic", "talk", "sdissic", "stalk", "so")
#   ) %>%
#   filter(month %in% seq(1, 12, 3)) %>%
#   ggplot(aes(year + month / 12, resid, col = as.factor(month))) +
#   geom_point() +
#   scale_color_viridis_d(option = "magma",
#                         end = .8,
#                         name = paste("Month of\nyear")) +
#   geom_smooth(method = "lm", se = FALSE) +
#   facet_wrap( ~ name, scales = "free_y", ncol = 1)


```


```{r {{year_anom}}_anomaly_profiles_monthly_FESOM, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "FESOM-REcoM",
         name %in% c(
           "dissic",
           "talk",
           "no3",
           "thetao",
           "so"
         )) %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Anomalies from monthly baseline (deseasonalized)")

ggsave(width = 10,
       height = 8,
       dpi = 600,
       filename = "../output/FESOM_2023_anomaly_profiles.jpg")


```



```{r {{year_anom}}_anomaly_profiles_monthly_hovmoeller, fig.asp=1}

plot_list <-
  full_join(
    pco2_product_profiles_monthly %>%
      filter(
        year == {{year_anom}},
        biome %in% key_biomes,
        # product == "ETHZ_CESM",
        name %in% c("sdissic", "thetao")
      ),
    pco2_product_biome_monthly_detrended %>%
      filter(
        biome %in% key_biomes,
        name %in% "mld",
        year == {{year_anom}},
        product %in% gobm_product_list
      ) %>%
      select(product, month, biome, mld = value)
  ) %>%
  group_split(name, biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(month, depth, z = resid)) +
      geom_line(aes(month, mld))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        super = ScaleDiscretised,
        name = labels_breaks(.x %>% distinct(name))$i_legend_title
      )+
      scale_y_continuous(trans = trans_reverser("sqrt"), breaks = c(20, 50, 100, 200, 400)) +
      coord_cartesian(expand = 0,
                      ylim = c(300,NA)) +
      facet_grid(product ~ biome) +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(10, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

ggsave(plot = wrap_plots(plot_list,
                         ncol = 3),
       width = 18,
       height = 12,
       dpi = 600,
       filename = "../output/GOBM_profiles_hovmoeller.jpg")

plot_list <-
  full_join(
    pco2_product_profiles_monthly %>%
      filter(
        year == {{year_anom}},
        biome %in% key_biomes,
        # product == "ETHZ_CESM",
        name %in% c("sdissic", "thetao")
      ) %>% 
      arrange(month) %>% 
      group_by(product, name, biome, depth) %>% 
      mutate(resid = if_else(name == "sdissic",
                             resid - first(resid),
                             resid)) %>% 
      ungroup(),
    pco2_product_biome_monthly_detrended %>%
      filter(
        biome %in% key_biomes,
        name %in% "mld",
        year == {{year_anom}},
        product %in% gobm_product_list
      ) %>%
      select(product, month, biome, mld = value)
  ) %>%
  group_split(name, biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(month, depth, z = resid)) +
      geom_line(aes(month, mld))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        super = ScaleDiscretised,
        name = labels_breaks(.x %>% distinct(name))$i_legend_title
      )+
      scale_y_continuous(trans = trans_reverser("sqrt"), breaks = c(20, 50, 100, 200, 400)) +
      coord_cartesian(expand = 0,
                      ylim = c(300,NA)) +
      facet_grid(product ~ biome) +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(10, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

ggsave(plot = wrap_plots(plot_list,
                         ncol = 3),
       width = 18,
       height = 12,
       dpi = 600,
       filename = "../output/GOBM_profiles_hovmoeller_evolution.jpg")


```



```{r {{year_anom}}_anomaly_profiles_monthly_hovmoeller_ensemble, fig.asp=1}

CESM_depth_grid <- pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}}, 
         product == "ETHZ_CESM",
         biome %in% key_biomes,
         name %in% c("sdissic", "thetao")) %>%
  distinct(name, biome, month, depth)

pco2_product_profiles_monthly_FESOM_regrid <-
full_join(
  pco2_product_profiles_monthly %>%
    filter(
      year == {{year_anom}},
      product == "FESOM-REcoM",
      biome %in% key_biomes,
      name %in% c("sdissic", "thetao")
    ),
  CESM_depth_grid %>% mutate(product = "FESOM-REcoM")
)

pco2_product_profiles_monthly_FESOM_regrid <-
pco2_product_profiles_monthly_FESOM_regrid %>%
  arrange(product, name, biome, month, depth)
  
  
pco2_product_profiles_monthly_FESOM_regrid <-
pco2_product_profiles_monthly_FESOM_regrid %>%
  arrange(depth) %>%
  group_by(product, name, biome, month) %>%
  mutate(resid = spline(
    depth,
    resid,
    method = "natural",
    xout = depth
  )$y) %>%
  ungroup()

CESM_depth <- 
  CESM_depth_grid %>% distinct(depth) %>% pull()

pco2_product_profiles_monthly_FESOM_regrid <-
  pco2_product_profiles_monthly_FESOM_regrid %>%
  filter(depth %in% CESM_depth)


pco2_product_profiles_monthly_merged <-
  bind_rows(
    pco2_product_profiles_monthly_FESOM_regrid,
    pco2_product_profiles_monthly %>%
      filter(
        year == {{year_anom}},
        product == "ETHZ_CESM",
        biome %in% key_biomes,
        name %in% c("sdissic", "thetao")
      )
  )


pco2_product_profiles_monthly_ensemble <-
  pco2_product_profiles_monthly_merged %>%
  group_by(name, biome, month, depth) %>%
  summarise(resid = mean(resid)) %>%
  ungroup()

plot_list <-
  full_join(
    pco2_product_profiles_monthly_ensemble %>%
      filter(
        biome %in% key_biomes,
        name %in% c("sdissic", "thetao")
      ),
    pco2_product_biome_monthly_detrended %>%
      filter(
        biome %in% key_biomes,
        name %in% "mld",
        year == {{year_anom}},
        product %in% gobm_product_list
      ) %>%
      group_by(month, biome) %>% 
      summarise(mld = mean(value)) %>% 
      ungroup()
  ) %>%
  group_split(name, biome) %>%
  # tail(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(month, depth, z = resid)) +
      geom_line(aes(month, mld))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        super = ScaleDiscretised,
        name = labels_breaks(.x %>% distinct(name))$i_legend_title
      )+
      # scale_y_reverse() +
      scale_y_continuous(trans = trans_reverser("sqrt"), breaks = c(50, 100, 200, 400)) +
      coord_cartesian(expand = 0,
                      ylim = c(300,NA)) +
      facet_wrap( ~ biome) +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(10, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

ggsave(plot = wrap_plots(plot_list,
                         ncol = 3),
       width = 18,
       height = 8,
       dpi = 600,
       filename = "../output/GOBM_profiles_hovmoeller_ensemble.jpg")


plot_list_left <-
  full_join(
    pco2_product_profiles_monthly_ensemble %>%
      filter(
        biome %in% key_biomes,
        name %in% c("sdissic", "thetao")
      ) %>% 
      arrange(month) %>% 
      group_by(name, biome, depth) %>% 
      mutate(resid = if_else(name == "sdissic",
                             resid - first(resid),
                             resid)) %>% 
      ungroup(),
    pco2_product_biome_monthly_detrended %>%
      filter(
        biome %in% key_biomes,
        name %in% "mld",
        year == {{year_anom}},
        product %in% gobm_product_list
      ) %>%
      group_by(month, biome) %>% 
      summarise(mld = mean(value)) %>% 
      ungroup()
  ) %>%
  group_split(biome, name) %>%
  head(2) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(month, depth, z = resid),
                          bins = 8) +
      geom_line(aes(month, mld))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        super = ScaleDiscretised,
        name = labels_breaks(.x %>% distinct(name))$i_legend_title
      )+
      # scale_y_reverse() +
      scale_y_continuous(trans = trans_reverser("sqrt"), breaks = c(20, 50, 100, 200, 400)) +
      coord_cartesian(expand = 0,
                      ylim = c(300,NA)) +
      facet_wrap( ~ biome) +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(8, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

plot_list_right <-
  full_join(
    pco2_product_profiles_monthly_ensemble %>%
      filter(
        biome %in% key_biomes,
        name %in% c("sdissic", "thetao")
      ) %>% 
      arrange(month) %>% 
      group_by(name, biome, depth) %>% 
      mutate(resid = if_else(name == "sdissic",
                             resid - first(resid),
                             resid)) %>% 
      ungroup(),
    pco2_product_biome_monthly_detrended %>%
      filter(
        biome %in% key_biomes,
        name %in% "mld",
        year == {{year_anom}},
        product %in% gobm_product_list
      ) %>%
      group_by(month, biome) %>% 
      summarise(mld = mean(value)) %>% 
      ungroup()
  ) %>%
  group_split(biome, name) %>%
  tail(4) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(month, depth, z = resid),
                          bins = 8) +
      geom_line(aes(month, mld))+
      scale_fill_gradientn(
        colours = warm_cool_gradient,
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        super = ScaleDiscretised,
        name = labels_breaks(.x %>% distinct(name))$i_legend_title
      )+
      # scale_y_reverse() +
      scale_y_continuous(trans = trans_reverser("sqrt"), breaks = c(20, 50, 100, 200, 400)) +
      coord_cartesian(expand = 0,
                      ylim = c(300,NA)) +
      facet_wrap( ~ biome) +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(8, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

plot_list <- c(plot_list_left, plot_list_right)

ggsave(plot = wrap_plots(plot_list,
                         ncol = 3,
                         byrow = FALSE),
       width = 13,
       height = 6,
       dpi = 600,
       filename = "../output/GOBM_profiles_hovmoeller_ensemble_evolution.jpg")




```
