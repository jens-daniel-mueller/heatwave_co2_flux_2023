---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r load_libraries_read_data, include = FALSE}

library(ggnewscale)
library(khroma)
library(scico)
library(ggtext)
library(biscale)
library(scales)
library(ggh4x)
library(cmocean)
library(patchwork)

```

# Read data

```{r read_anomaly_2023_annual_mean_maps}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_anomaly_map_annual.csv"),
                    full.names = TRUE)

pco2_product_coarse_annual_regression <-
  read_csv(files,
           id = "product")

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))


```

```{r read_anomaly_2023_monthly_mean_maps}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_anomaly_map_monthly.csv"),
                    full.names = TRUE)

pco2_product_coarse_monthly_regression <-
  read_csv(files,
           id = "product")

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly_regression %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_hovmoeller_monthly_anomalies}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_anomaly_hovmoeller_monthly.csv"),
                    full.names = TRUE)

pco2_product_hovmoeller_monthly_regression <-
  read_csv(files,
           id = "product")

pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly_regression %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_biome_annual_regression}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_biome_annual_regression.csv"),
                    full.names = TRUE)

pco2_product_annual_regression <-
  read_csv(files,
           id = "product")

pco2_product_annual_regression <-
  pco2_product_annual_regression %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_biome_annual_detrended}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_biome_annual_detrended.csv"),
                    full.names = TRUE)

pco2_product_annual_detrended <-
  read_csv(files,
           id = "product")

pco2_product_annual_detrended <-
  pco2_product_annual_detrended %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_biome_monthly_regression}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_biome_monthly_regression.csv"),
                    full.names = TRUE)

pco2_product_monthly_regression <-
  read_csv(files,
           id = "product")

pco2_product_monthly_regression <-
  pco2_product_monthly_regression %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_biome_monthly_detrended}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_biome_monthly_detrended.csv"),
                    full.names = TRUE)

pco2_product_monthly_detrended <-
  read_csv(files,
           id = "product")

pco2_product_monthly_detrended <-
  pco2_product_monthly_detrended %>% 
  mutate(product = str_extract(product, "OceanSODA|SOM_FFN|CMEMS|NRT_fco2residual|ETHZ_CESM|FESOM-REcoM"))

```

```{r read_profiles_monthly}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_profiles_monthly.csv"),
                    full.names = TRUE)

pco2_product_profiles_monthly <-
  read_csv(files,
           id = "product")

pco2_product_profiles_monthly <-
  pco2_product_profiles_monthly %>% 
  mutate(product = str_extract(product, "ETHZ_CESM|FESOM-REcoM"))

```

```{r read_profiles_annual}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_profiles_annual.csv"),
                    full.names = TRUE)

pco2_product_profiles_annual <-
  read_csv(files,
           id = "product")

pco2_product_profiles_annual <-
  pco2_product_profiles_annual %>% 
  mutate(product = str_extract(product, "ETHZ_CESM|FESOM-REcoM"))

```

```{r read_zonal_mean_sections_annual}

files <- list.files(here::here("data/"),
                    pattern = paste0({{year_anom}},"_zonal_mean_sections_annual.csv"),
                    full.names = TRUE)

pco2_product_zonal_mean_sections_annual <-
  read_csv(files,
           id = "product")

pco2_product_zonal_mean_sections_annual <-
  pco2_product_zonal_mean_sections_annual %>% 
  mutate(product = str_extract(product, "ETHZ_CESM|FESOM-REcoM"))

```

```{r read_map}

map <-
  read_rds(here::here("data/map.rds"))

key_biomes <-
  read_rds(here::here("data/key_biomes.rds"))


super_biomes <-
  read_rds(here::here("data/super_biomes.rds"))

biome_mask <-
  read_rds(here::here("data/biome_mask.rds"))

biome_mask <-
  bind_rows(
    biome_mask,
    biome_mask %>% mutate(biome = "Global")
  )


```

```{r core_variables_for_analysis}

name_core <- c("fgco2", "fgco2_int", "fgco2_hov",
               "sfco2", "atm_fco2", "dfco2",
               "kw_sol", "temperature", "salinity",
               "dissic", "talk", "sdissic", "stalk", "cstar", 
               "no3", "o2",
               "mld", "thetao", "so",
               "intpp", "chl")


all_product_list <- c("OceanSODA",
                      "SOM_FFN",
                      "NRT_fco2residual",
                      "CMEMS",
                      "ETHZ_CESM",
                      "FESOM-REcoM")

gobm_product_list <- c("ETHZ_CESM",
                       "FESOM-REcoM")


pco2_product_list <- c("OceanSODA",
                      "SOM_FFN",
                      "NRT_fco2residual",
                      "CMEMS"
                      )

color_products <- c(
  "OceanSODA" = "#672933",
  "SOM_FFN" = "#d1495b",
  "NRT_fco2residual" = "#edae49",
  "CMEMS" = "#AD8E55",
  "ETHZ_CESM" = "#66a182",
  "FESOM-REcoM" = "#00798c"
)

warm_color <- "#B84A60FF"
cold_color <- "#16877CFF"

```

```{r order_variable_names}

# pco2_product_annual_regression %>%
#   distinct(product,name) %>%
#   print(n=50)

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly_regression %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly_regression %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))


pco2_product_annual_detrended <- pco2_product_annual_detrended %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_annual_regression <- pco2_product_annual_regression %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))


pco2_product_monthly_detrended <- pco2_product_monthly_detrended %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_monthly_regression <-
  pco2_product_monthly_regression %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_profiles_monthly <-
  pco2_product_profiles_monthly %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_profiles_annual <-
  pco2_product_profiles_annual %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))

pco2_product_zonal_mean_sections_annual <-
  pco2_product_zonal_mean_sections_annual %>%
  mutate(
    name = factor(name, levels = name_core),
    product = factor(product, levels = all_product_list)
  ) %>%
  filter(!is.na(name))


```

# Define labels and breaks

```{r define_labels_and_breaks_OIA_variables_change}

labels_breaks <- function(i_name) {
  
  if (i_name == "dco2") {
    i_legend_title <- "ΔpCO<sub>2</sub><br>(µatm)"
  }
  
  if (i_name == "dfco2") {
    i_legend_title <- "ΔfCO<sub>2</sub><br>(µatm)"
  }
  
  if (i_name == "atm_co2") {
    i_legend_title <- "pCO<sub>2,atm</sub><br>(µatm)"
  }
  
  if (i_name == "atm_fco2") {
    i_legend_title <- "fCO<sub>2,atm</sub><br>(µatm)"
  }
  
  if (i_name == "sol") {
    i_legend_title <- "K<sub>0</sub><br>(mol m<sup>-3</sup> µatm<sup>-1</sup>)"
  }
  
  if (i_name == "kw") {
    i_legend_title <- "k<sub>w</sub><br>(m yr<sup>-1</sup>)"
  }
  
  if (i_name == "kw_sol") {
    i_legend_title <- "k<sub>w</sub> K<sub>0</sub><br>(mol yr<sup>-1</sup> m<sup>-2</sup> µatm<sup>-1</sup>)"
  }
  
  if (i_name == "spco2") {
    i_legend_title <- "pCO<sub>2,ocean</sub><br>(µatm)"
  }
  
  if (i_name == "sfco2") {
    i_legend_title <- "fCO<sub>2,ocean</sub><br>(µatm)"
  }
  
  if (i_name == "intpp") {
    i_legend_title <- "NPP<sub>int</sub><br>(mol s<sup>-1</sup> m<sup>-2</sup>)"
  }

  if (i_name == "no3") {
    i_legend_title <- "NO<sub>3</sub><br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "o2") {
    i_legend_title <- "O<sub>2</sub><br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "dissic") {
    i_legend_title <- "DIC<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "sdissic") {
    i_legend_title <- "sDIC<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "cstar") {
    i_legend_title <- "C*<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "talk") {
    i_legend_title <- "TA<br>(μmol kg<sup>-1</sup>)"
  }

  if (i_name == "stalk") {
    i_legend_title <- "sTA<br>(μmol kg<sup>-1</sup>)"
  }
  
  if (i_name == "sfco2_total") {
    i_legend_title <- "total"
  }
  
  if (i_name == "sfco2_therm") {
    i_legend_title <- "thermal"
  }
  
  if (i_name == "sfco2_nontherm") {
    i_legend_title <- "non-thermal"
  }
  
  if (i_name == "fgco2") {
    i_legend_title <- "FCO<sub>2</sub><br>(mol m<sup>-2</sup> yr<sup>-1</sup>)"
  }
  
  if (i_name == "fgco2_hov") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC deg<sup>-1</sup> yr<sup>-1</sup>)"
  }
  
  if (i_name == "fgco2_int") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC yr<sup>-1</sup>)"
  }
  
  if (i_name == "thetao") {
    i_legend_title <- "Temp.<br>(°C)"
  }
  
  if (i_name == "temperature") {
    i_legend_title <- "SST<br>(°C)"
  }
  
  if (i_name == "salinity") {
    i_legend_title <- "SSS"
  }
  
  if (i_name == "so") {
    i_legend_title <- "Salinity"
  }
  
  if (i_name == "chl") {
    i_legend_title <- "lg(Chl-a)<br>(lg(mg m<sup>-3</sup>))"
  }
  
  if (i_name == "mld") {
    i_legend_title <- "MLD<br>(m)"
  }
  
  if (i_name == "press") {
    i_legend_title <- "pressure<sub>atm</sub><br>(Pa)"
  }
  
  if (i_name == "wind") {
    i_legend_title <- "Wind <br>(m sec<sup>-1</sup>)"
  }
  
  if (i_name == "SSH") {
    i_legend_title <- "SSH <br>(m)"
  }
  
  if (i_name == "fice") {
    i_legend_title <- "Sea ice <br>(%)"
  }
  
    
  if (i_name == "resid_fgco2") {
    i_legend_title <-
      "Observed"
  }
    
  if (i_name == "resid_fgco2_dfco2") {
    i_legend_title <-
      "ΔfCO<sub>2</sub>"
  }
    
  if (i_name == "resid_fgco2_kw_sol") {
    i_legend_title <-
      "k<sub>w</sub> K<sub>0</sub>"
  }
    
  if (i_name == "resid_fgco2_dfco2_kw_sol") {
    i_legend_title <-
      "k<sub>w</sub> K<sub>0</sub> X ΔfCO<sub>2</sub>"
  }
    
  if (i_name == "resid_fgco2_sum") {
    i_legend_title <-
      "∑"
  }
    
  if (i_name == "resid_fgco2_offset") {
    i_legend_title <-
      "Obs. - ∑"
  }
  
  all_labels_breaks <- lst(i_legend_title)
  
  return(all_labels_breaks)
  
}

x_axis_labels <-
  c(
    "dco2" = labels_breaks("dco2")$i_legend_title,
    "dfco2" = labels_breaks("dfco2")$i_legend_title,
    "atm_co2" = labels_breaks("atm_co2")$i_legend_title,
    "atm_fco2" = labels_breaks("atm_fco2")$i_legend_title,
    "sol" = labels_breaks("sol")$i_legend_title,
    "kw" = labels_breaks("kw")$i_legend_title,
    "kw_sol" = labels_breaks("kw_sol")$i_legend_title,
    "intpp" = labels_breaks("intpp")$i_legend_title,
    "no3" = labels_breaks("no3")$i_legend_title,
    "o2" = labels_breaks("o2")$i_legend_title,
    "dissic" = labels_breaks("dissic")$i_legend_title,
    "sdissic" = labels_breaks("sdissic")$i_legend_title,
    "cstar" = labels_breaks("cstar")$i_legend_title,
    "talk" = labels_breaks("talk")$i_legend_title,
    "stalk" = labels_breaks("stalk")$i_legend_title,
    "spco2" = labels_breaks("spco2")$i_legend_title,
    "sfco2" = labels_breaks("sfco2")$i_legend_title,
    "sfco2_total" = labels_breaks("sfco2_total")$i_legend_title,
    "sfco2_therm" = labels_breaks("sfco2_therm")$i_legend_title,
    "sfco2_nontherm" = labels_breaks("sfco2_nontherm")$i_legend_title,
    "fgco2" = labels_breaks("fgco2")$i_legend_title,
    "fgco2_hov" = labels_breaks("fgco2_hov")$i_legend_title,
    "fgco2_int" = labels_breaks("fgco2_int")$i_legend_title,
    "thetao" = labels_breaks("thetao")$i_legend_title,
    "temperature" = labels_breaks("temperature")$i_legend_title,
    "salinity" = labels_breaks("salinity")$i_legend_title,
    "so" = labels_breaks("so")$i_legend_title,
    "chl" = labels_breaks("chl")$i_legend_title,
    "mld" = labels_breaks("mld")$i_legend_title,
    "press" = labels_breaks("press")$i_legend_title,
    "wind" = labels_breaks("wind")$i_legend_title,
    "SSH" = labels_breaks("SSH")$i_legend_title,
    "fice" = labels_breaks("fice")$i_legend_title,
    "resid_fgco2" = labels_breaks("resid_fgco2")$i_legend_title,
    "resid_fgco2_dfco2" = labels_breaks("resid_fgco2_dfco2")$i_legend_title,
    "resid_fgco2_kw_sol" = labels_breaks("resid_fgco2_kw_sol")$i_legend_title,
    "resid_fgco2_dfco2_kw_sol" = labels_breaks("resid_fgco2_dfco2_kw_sol")$i_legend_title,
    "resid_fgco2_sum" = labels_breaks("resid_fgco2_sum")$i_legend_title,
    "resid_fgco2_offset" = labels_breaks("resid_fgco2_offset")$i_legend_title
  )


```

# Functions

## Seasonality plots

```{r seasonality_plot_function}

p_season <- function(df, 
                     dim_row = "name", 
                     dim_col = "product", 
                     title = NULL, 
                     var = "resid",
                     scales = "free_y") {
  
  p <- ggplot(data = df,
              aes(month, !!ensym(var)))
  
  if(var == "resid"){
      p <- p +
        geom_hline(yintercept = 0, linewidth =0.5)
    
  }
  
  
  
  p <- p +
      geom_path(data = . %>% filter(year != {{year_anom}}),
                aes(group = as.factor(year),
                    col = as.factor(paste(min(year), max(year), sep = "-"))), 
                alpha = 0.5)+
      geom_path(data = . %>% 
                  filter(year != {{year_anom}}) %>% 
                  group_by_at(vars(month, dim_col, dim_row)) %>% 
                  summarise(!!ensym(var) := mean(!!ensym(var))),
                aes(col = "Climatological\nmean"), 
                linewidth = 1) +
    scale_color_manual(values = c("grey", "black"),
                       guide = guide_legend(order = 2,
                                            reverse = TRUE)) +
    new_scale_color()+
    geom_path(data = . %>% filter(year == {{year_anom}}),
                aes(col = as.factor(year)),
                linewidth = 1) +
      scale_color_manual(
        values = warm_color,
        guide = guide_legend(order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = title,
           x = "Month")
  
    if(df %>% filter(name == "fgco2") %>% nrow() > 0 & "value" %in% names(df)){
    
    df_sink <- df %>% 
      filter(year == {{year_anom}},
             name == "fgco2")
    
      p <- p +
          geom_point(data = df_sink %>% filter(value < 0),
             aes(shape = "Sink"), fill = "white") +
          geom_point(data = df_sink %>% filter(value >= 0),
             aes(shape = "Source"), fill = "white") +
        scale_shape_manual(values = c(25,24))
    
  }
  
  
  if (!(is.null(dim_col))) {
    p <- p +
      facet_grid(
        as.formula(paste(dim_row, "~", dim_col)),
        scales = scales,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      )
    
    
  } else {
    p <- p +
      facet_grid(
        as.formula(paste(dim_row, "~ .")),
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      )
  }
  
  p <- p +
    theme(
      strip.text.y.left = element_markdown(),
      strip.placement = "outside",
      strip.background.y = element_blank(),
      axis.title.y = element_blank(),
      legend.title = element_blank()
    )
  
  p
  
}
```

## fCO2 decomposition

```{r fCO2_decomposition_function}

fco2_decomposition <- function(df, ...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat, month)
  # group_by <- quos(biome, year, month)
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    df %>%
    filter(name %in% c("temperature", "sfco2"))
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    inner_join(
      pco2_product_biome_monthly_fCO2_decomposition %>%
        filter(name == "temperature") %>%
        select(-c(value, fit)) %>%
        pivot_wider(values_from = resid),
      pco2_product_biome_monthly_fCO2_decomposition %>%
        filter(name == "sfco2") %>%
        select(-c(value, resid)) %>%
        pivot_wider(values_from = fit)
    )
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    mutate(sfco2_therm = (sfco2 * exp(0.0423 * temperature)) - sfco2)
  
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    inner_join(
      pco2_product_biome_monthly_fCO2_decomposition,
      df %>%
        filter(name %in% c("sfco2")) %>%
        select(-c(value, fit, name)) %>%
        rename(sfco2_total = resid)
    )
  
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    mutate(sfco2_nontherm = sfco2_total - sfco2_therm)
  
  pco2_product_biome_monthly_fCO2_decomposition <-
    pco2_product_biome_monthly_fCO2_decomposition %>%
    select(-c(temperature, sfco2)) %>%
    pivot_longer(starts_with("sfco2"),
                 values_to = "resid")
  
}


```

## Flux attribution

```{r flux_attribution_function}

flux_attribution <- function(df, ...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat, month)
  
  pco2_product_flux_attribution <-
    df %>%
    filter(name %in% c("dfco2", "kw_sol", "fgco2"))
  
  
  pco2_product_flux_attribution <-
    inner_join(
      pco2_product_flux_attribution %>%
        select(-c(value, fit)) %>%
        pivot_wider(values_from = resid,
                    names_prefix = "resid_"),
      pco2_product_flux_attribution %>%
        select(-c(value, resid)) %>%
        filter(name != "fgco2") %>%
        pivot_wider(values_from = fit)
    )
  
    pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    mutate(
      resid_fgco2_dfco2 = resid_dfco2 * kw_sol,
      resid_fgco2_kw_sol = resid_kw_sol * dfco2,
      resid_fgco2_dfco2_kw_sol = resid_dfco2 * resid_kw_sol
      # resid_fgco2_sum = resid_fgco2_dfco2 + resid_fgco2_kw_sol + resid_fgco2_dfco2_kw_sol
    )
  
  # pco2_product_flux_attribution <-
  #   pco2_product_flux_attribution %>%
  #   mutate(resid_fgco2_offset = resid_fgco2 - resid_fgco2_sum)
  
  pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    select(product, !!!group_by, starts_with("resid_fgco2")) %>%
    pivot_longer(starts_with("resid_"),
                 values_to = "resid")
  
  
  pco2_product_flux_attribution <-
    pco2_product_flux_attribution %>%
    filter(str_detect(name, "dfco2|kw_sol")) %>% 
    mutate(name = factor(
      name,
      levels = c(
        "resid_fgco2",
        "resid_fgco2_dfco2",
        "resid_fgco2_kw_sol",
        "resid_fgco2_dfco2_kw_sol",
        "resid_fgco2_sum",
        "resid_fgco2_offset"
      )
    ))
  
}

```

# Maps

The following maps show the anomalies of each variable in `r {{year_anom}}` as provided through the pCO2 product. Anomalies are determined based on the predicted value of a linear regression model fit to the available data from 1990 to `r {{year_anom}}-1`.

Maps are first presented as annual means, and than as monthly means. Note that the 2023 predictions for the monthly maps are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

Note: The increase the computational speed, I regridded all maps to 5X5° grid.

## Annual means

### `r {{year_anom}}` anomaly

```{r bivariate_anomaly_year_annual_mean_maps, eval=FALSE}

bivariate_map <- 
pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         name %in% c("fgco2", "temperature")) %>%
  select(product, name, lon, lat, resid) %>% 
  pivot_wider(names_from = name,
              values_from = resid) %>% 
  drop_na()

map +
  geom_tile(data = bivariate_map,
            aes(lon, lat, fill = temperature)) +
  scale_fill_gradientn(
    colours = cmocean("curl")(100),
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("temperature"),
    oob = squish
  ) +
  facet_wrap( ~ product, ncol = 2) +
  theme(legend.title = element_markdown())

map +
  geom_tile(data = bivariate_map,
            aes(lon, lat, fill = fgco2)) +
  scale_fill_gradientn(
    colours = cmocean("curl")(100),
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("fgco2"),
    oob = squish
  ) +
  facet_wrap(~ product, ncol = 2) +
  theme(legend.title = element_markdown())


dim_set <- 4

bivariate_map <-
  bi_class(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile"
  )

bi_breaks <-
  bi_class_breaks(
    bivariate_map,
    x = temperature,
    y = fgco2,
    dim = dim_set,
    style = "quantile",
    dig_lab = 1
  )

map +
  geom_tile(data = bivariate_map,
            aes(lon, lat, fill = bi_class)) +
  bi_scale_fill(pal = "DkViolet2", dim = dim_set) +
  theme(legend.position = "none") +
  facet_wrap(~ product, ncol = 2)


bi_legend(
  pal = "DkViolet2",
  xlab = labels_breaks("temperature")$i_legend_title,
  ylab = labels_breaks("fgco2")$i_legend_title,
  dim = dim_set,
  pad_width = 2,
  breaks = bi_breaks,
  arrows = FALSE
) +
  theme(
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    axis.ticks = element_blank(),
    axis.text = element_text(size = 10)
  )

# cowplot::plot_grid(
#   bi_map, bi_legend,
#   rel_heights = c(5, 3),
#   ncol = 1
# )


```

```{r anomaly_year_annual_mean_maps, fig.asp=1}

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      # labs(title =  paste({{year_anom}}, "anomaly")) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      facet_wrap( ~ product, ncol = 2) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


```

```{r anomaly_year_annual_mean_maps_cesm}

plot_list <- 
pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         product == "ETHZ_CESM",
         name %in% c(
           "fgco2",
           "dfco2",
           "kw_sol",
           "temperature",
           "salinity",
           "sdissic",
           "stalk",
           "no3",
           "mld",
           "intpp",
           "chl"
         )) %>%
  group_split(name) %>% 
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(),
            legend.justification = "left")
  )


ggsave(plot = wrap_plots(plot_list,
                         ncol = 3,
                         byrow = FALSE),
       width = 20,
       height = 9,
       filename = "../output/CESM_2023_surface_anomaly_maps.jpg")

```

```{r anomaly_year_annual_mean_maps_fesom}

plot_list <- 
pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         product == "FESOM-REcoM",
         name %in% c(
           "fgco2",
           "dfco2",
           "kw_sol",
           "temperature",
           "salinity",
           "dissic",
           "talk",
           "no3",
           "mld",
           "intpp",
           "chl"
         )) %>%
  group_split(name) %>% 
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(),
            legend.justification = "left")
  )


ggsave(plot = wrap_plots(plot_list,
                         ncol = 3,
                         byrow = FALSE),
       width = 20,
       height = 9,
       filename = "../output/FESOM_2023_surface_anomaly_maps.jpg")

```

```{r anomaly_annual_mean_maps_ensemble_mean}

pco2_product_coarse_annual_regression_ensemble <-
  pco2_product_coarse_annual_regression %>% 
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_range = max(resid) - min(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n)

pco2_product_coarse_annual_regression_ensemble %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>% filter(abs(resid_mean) < resid_sd),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey", size = 1) +
      labs(title =  paste({{year_anom}}, "pCO2 product ensemble mean anomaly")) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "") +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


```

```{r anomaly_annual_mean_maps_ensemble_mean_gobm, fig.asp=0.5}

pco2_product_coarse_annual_regression_ensemble_gobm <-
  pco2_product_coarse_annual_regression %>% 
  filter(year == {{year_anom}},
         product %in% gobm_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_range = max(resid) - min(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(gobm_product_list)) %>% 
  select(-n)

pco2_product_coarse_annual_regression_ensemble_gobm %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>% filter(abs(resid_mean) < resid_sd),
                aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey", size = 1) +
      labs(title =  paste({{year_anom}}, "GOBM ensemble mean anomaly")) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "") +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


```

```{r anomaly_annual_mean_maps_ensemble_mean_offset, fig.asp=1.5}

pco2_product_coarse_annual_regression_ensemble <-
left_join(
    pco2_product_coarse_annual_regression_ensemble,
    pco2_product_coarse_annual_regression %>% 
      filter(year == {{year_anom}},
             product %in% pco2_product_list)
  ) %>%
  mutate(`Anomaly offset` = resid - resid_mean) %>% 
  select(name, lon, lat, product, `Anomaly offset`)

pco2_product_coarse_annual_regression_ensemble_baseline <-
  pco2_product_coarse_annual_regression %>% 
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    fit_mean = mean(fit),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n)

pco2_product_coarse_annual_regression_ensemble_baseline <-
left_join(
    pco2_product_coarse_annual_regression_ensemble_baseline,
    pco2_product_coarse_annual_regression %>% 
      filter(year == {{year_anom}},
             product %in% pco2_product_list)
  ) %>%
  mutate(`Baseline offset` = fit - fit_mean) %>% 
  select(name, lon, lat, product, `Baseline offset`)

full_join(
  pco2_product_coarse_annual_regression_ensemble,
  pco2_product_coarse_annual_regression_ensemble_baseline
) %>%
  pivot_longer(contains("offset"),
               names_to = "offset") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title =  paste({{year_anom}}, "offset from ensemble mean")) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$value, .01), quantile(.x$value, .99)),
        oob = squish
      ) +
      facet_grid(product ~ offset) +
            guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )


```

## Monthly means

### `r {{year_anom}}` anomaly

```{r anomaly_2023_monthly_mean_maps, fig.asp=1.5}

pco2_product_coarse_monthly_regression %>%
  filter(name %in% name_core,
         year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      # labs(title = paste({{year_anom}}, "anomaly")) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      facet_grid(month ~ product) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

```

### fCO2 decomposition

```{r fCO2_decomposition_monthly_maps, fig.asp=1.8}

pco2_product_coarse_monthly_fCO2_decomposition <-
  fco2_decomposition(pco2_product_coarse_monthly_regression,
                     year, month, lon, lat)


pco2_product_coarse_monthly_fCO2_decomposition %>%
  filter(year == {{year_anom}}) %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(title = .x$product) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

pco2_product_coarse_monthly_fCO2_decomposition %>%
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat, month) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(
        data = .x %>% filter(abs(resid_mean) < resid_sd),
        aes(lon, lat, shape = "Ensemble mean\n< StDev"),
        col = "grey"
      ) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),,
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 46, name = "") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

```

```{r fCO2_decomposition_annual_maps, fig.asp=1.5}

pco2_product_coarse_annual_fCO2_decomposition <-
  pco2_product_coarse_monthly_fCO2_decomposition %>% 
  group_by(product, year, lat, lon, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup()


map +
  geom_tile(data = pco2_product_coarse_annual_fCO2_decomposition %>% 
              filter(year == {{year_anom}}),
            aes(lon, lat, fill = resid)) +
  scale_fill_gradientn(
    colours = cmocean("curl")(100),
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("sfco2"),
    limits = c(quantile(pco2_product_coarse_annual_fCO2_decomposition$resid, .01), 
               quantile(pco2_product_coarse_annual_fCO2_decomposition$resid, .99)),
    oob = squish
  ) +
  facet_grid(product ~ name,
             labeller = labeller(name = x_axis_labels)) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "top")


pco2_product_coarse_annual_fCO2_decomposition %>%
  filter(product %in% pco2_product_list,
         year == {{year_anom}}) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  group_split(product) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(
        data = .x %>% filter(abs(resid_mean) < resid_sd),
        aes(lon, lat, shape = "Ensemble mean\n< StDev"),
        col = "grey",
        size = 1
      ) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("sfco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      scale_shape_manual(values = 20, name = "")+
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_wrap(~ name,
                 labeller = labeller(name = x_axis_labels),
                 ncol = 1) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top")
  )

ggsave(width = 6,
       height = 9,
       dpi = 600,
       filename = "../output/fco2_decomposition_ensemble_mean.jpg")

```

### Flux attribution

```{r flux_attribution_seasonal_maps, fig.asp=1.8}

pco2_product_coarse_monthly_flux_attribution <-
  flux_attribution(pco2_product_coarse_monthly_regression,
                   year, month, lon, lat)

pco2_product_coarse_monthly_flux_attribution %>%
  filter(year == {{year_anom}}) %>% 
  drop_na() %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(subtitle = .x$product) +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid, .01), quantile(.x$resid, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown(), 
            legend.position = "bottom") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(legend.title = element_markdown(),
            legend.position = "top",
            strip.text.x.top = element_markdown())
  )



pco2_product_coarse_monthly_flux_attribution %>%
  filter(year == {{year_anom}}) %>% 
  drop_na() %>% 
  filter(product %in% pco2_product_list) %>%
  group_by(name, lon, lat, month) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  drop_na() %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>% filter(abs(resid_mean) < resid_sd),
                 aes(lon, lat, shape = "Ensemble mean\n< StDev"))+
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      )+
      scale_shape_manual(values = 46, name = "") +
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_grid(month ~ name,
                 labeller = labeller(name = x_axis_labels)) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.title = element_markdown(),
        legend.position = "top",
        strip.text.x.top = element_markdown()
      )
  )



```

```{r flux_attribution_annual_maps, fig.asp=1.8}

pco2_product_coarse_annual_flux_attribution <-
  pco2_product_coarse_monthly_flux_attribution %>% 
  group_by(product, year, lat, lon, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup()

map +
  geom_tile(data = pco2_product_coarse_annual_flux_attribution %>% 
              filter(year == {{year_anom}}),
            aes(lon, lat, fill = resid)) +
  scale_fill_gradientn(
    colours = cmocean("curl")(100),
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("fgco2"),
    limits = c(quantile(pco2_product_coarse_annual_flux_attribution$resid, .01, na.rm = TRUE), 
               quantile(pco2_product_coarse_annual_flux_attribution$resid, .99, na.rm = TRUE)),
    oob = squish
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "bottom") +
  facet_grid(product ~ name,
             labeller = labeller(name = x_axis_labels)) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(
    legend.title = element_markdown(),
    legend.position = "top",
    strip.text.x.top = element_markdown()
  )

pco2_product_coarse_annual_flux_attribution %>%
  filter(year == {{year_anom}},
         product %in% pco2_product_list) %>%
  group_by(name, lon, lat) %>%
  summarize(
    resid_sd = sd(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n == length(pco2_product_list)) %>% 
  select(-n) %>% 
  mutate(product = "Ensemble mean") %>% 
  drop_na() %>% 
  group_split(product) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid_mean)) +
      geom_point(data = .x %>% filter(abs(resid_mean) < resid_sd),
                 aes(lon, lat, shape = "Ensemble mean\n< StDev"),
                col = "grey", size = 1)+
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks("fgco2"),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      )+
      scale_shape_manual(values = 20, name = "") +
      theme(legend.title = element_markdown(),
            legend.position = "bottom") +
      facet_wrap(~ name,
                 labeller = labeller(name = x_axis_labels),
                 ncol = 1) +
      guides(
        fill = guide_colorbar(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.title = element_markdown(),
        legend.position = "top",
        strip.text.x.top = element_markdown()
      )
  )

ggsave(width = 6,
       height = 9,
       dpi = 600,
       filename = "../output/flux_attribution_ensemble_mean.jpg")


```

# Hovmoeller plots

The following Hovmoeller plots show the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Hovmoeller plots are presented as monthly means. Note that the predictions for the monthly Hovmoeller plots are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

## Monthly means

### Anomalies

```{r hovmoeller_monthly_anomalies, fig.asp=1.2}

pco2_product_hovmoeller_monthly_regression %>%
  filter(name %in% name_core) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid,.01),quantile(.x$resid,.99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap(~ product, ncol = 1)
  )



```

```{r hovmoeller_monthly_anomalies_ensemble_mean, fig.asp=0.4}


pco2_product_hovmoeller_monthly_regression_ensemble <-
  pco2_product_hovmoeller_monthly_regression %>% 
  group_by(name, decimal, lat) %>%
  summarize(
    resid_range = max(resid) - min(resid),
    resid_mean = mean(resid),
    n = n()
  ) %>%
  ungroup() %>%
  filter(n > 1)
  

pco2_product_hovmoeller_monthly_regression_ensemble %>%
  mutate(product = "Ensemble mean") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid_mean)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap( ~ product, ncol = 1)
  )


```

```{r hovmoeller_monthly_anomalies_ensemble_mean_offset, fig.asp=0.8}


left_join(
    pco2_product_hovmoeller_monthly_regression_ensemble,
    pco2_product_hovmoeller_monthly_regression
  ) %>%
  mutate(resid_offset = resid - resid_mean) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid_offset)) +
      geom_raster() +
      scale_fill_gradientn(
        colours = cmocean("curl")(100),
        rescaler = ~ scales::rescale_mid(.x, mid = 0),
        name = labels_breaks(.x %>% distinct(name)),
        limits = c(quantile(.x$resid_mean, .01), quantile(.x$resid_mean, .99)),
        oob = squish
      ) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0)+
      labs(title = "Monthly offset from ensemble mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank()) +
      facet_wrap( ~ product, ncol = 1)
  )




```

# Regional means and integrals

The following plots show biome-, super biome- or global- averaged/integrated values of each variable as provided through the pCO2 product, represented here as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Anomalies are presented relative to the predicted annual mean of each year, hence preserving the seasonality.

## Annual anomalies

```{r absolute_integrals_trends, fig.asp=1}

pco2_product_annual_regression_ensemble <-
  pco2_product_annual_regression %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, name, biome) %>%
  summarise(resid_sd = sd(resid),
            resid = mean(resid),
            value = mean(value),
            fit = mean(fit)) %>%
  ungroup()

bind_rows(
  pco2_product_annual_regression_ensemble,
  pco2_product_annual_regression_ensemble %>%
    filter(year == max(year)) %>%
    mutate(year = year + 1) %>%
    select(-c(resid, resid_sd))
) %>%
  filter(name %in% c("fgco2_int", "temperature"),
         biome == "Global") %>%
  ggplot() +
  geom_path(
    data = pco2_product_monthly_regression %>%
      filter(
        product %in% pco2_product_list,
        name %in% c("fgco2_int", "temperature"),
        biome == "Global"
      ) %>%
      group_by(year, month, name, biome) %>%
      summarise(value = mean(value)) %>%
      ungroup(),
    aes(year + month / 12, value),
    col = "grey90"
  ) +
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  geom_step(aes(year, value, col = "Observed")) +
  geom_linerange(aes(
    x = year + 0.5,
    ymin = value - resid_sd,
    ymax = value + resid_sd,
    linetype = "Product SD"
  )) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  scale_linetype(name = "Anomaly uncertainty")+
  guides(
    color = guide_legend(order = 1),
    fill = guide_legend(order = 2),
    linetype = guide_legend(order = 3)
  ) +
  scale_x_continuous(limits = c(1989.5, 2024.5), expand = c(0, 0))+
  facet_grid(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    axis.title = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

ggsave(width = 5,
       height = 6,
       dpi = 600,
       filename = "../output/timeseries_ensemble_mean.jpg")

bind_rows(
  pco2_product_annual_regression,
  pco2_product_annual_regression %>%
    filter(year == max(year)) %>%
    mutate(year = year + 1) %>% 
    select(-c(resid))
) %>% 
  filter(name %in% c("fgco2_int", "temperature"),
         biome == "Global") %>%
  ggplot() +
  geom_path(
    data = pco2_product_monthly_regression %>%
      filter(name %in% c("fgco2_int", "temperature"),
             biome == "Global"),
    aes(year + month / 12, value),
    col = "grey90"
  )+
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  geom_step(aes(year, value, col = "Observed")) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  guides(
    color = guide_legend(order = 1),
    fill = guide_legend(order = 2)
  ) +
  scale_x_continuous(limits = c(1989.5,2024.5), expand = c(0,0),
                     breaks = c(1990,2010)) +
  facet_grid(
    name ~ product,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    axis.title = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

ggsave(width = 15,
       height = 6,
       dpi = 600,
       filename = "../output/timeseries_products.jpg")


bind_rows(
  pco2_product_monthly_regression,
  pco2_product_monthly_regression %>%
    filter(year == max(year),
           month == 12) %>%
    mutate(month = month + 1)
) %>%
  mutate(year = year + month/12) %>% 
  filter(name %in% c("fgco2_int", "temperature"),
         product == "OceanSODA",
         biome == "Global",
         year >= 2010) %>%
  ggplot() +
  geom_rect(
    data = . %>% filter(year != max(year)),
    aes(
      xmin = year,
      xmax = year + 1/12,
      ymin = fit,
      ymax = value,
      fill = as.factor(sign(-resid))
    ),
    alpha = 0.5
  ) +
  geom_step(aes(year, fit, col = "Baseline")) +
  scale_color_manual(values = c("grey40", "grey10"),
                     name = "Annual means") +
  scale_fill_manual(
    values = c(warm_color, cold_color),
    labels = c("positive", "negative"),
    name = "Anomalies"
  ) +
  guides(color = guide_legend(order = 1),
         fill = guide_legend(order = 2))+
  facet_grid(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  coord_cartesian(expand = 0) +
  theme(
    axis.title = element_blank(),
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.position = "top",
    legend.direction = "vertical"
  )

         
```

```{r absolute_integrals}

pco2_product_annual_regression %>%
  filter(year == {{year_anom}},
         name %in% c("fgco2", "fgco2_int", "dfco2",
                     "kw_sol", "temperature",
                     "no3", "mld", "intpp", "chl")) %>%
  mutate(region = case_when(biome == "Global" ~ "Global",
                            biome %in% super_biomes ~ "Super biomes",
                            TRUE ~ "Biomes"),
         region = factor(region, levels = c("Global", "Super biomes", "Biomes"))) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes(biome, value, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(biome, fit, group = product, col = paste0({{year_anom}},"\nlinear\nprediction")),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Absolute") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
            axis.title.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  
```

```{r absolute_anomaly_integrals}

full_join(
  pco2_product_annual_regression %>%
    filter(year != {{year_anom}},
           name %in% name_core) %>%
    group_by(product, name, biome) %>% 
    summarise(resid_sd = sd(resid)) %>% 
    ungroup(),
  pco2_product_annual_regression %>%
    filter(year == {{year_anom}},
           name %in% name_core)) %>%
  mutate(
    region = case_when(
      biome == "Global" ~ "Global",
      biome %in% super_biomes ~ "Super biomes",
      TRUE ~ "Biomes"
    ),
    region = factor(region, levels = c("Global", "Super biomes", "Biomes"))
  ) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes(biome, value - fit, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(biome, resid_sd * sign(value - fit), 
                   group = product, col = paste0("Anomaly SD\nexcl.",{{year_anom}})),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Anomalies") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
            axis.title.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  


```

### Global region definition

```{r absolute_integrals_global_definitions, fig.asp=0.5}

biome_mask_recompute <- 
bind_rows(
  biome_mask %>%
    select(-biome) %>%
    mutate(region = "Global"),
  biome_mask %>%
    filter(biome != "Global",
           !str_detect(biome, "SO")) %>%
    select(-biome) %>%
    mutate(region = "Global excl. SO"),
  biome_mask %>%
    filter(biome != "Global",
           !str_detect(biome, "SO|SA-|SP-|Southern")) %>%
    select(-biome) %>%
    mutate(region = "Global excl. SH"),
  biome_mask %>%
    filter(str_detect(biome, "NA-|NP")) %>%
    select(-biome) %>%
    mutate(region = "N Atl + N Pac"),
  biome_mask %>%
    filter(str_detect(biome, "NA-|SA-|AEQU")) %>%
    select(-biome) %>%
    mutate(region = "Atl"),
  biome_mask %>%
    filter(str_detect(biome, "NA")) %>%
    select(-biome) %>%
    mutate(region = "N Atl")
) %>%
  mutate(region = fct_inorder(region))

biome_mask_recompute <-
  left_join(pco2_product_coarse_annual_regression %>% 
              filter(year == {{year_anom}},
                     name == "fgco2",
                     product %in% pco2_product_list) %>% 
              group_by(lon, lat) %>% 
              summarise(resid = mean(resid)) %>% 
              ungroup(),
            biome_mask_recompute)


map +
  geom_tile(data = biome_mask_recompute,
            aes(lon, lat, fill = resid)) +
  facet_wrap(~ region, ncol = 1) +
  scale_fill_gradientn(
    colours = cmocean("curl")(100),
    rescaler = ~ scales::rescale_mid(.x, mid = 0),
    name = labels_breaks("fgco2"),
    limits = c(
      quantile(biome_mask_recompute$resid, .01),
      quantile(biome_mask_recompute$resid, .99)
    ),
    oob = squish
  ) +
  guides(
    fill = guide_colorbar(
      barheight = unit(0.3, "cm"),
      barwidth = unit(6, "cm"),
      ticks = TRUE,
      ticks.colour = "grey20",
      frame.colour = "grey20",
      label.position = "top",
      direction = "horizontal"
    )
  ) +
  theme(legend.title = element_markdown(),
        legend.position = "top")


pco2_product_annual_regression_recompute <-
  full_join(
    pco2_product_annual_regression,
    biome_mask %>%
      mutate(area = earth_surf(lat, lon)) %>%
      group_by(biome) %>%
      summarise(area = sum(area)) %>%
      ungroup() %>%
      filter(biome != "Global")
  ) %>% 
  pivot_longer(value:resid,
               names_to = "estimate") %>% 
  pivot_wider()

pco2_product_annual_regression_recompute <-
bind_rows(
  pco2_product_annual_regression_recompute %>%
    filter(biome != "Global",
           !(biome %in% super_biomes)) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global"),
  pco2_product_annual_regression_recompute %>%
    filter(biome != "Global",
           !str_detect(biome, "SO"),
           !(biome %in% super_biomes)) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global excl. SO"),
  pco2_product_annual_regression_recompute %>%
    filter(biome != "Global",
           !str_detect(biome, "SO|SA-|SP-|Southern"),
           !(biome %in% super_biomes)) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Global excl. SH"),
  pco2_product_annual_regression_recompute %>%
    filter(str_detect(biome, "NA-|NP")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "N Atl + N Pac"),
  pco2_product_annual_regression_recompute %>%
    filter(str_detect(biome, "NA-|SA-|AEQU")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "Atl"),
  pco2_product_annual_regression_recompute %>%
    filter(str_detect(biome, "NA")) %>%
    select(-biome) %>% 
    group_by(product, estimate, year) %>%
    summarise(across(-c(fgco2_int, area),
                     ~ weighted.mean(., area, na.rm = TRUE)),
              across(fgco2_int,
                     ~ sum(., na.rm = TRUE))) %>%
    ungroup() %>%
    mutate(region = "N Atl")) %>% 
  mutate(region = fct_inorder(region)) %>% 
  pivot_longer(-c(product, year, region, estimate)) %>% 
  pivot_wider(names_from = estimate)

pco2_product_annual_regression_recompute %>% 
  filter(year == {{year_anom}},
         name %in% c("fgco2", "fgco2_int", "dfco2")) %>%    
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_hline(yintercept = 0) +
      geom_col(aes(region, value, fill = product),
                 position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(region, fit, group = product, col = paste0({{year_anom}},"\nlinear\nprediction")),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Absolute") +
      scale_color_grey() +
      facet_grid(.~region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )


full_join(pco2_product_annual_regression_recompute %>%
  group_by(product, name, region) %>%
  summarise(resid_sd = sd(resid, na.rm = TRUE)) %>%
  ungroup(),
pco2_product_annual_regression_recompute %>%  
  filter(year == {{year_anom}})) %>% 
  filter(name %in% c("fgco2",
                     "fgco2_int",
                     "dfco2",
                     "kw_sol",
                     "temperature",
                     "no3",
                     "mld",
                     "intpp",
                     "chl")) %>%    
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_hline(yintercept = 0) +
      geom_col(aes(region, resid, fill = product),
               position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(aes(region, resid_sd * sign(value - fit), 
                   group = product, col = paste0("Anomaly SD\nexcl.",{{year_anom}})),
               position = "dodge2",
               fill = "transparent") +
      labs(y = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Anomaly") +
      scale_color_grey() +
      facet_grid(. ~ region, scales = "free_x", space = "free_x") +
      theme(legend.title = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.y = element_markdown(),
            strip.background = element_blank(),
            legend.position = "top")
  )
  
```

## Seasonal anomalies

### Annual mean trends

```{r anomalies_from_annual_mean_trends_overview_OceanSODA, fig.asp=1}

pco2_product_annual_detrended %>%
  filter(biome %in% "Global",
         name %in% c("fgco2_int", "temperature"),
         product %in% pco2_product_list) %>%
  select(-c(time, product)) %>% 
  group_by(year, month, biome, name) %>% 
  summarise(across(where(is.numeric), mean)) %>% 
  ungroup() %>% 
  # mutate(product = "Ensemble mean") %>% 
  p_season(title = NULL,
           dim_col = NULL) +
  theme(legend.position = "top")

ggsave(width = 5,
       height = 6,
       dpi = 600,
       filename = "../output/seasonality_ensemble_mean.jpg")


```

```{r anomalies_from_annual_mean_trends_overview_pCO2_products}

pco2_product_annual_detrended %>% 
  filter(biome %in% "Global",
         name %in% c("fgco2", "temperature")) %>%
  p_season(title = NULL) +
  theme(legend.position = "top")

ggsave(width = 15,
       height = 6,
       dpi = 600,
       filename = "../output/seasonality_product.jpg")

```

```{r anomalies_from_annual_mean_trends_overview, fig.asp=1.5}

pco2_product_annual_detrended %>% 
  filter(biome %in% "Global",
         name %in% name_core) %>%
  p_season(title = "Anomalies from predicted annual mean | Global")
  
```

```{r anomalies_from_annual_mean_trends_key_biomes, fig.asp=1.5}

pco2_product_annual_detrended %>%
  filter(biome %in% key_biomes,
         name %in% name_core) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(~ p_season(
    df = .x,
    title = paste("Anomalies from predicted annual mean |", .x$biome)
  ))


```

### Monthly mean trends

```{r anomalies_from_monthly_mean_trends_overview, fig.asp=1.5}

pco2_product_monthly_detrended %>% 
  filter(biome %in% "Global",
         name %in% name_core) %>%
  p_season(title = "Anomalies from predicted monthly mean | Global")

```

```{r anomalies_from_monthly_mean_trends_key_biomes_super, fig.asp=1.5}

pco2_product_monthly_detrended %>%
  filter(biome %in% super_biomes,
         name %in% name_core) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(df = .x,
               title = paste("Anomalies from predicted monthly mean |", .x$biome))
  )


```

```{r anomalies_from_monthly_mean_trends_key_biomes, fig.asp=1.5}

pco2_product_monthly_detrended %>%
  filter(biome %in% key_biomes,
         name %in% name_core) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(~ p_season(
    df = .x,
    title = paste("Anomalies from predicted monthly mean |", .x$biome)
  ))


```

# Flux anomaly correlation

The following plots aim to unravel the correlation between biome-, super-biome- or globally- integrated monthly flux anomalies and the corresponding anomalies of the means/integrals of each other variable.

Anomalies are first presented are first presented in absolute units. Due to the different flux magnitudes, we need to plot the globally and biome-integrated fluxes separately. Secondly, we normalize the anomalies to the monthly spread (expressed as standard deviation) of the anomalies from 1990 to 2021.

## Annual anomalies

### Absolute

```{r anomalies_correlation_absolute_annual_global, fig.asp=1}

pco2_product_annual_regression %>%
  filter(biome %in% "Global",
         name %in% name_core) %>%
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, biome, fgco2_int))  %>%
  filter(name == "temperature") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(fill = year),
        shape = 21
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        method = "lm",
        se = FALSE,
        fullrange = TRUE,
        aes(col = paste("Regression fit\nexcl.", {{year_anom}}))
      ) +
      scale_color_grey() +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = warm_color,
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      labs(y = labels_breaks("fgco2_int")$i_legend_title,
           x = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Global Ocean") +
      facet_wrap(
        . ~ product,
        scales = "free_y",
        ncol = 2
      ) +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        legend.title = element_blank()
      )
  )

ggsave(width = 6,
       height = 6,
       dpi = 600,
       filename = "../output/flux_sst_anomaly_correlation_global.jpg")

```

```{r anomalies_correlation_absolute_annual_biome_key, fig.asp=0.8}

pco2_product_annual_regression %>%
  filter(biome %in% key_biomes,
         name %in% name_core) %>%
  select(-c(value, fit)) %>%
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, biome, fgco2_int))  %>%
  filter(name == "temperature") %>% 
  group_split(name) %>%
  # tail(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(fill = year),
        shape = 21
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        method = "lm",
        se = FALSE,
        fullrange = TRUE,
        aes(col = paste("Regression fit\nexcl.", {{year_anom}}))
      ) +
      scale_color_grey() +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = warm_color,
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      labs(y = labels_breaks("fgco2_int")$i_legend_title,
           x = labels_breaks(unique(.x$name))$i_legend_title,
           title = "Key biomes") +
      facet_grid(
        biome ~ product,
        scales = "free_y"
      ) +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        legend.title = element_blank()
      )
  )

ggsave(width = 10,
       height = 8,
       dpi = 600,
       filename = "../output/flux_sst_anomaly_correlation_biome.jpg")

```

## Monthly anomalies

### Absolute

```{r anomalies_correlation_absolute_monthly_global, fig.asp=0.7}


pco2_product_monthly_detrended %>%
  filter(biome == "Global") %>%
  select(-c(time, fit, value)) %>% 
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
      aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill =  as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      labs(
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(unique(.x$name))$i_legend_title
      ) +
      facet_grid(biome ~ product,
                 scales = "free_y") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown()
      )
  )


```

```{r anomalies_correlation_absolute_monthly_biomes_super, fig.asp=0.9}


pco2_product_monthly_detrended %>%
  filter(biome %in% super_biomes) %>%
  select(-c(time, fit, value)) %>% 
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
      aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill =  as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      labs(
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(unique(.x$name))$i_legend_title
      ) +
      facet_grid(biome ~ product,
                 scales = "free_y") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown()
      )
  )


```

```{r anomalies_correlation_absolute_monthly_biomes_key, fig.asp=1.2}


pco2_product_monthly_detrended %>%
  filter(biome %in% key_biomes) %>%
  select(-c(time, fit, value)) %>% 
  pivot_wider(values_from = resid) %>%
  pivot_longer(-c(product, year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
      aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill =  as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      labs(
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(unique(.x$name))$i_legend_title
      ) +
      facet_grid(biome ~ product,
                 scales = "free_y") +
      theme(
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown()
      )
  )


```

## fCO2 decomposition

```{r pCO2_decomposition}

# pco2_product_biome_monthly_fCO2_decomposition <-
#   fco2_decomposition(pco2_product_annual_detrended %>%
#                        select(-c(time)),
#                      biome, year, month)


pco2_product_biome_monthly_fCO2_decomposition <-
  full_join(pco2_product_coarse_monthly_fCO2_decomposition,
            biome_mask,
            relationship = "many-to-many") %>% 
  group_by(product, year, month, biome, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup() %>% 
  drop_na()


pco2_product_biome_annual_fCO2_decomposition <-
  pco2_product_biome_monthly_fCO2_decomposition %>%
  group_by(product, year, biome, name) %>%
  summarise(resid = mean(resid)) %>%
  ungroup()



pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(biome %in% "Global") %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(df = .x,
               title  = paste("Anomalies from predicted monthly mean |", .x$biome))
  )

# pco2_product_biome_monthly_fCO2_decomposition %>%
#   filter(biome %in% super_biomes) %>%
#   group_split(biome) %>%
#   # head(1) %>%
#   map(
#     ~ p_season(df = .x,
#                title  = paste("Anomalies from predicted monthly mean |", .x$biome))
#   )

pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(df = .x,
               title  = paste("Anomalies from predicted monthly mean |", .x$biome))
  )


```

## Flux attribution

### Seasonal

```{r flux_attribution, fig.asp=1}

pco2_product_biome_monthly_flux_attribution <-
  full_join(pco2_product_coarse_monthly_flux_attribution,
            biome_mask,
            relationship = "many-to-many") %>% 
  group_by(product, year, month, biome, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup() %>% 
  drop_na()

pco2_product_biome_monthly_flux_attribution_total <-
  full_join(pco2_product_coarse_monthly_regression %>% 
              filter(name == "fgco2") %>% 
              mutate(name = "resid_fgco2"),
            biome_mask,
            relationship = "many-to-many") %>% 
  group_by(product, year, month, biome, name) %>% 
  summarise(resid = mean(resid, na.rm = TRUE)) %>% 
  ungroup() %>% 
  drop_na()

pco2_product_biome_monthly_flux_attribution <-
  bind_rows(
    pco2_product_biome_monthly_flux_attribution,
    pco2_product_biome_monthly_flux_attribution_total
  )


pco2_product_biome_annual_flux_attribution <-
  pco2_product_biome_monthly_flux_attribution %>%
  group_by(product, year, biome, name) %>%
  summarise(resid = mean(resid)) %>%
  ungroup()


ggplot() +
  geom_hline(yintercept = 0) +
  geom_col(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(year == {{year_anom}},
             biome %in% c("Global", key_biomes),
             product %in% pco2_product_list) %>% 
      group_by(biome, name) %>% 
      summarise(resid = mean(resid)) %>% 
      ungroup(),
    aes("", resid),
    fill = "grey90", col = "grey20"
  ) +
  geom_point(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(year == {{year_anom}},
             biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    shape = 21
  ) +
  scale_fill_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.1)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
             scales = "free_y",
             space = "free_y",
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )


ggplot() +
  geom_hline(yintercept = 0) +
  geom_col(
    data = pco2_product_biome_annual_flux_attribution %>%
      filter(year == {{year_anom}},
             biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    position = position_dodge(width = 1),
    alpha = 0.5, col = "grey30"
  ) +
  geom_point(
    data = pco2_product_biome_monthly_flux_attribution %>%
      filter(year == {{year_anom}},
             biome %in% c("Global", key_biomes)),
    aes("", resid, fill = product),
    position = position_dodge(width = 1),
    shape = 21, alpha = 0.5, col = "grey30"
  ) +
  scale_fill_manual(values = color_products) +
  # scale_color_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.2)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
                          scales = "free_y",
             space = "free_y",
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )

pco2_product_biome_monthly_flux_attribution %>%
  filter(year == {{year_anom}},
         biome %in% c("Global", key_biomes)) %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_path(
    aes(month, resid, col = product)
  ) +
  geom_point(
    aes(month, resid, fill = product),
    shape = 21,
    alpha = 0.5,
    col = "grey30"
  ) +
  scale_fill_manual(values = color_products) +
  scale_color_manual(values = color_products) +
  scale_y_continuous(breaks = seq(-10,10,0.2)) +
  scale_x_continuous(position = "top", breaks = seq(1,12,3)) +
  labs(y = labels_breaks(unique("fgco2"))$i_legend_title) +
  facet_grid(biome ~ name,
             labeller = labeller(name = x_axis_labels),
             scales = "free_y",
             space = "free_y", 
             switch = "x") +
  theme(
    legend.title = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    legend.position = "top"
  )


```

```{r flux_attribution_seasonal}

pco2_product_biome_monthly_flux_attribution %>%
  filter(biome %in% "Global") %>% 
  group_split(biome) %>%
  map(
    ~ p_season(
      df = .x,
      title  = paste("Anomalies from predicted monthly mean |", .x$biome)
    ) +
      facet_grid(
        name ~ product,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )

pco2_product_biome_monthly_flux_attribution %>%
  filter(biome %in% super_biomes) %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(
      df = .x,
      title  = paste("Anomalies from predicted monthly mean |", .x$biome)
    ) +
      facet_grid(
        name ~ product,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )
pco2_product_biome_monthly_flux_attribution %>%
  filter(biome %in% key_biomes) %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ p_season(
      df = .x,
      title  = paste("Anomalies from predicted monthly mean |", .x$biome)
    ) +
      facet_grid(
        name ~ product,
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```

### Annual

```{r flux_attribution_annual, fig.asp=0.5}


pco2_product_biome_annual_flux_attribution <-
full_join(
pco2_product_biome_annual_flux_attribution %>% 
  filter(year == {{year_anom}}) %>% 
  select(-year),
pco2_product_biome_annual_flux_attribution %>% 
  filter(year != {{year_anom}}) %>% 
  group_by(product, biome, name) %>% 
  summarise(resid_mean = mean(abs(resid))) %>% 
  ungroup())

pco2_product_biome_annual_flux_attribution %>%
  filter(biome %in% "Global") %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes("x", resid, fill = product),
               position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(
        aes(
          "x",
          resid_mean * sign(resid),
          group = product,
          col = paste0("Mean\nexcl.",{{year_anom}})
        ),
        position = "dodge2",
        fill = "transparent"
      ) +
      labs(y = labels_breaks(unique("fgco2"))$i_legend_title,
           title = .x$biome) +
      facet_grid(
        .~name,
        labeller = labeller(name = x_axis_labels),
        switch = "x"
      ) +
      scale_color_grey() +
      theme(
        legend.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_markdown(),
        strip.text.x.bottom = element_markdown(),
        strip.placement = "outside",
        strip.background.x = element_blank(),
        legend.position = "top"
      )
  )


pco2_product_biome_annual_flux_attribution %>%
  filter(biome %in% key_biomes) %>% 
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_col(aes("x", resid, fill = product),
               position = "dodge2") +
      scale_fill_manual(values = color_products) +
      geom_col(
        aes(
          "x",
          resid_mean * sign(resid),
          group = product,
          col = paste0("Mean\nexcl.",{{year_anom}})
        ),
        position = "dodge2",
        fill = "transparent"
      ) +
      labs(y = labels_breaks(unique("fgco2"))$i_legend_title,
           title = .x$biome) +
      facet_grid(
        .~name,
        labeller = labeller(name = x_axis_labels),
        switch = "x"
      ) +
      scale_color_grey() +
      theme(
        legend.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_markdown(),
        strip.text.x.bottom = element_markdown(),
        strip.placement = "outside",
        strip.background.x = element_blank(),
        legend.position = "top"
      )
  )


```

## Merged seasonality plots

```{r merged_seasonality_OceanSODA}

pco2_product_monthly_detrended %>% 
  filter(product == "OceanSODA",
         name %in% c("temperature", "fgco2"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Anomalies from predicted monthly mean")

pco2_product_biome_monthly_flux_attribution %>%
  filter(
    product == "OceanSODA",
    name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
    biome %in% key_biomes
  ) %>%
  p_season(dim_col = "biome",
           title = "Main drivers of flux anomaly",
           scales = "fixed")
  

pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(product == "OceanSODA",
         name %in% c("sfco2_nontherm", "sfco2_therm"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Decomposition of fCO2 anomaly",
           scales = "fixed")  
  

```

```{r merged_seasonality_ensemble_mean}

pco2_product_monthly_detrended %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("temperature", "fgco2"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Ensemble mean anomalies from predicted monthly mean")

pco2_product_biome_monthly_flux_attribution %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Ensemble mean drivers of flux anomaly",
           scales = "fixed")


pco2_product_biome_monthly_fCO2_decomposition %>%
  filter(product %in% pco2_product_list) %>%
  group_by(year, month, biome, name) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  filter(name %in% c("sfco2_nontherm", "sfco2_therm"),
         biome %in% key_biomes) %>%
  p_season(dim_col = "biome",
           title = "Ensemble mean decomposition of fCO2 anomaly",
           scales = "fixed")  
  

```

```{r merged_seasonality_all_products}

pco2_product_monthly_detrended %>% 
  filter(year == {{year_anom}},
         name %in% c("temperature", "fgco2"),
         biome %in% key_biomes) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Anomalies from predicted monthly mean") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_biome_monthly_flux_attribution %>%
  filter(year == {{year_anom}},
         name %in% c("resid_fgco2_dfco2", "resid_fgco2_kw_sol"),
         biome %in% key_biomes) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Main drivers of flux anomaly") +
  facet_grid(
    name ~ biome,
    scales = "fixed",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_biome_monthly_fCO2_decomposition %>% 
  filter(year == {{year_anom}},
         name %in% c("sfco2_nontherm", "sfco2_therm"),
         biome %in% key_biomes) %>%
  ggplot(aes(month, resid)) +
  geom_hline(yintercept = 0, linewidth = 0.5) +
  geom_path(aes(col = product)) +
  scale_color_manual(values = color_products) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(x = "Month",
       title = "Decomposition of fCO2 anomaly") +
  facet_grid(
    name ~ biome,
    scales = "fixed",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )


```

# Zonal mean sections

The following analysis is available for GOBMs only.

## Annual means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_zonal_mean_sections_annual}

pco2_product_zonal_mean_sections_annual %>%
  filter(year == {{year_anom}},
         region != "Southern") %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(lat, depth, z = resid)) +
      scale_fill_gradientn(colours = cmocean(name = "curl")(100),
                           rescaler = ~ scales::rescale_mid(.x, mid = 0),
                           super = ScaleDiscretised,
                           name = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      # scale_fill_distiller(type = "div",
      #                      palette = "RdBu",
      #                      rescaler = ~ scales::rescale_mid(.x, mid = 0),
      #                      super = ScaleDiscretised,
      #                      name = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50, 100, 200, 400)) +
      scale_x_continuous(breaks = seq(-100, 100, 20)) +
      coord_cartesian(expand = 0) +
      facet_grid(region ~ product) +
      labs(y = "Depth (m)", x = "Latitude (°N)") +
      guides(
        fill = guide_colorsteps(
          barheight = unit(0.3, "cm"),
          barwidth = unit(6, "cm"),
          ticks = TRUE,
          ticks.colour = "grey20",
          frame.colour = "grey20",
          label.position = "top",
          direction = "horizontal"
        )
      ) +
      theme(
        legend.position = "top",
        legend.title.align = 1,
        legend.box.spacing = unit(0.1, "cm"),
        legend.title = element_markdown(halign = 1,
                                        lineheight = 1.5)
      )
  )

```

# Biome profiles

The following analysis is available for GOBMs only.

## Annual means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_annual, fig.asp=1}

pco2_product_profiles_annual %>%
  filter(biome %in% key_biomes) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_vline(xintercept = 0) +
      geom_path(aes(resid, depth, group = year), col = "grey30", alpha = 0.3) +
      geom_path(data = .x %>% filter(year == {{year_anom}}),
                aes(resid, depth, col = as.factor(year)),
                linewidth = 1) +
      scale_color_brewer(palette = "Set1") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      coord_cartesian(expand = 0) +
      facet_grid2(biome ~ product,
                  scales = "free_x", independent = "x") +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```

## Monthly means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_monthly, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_vline(xintercept = 0) +
      geom_path(aes(resid, depth, col = as.factor(month)),
                linewidth = 1) +
      scale_color_viridis_d(option = "magma", end = .8) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      coord_cartesian(expand = 0) +
      facet_grid2(biome ~ product,
                  scales = "free_x", independent = "x") +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```

```{r {{year_anom}}_anomaly_profiles_monthly_CESM, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "ETHZ_CESM",
         name %in% c(
           "sdissic",
           "stalk",
           "no3",
           "thetao",
           "so"
         )) %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Anomalies from monthly baseline (deseasonalized)")

ggsave(width = 10,
       height = 8,
       dpi = 600,
       filename = "../output/CESM_2023_anomaly_profiles.jpg")

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "ETHZ_CESM") %>%
  arrange(month) %>% 
  group_by(biome, name, depth) %>% 
  mutate(resid = resid - first(resid)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Monthly anomaly evolution relative to January 2023")

ggsave(width = 16,
       height = 8,
       filename = "../output/CESM_2023_anomaly_profiles_change.jpg")



pco2_product_profiles_monthly %>%
  filter(biome %in% "NA-STPS",
         depth == 5,
         product == "ETHZ_CESM",
         name %in% c(
           "dissic",
           "talk",
           "sdissic",
           "stalk",
           "so"
         )) %>%
  filter(month %in% seq(1,12,3)) %>% 
  ggplot(aes(year + month/12, value, col = as.factor(month))) +
  geom_point() +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\nyear")) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~name, scales = "free_y", ncol = 1)


pco2_product_profiles_monthly %>%
  filter(biome %in% "NA-STPS",
         depth == 5,
         product == "ETHZ_CESM",
         name %in% c(
           "dissic",
           "talk",
           "sdissic",
           "stalk",
           "so"
         )) %>%
  filter(month %in% seq(1,12,3)) %>% 
  ggplot(aes(year + month/12, resid, col = as.factor(month))) +
  geom_point() +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\nyear")) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~name, scales = "free_y", ncol = 1)


```

```{r {{year_anom}}_anomaly_profiles_monthly_FESOM, fig.asp=1}

pco2_product_profiles_monthly %>%
  filter(year == {{year_anom}},
         biome %in% key_biomes,
         product == "FESOM-REcoM",
         name %in% c(
           "dissic",
           "talk",
           "no3",
           "thetao",
           "so"
         )) %>% 
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(aes(resid, depth, col = as.factor(month)),
            linewidth = 1) +
  scale_color_viridis_d(option = "magma", end = .8,
                        name = paste("Month of\n", {{year_anom}})) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(50, 100, 200, 400)) +
  coord_cartesian(expand = 0) +
  facet_grid2(
    biome ~ name,
    scales = "free_x",
    independent = "x",
    labeller = labeller(name = x_axis_labels),
    switch = "x"
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.x = element_blank()
  ) +
  labs(y = "Depth (m)",
       title = "Anomalies from monthly baseline (deseasonalized)")

ggsave(width = 10,
       height = 8,
       dpi = 600,
       filename = "../output/FESOM_2023_anomaly_profiles.jpg")

 
# pco2_product_profiles_monthly %>%
#   filter(year == {{year_anom}},
#          biome %in% key_biomes,
#          product == "ETHZ_CESM") %>%
#   arrange(month) %>% 
#   group_by(biome, name, depth) %>% 
#   mutate(resid = resid - first(resid)) %>% 
#   ungroup() %>% 
#   ggplot() +
#   geom_vline(xintercept = 0) +
#   geom_path(aes(resid, depth, col = as.factor(month)),
#             linewidth = 1) +
#   scale_color_viridis_d(option = "magma", end = .8,
#                         name = paste("Month of\n", {{year_anom}})) +
#   scale_y_continuous(trans = trans_reverser("sqrt"),
#                      breaks = c(50, 100, 200, 400)) +
#   coord_cartesian(expand = 0) +
#   facet_grid2(
#     biome ~ name,
#     scales = "free_x",
#     independent = "x",
#     labeller = labeller(name = x_axis_labels),
#     switch = "x"
#   ) +
#   theme(
#     strip.text.x.bottom = element_markdown(),
#     strip.placement = "outside",
#     strip.background.x = element_blank(),
#     axis.title.x = element_blank()
#   ) +
#   labs(y = "Depth (m)",
#        title = "Monthly anomaly evolution relative to January 2023")
# 
# ggsave(width = 16,
#        height = 8,
#        filename = "../output/CESM_2023_anomaly_profiles_change.jpg")
# 



```
