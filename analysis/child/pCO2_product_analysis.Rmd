```{r load_libraries_specific, include = FALSE}

library(ggnewscale)
library(khroma)
library(broom)
library(scico)
library(ggtext)

```

# Analysis settings

```{r analysis_settings}

name_quadratic_fit <- c("atm_co2", "atm_fco2", "spco2", "sfco2")

start_year <- 1990

name_divergent <- c("dco2", "fgco2", "fgco2_hov", "fgco2_int")

```

# Load masks

```{r mask_and_map}

map <-
  read_rds("../data/map.rds")

key_biomes <-
  read_rds("../data/key_biomes.rds")

super_biomes <-
  read_rds("../data/super_biomes.rds")

super_biome_mask <-
  read_rds("../data/super_biome_mask.rds")

biome_mask <-
  read_rds("../data/biome_mask.rds")


```



# Anomaly detection

For the detection of anomalies at any point in time and space, we fit regression models and compare the fitted to the actual value.

We use linear regression models for all parameters, except for `r print(name_quadratic_fit)``, which are approximated with quadratic fits.

The regression models are fitted to data from the period `r print(paste(start_year, "-", {{year_anom}}-1))``, and extrapolated to {{year_anom}}.


```{r anomaly_detection_function_nested}

anomaly_determination <- function(df,...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat)
  # df <- pco2_product_coarse_annual
  
  # Linear regression models
  
  df_lm <-
    df %>%
    filter(year < {{year_anom}},
           !(name %in% name_quadratic_fit)) %>%
    nest(data = -c(name, !!!group_by)) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year, data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_lm_year_anom <-
    full_join(
      df_lm %>%
        unnest(tidied) %>%
        select(name, !!!group_by, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * {{year_anom}}) %>%
        select(name, !!!group_by, fit) %>%
        mutate(year = {{year_anom}}),
      df %>%
        filter(year == {{year_anom}},
               !(name %in% name_quadratic_fit))
    ) %>%
    mutate(resid = value - fit)
  
  
  df_lm <-
    bind_rows(
      df_lm %>%
        unnest(augmented) %>%
        select(name, !!!group_by, year, value, fit = .fitted, resid = .resid),
      df_lm_year_anom
    )
  
  rm(df_lm_year_anom)
  
  # Quadratic regression models
  
  df_quadratic <-
    df %>%
    filter(year < {{year_anom}},
           name %in% name_quadratic_fit) %>%
    nest(data = -c(name, !!!group_by)) %>%
    mutate(
      fit = map(data, ~ lm(value ~ year + I(year ^ 2), data = .x)),
      tidied = map(fit, tidy),
      augmented = map(fit, augment)
    )
  
  
  df_quadratic_year_anom <-
    full_join(
      df_quadratic %>%
        unnest(tidied) %>%
        select(name, !!!group_by, term, estimate) %>%
        pivot_wider(names_from = term,
                    values_from = estimate) %>%
        mutate(fit = `(Intercept)` + year * {{year_anom}} + `I(year^2)` * {{year_anom}} ^ 2) %>%
        select(name, !!!group_by, fit) %>%
        mutate(year = {{year_anom}}),
      df %>%
        filter(year == {{year_anom}},
               name %in% name_quadratic_fit)
    ) %>%
    mutate(resid = value - fit)
  
  
  df_quadratic <-
    bind_rows(
      df_quadratic %>%
        unnest(augmented) %>%
        select(name, !!!group_by, year, value, fit = .fitted, resid = .resid),
      df_quadratic_year_anom
    )
  
  rm(df_quadratic_year_anom)
  
  # Join linear and quadratic regression results
  
  df_regression <-
    bind_rows(df_lm,
              df_quadratic)
  
  rm(df_lm,
     df_quadratic)
  
  
  return(df_regression)
  
}

```


# Define labels and breaks


```{r define_labels_and_breaks_OIA_variables_change}

labels_breaks <- function(i_name) {
  
  if (i_name == "dco2") {
    i_legend_title <- "ΔpCO<sub>2</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "dfco2") {
    i_legend_title <- "ΔfCO<sub>2</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "atm_co2") {
    i_legend_title <- "pCO<sub>2,atm</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "atm_fco2") {
    i_legend_title <- "fCO<sub>2,atm</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "sol") {
    i_legend_title <- "CO<sub>2</sub> solubility<br>(mol m<sup>-3</sup> µatm<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "kw") {
    i_legend_title <- "K<sub>w</sub><br>(m yr<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "spco2") {
    i_legend_title <- "pCO<sub>2,ocean</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "sfco2") {
    i_legend_title <- "fCO<sub>2,ocean</sub><br>(µatm)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "fgco2") {
    i_legend_title <- "FCO<sub>2</sub><br>(mol m<sup>-2</sup> yr<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "fgco2_hov") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC deg<sup>-1</sup> yr<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "fgco2_int") {
    i_legend_title <- "FCO<sub>2</sub><br>(PgC yr<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "temperature") {
    i_legend_title <- "SST<br>(°C)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "salinity") {
    i_legend_title <- "SSS"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "chl") {
    i_legend_title <- "lg(Chl-a)<br>(lg(mg m<sup>-3</sup>))"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "mld") {
    i_legend_title <- "lg(MLD)<br>(lg(m))"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "press") {
    i_legend_title <- "pressure<sub>atm</sub><br>(unit?)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  if (i_name == "wind") {
    i_legend_title <- "Wind <br>(m sec<sup>-1</sup>)"
    # i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    # i_contour_level <- 50
    # i_contour_level_abs <- 2200
  }
  
  all_labels_breaks <- lst(i_legend_title,
                           # i_breaks,
                           # i_contour_level,
                           # i_contour_level_abs
                           )
  
  return(all_labels_breaks)
  
}


# labels_breaks("fgco2")

x_axis_labels <-
  c(
    "dco2" = labels_breaks("dco2")$i_legend_title,
    "dfco2" = labels_breaks("dfco2")$i_legend_title,
    "atm_co2" = labels_breaks("atm_co2")$i_legend_title,
    "sol" = labels_breaks("sol")$i_legend_title,
    "kw" = labels_breaks("kw")$i_legend_title,
    "spco2" = labels_breaks("spco2")$i_legend_title,
    "sfco2" = labels_breaks("sfco2")$i_legend_title,
    "fgco2_hov" = labels_breaks("fgco2_hov")$i_legend_title,
    "fgco2_int" = labels_breaks("fgco2_int")$i_legend_title,
    "temperature" = labels_breaks("temperature")$i_legend_title,
    "salinity" = labels_breaks("salinity")$i_legend_title,
    "chl" = labels_breaks("chl")$i_legend_title,
    "mld" = labels_breaks("mld")$i_legend_title,
    "press" = labels_breaks("press")$i_legend_title,
    "wind" = labels_breaks("wind")$i_legend_title
  )


```

# Preprocessing

```{r temporal_boundaries}

pco2_product <-
  pco2_product %>%
  filter(year >= start_year)

```


```{r biome_mask}

pco2_product <-
  full_join(pco2_product,
            biome_mask)

# set all values outside biome mask to NA

pco2_product <-
  pco2_product %>%
  mutate(across(-c(lat, lon, time, area, year, month, biome), 
                ~ if_else(is.na(biome), NA, .)))

```


# Maps

The following maps show the absolute state of each variable in {{year_anom}} as provided through the pCO2 product, the change in that variable from 1990 to {{year_anom}}, as well es the anomalies in {{year_anom}}. Changes and anomalies are determined based on the predicted value of a linear regression model fit to the data from 1990 to `r {{year_anom}}-1`.

Maps are first presented as annual means, and than as monthly means. Note that the {{year_anom}} predictions for the monthly maps are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

Note: The increase the computational speed, I regridded all maps to 5X5° grid.

```{r compute_coarse_resolution_monthly_maps, fig.asp=0.5}

pco2_product_coarse <-
  m_grid_horizontal_coarse(pco2_product)


pco2_product_coarse <-
  pco2_product_coarse %>%
  select(-c(lon, lat, time, biome)) %>%
  group_by(year, month, lon_grid, lat_grid) %>%
  summarise(across(-area,
                   ~ weighted.mean(., area))) %>%
  ungroup() %>%
  rename(lon = lon_grid, lat = lat_grid)

pco2_product_coarse <-
  pco2_product_coarse %>%
  pivot_longer(-c(year, month, lon, lat)) %>% 
  drop_na() %>%
  pivot_wider()


```


## Annual means

### {{year_anom}} absolute

```{r anomaly_year_annual_mean_maps, fig.asp=0.5}


pco2_product_coarse_annual <-
  pco2_product_coarse %>%
  select(-month) %>% 
  group_by(year, lon, lat) %>%
  summarise(across(where(is.numeric),
                   ~ mean(.))) %>%
  ungroup()

pco2_product_coarse_annual <-
  pco2_product_coarse_annual %>% 
  pivot_longer(-c(year, lon, lat))

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual %>%
  drop_na() %>% 
  anomaly_determination(lon, lat)

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>%
  drop_na()

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         !(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Annual mean", {{year_anom}})) +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown())
  )

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         name %in% name_divergent) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = paste("Annual mean", {{year_anom}})) +
         scale_fill_divergent(
           name = labels_breaks(.x %>% distinct(name))) +
         theme(legend.title = element_markdown())
  )
  
```

### Trends

```{r change_1990_annomaly_year_annual_mean_maps, fig.asp=0.5}


pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>%
  group_by(name) %>%
  filter(year %in% c(min(year), max(year))) %>%
  ungroup()

pco2_product_coarse_annual_regression %>%
  select(-c(value, resid)) %>%
  arrange(year) %>%
  group_by(lon, lat, name) %>%
  mutate(change = fit - lag(fit),
         period = paste(lag(year), year, sep = "-")) %>%
  ungroup() %>%
  filter(!is.na(change)) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = change)) +
      labs(title =  paste("Change: ",.x$period)) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown())
  )

```

### {{year_anom}} anomaly

```{r anomaly_anomaly_year_annual_mean_maps, fig.asp=0.5}

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = resid)) +
         labs(title =  paste({{year_anom}},"anomaly")) +
         scale_fill_divergent(
           name = labels_breaks(.x %>% distinct(name))) +
         theme(legend.title = element_markdown())
  )

```


```{r write_anomaly_anomaly_year_annual_mean_maps}

pco2_product_coarse_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_map_annual.csv"))

```




## Monthly means

### {{year_anom}} absolute

```{r anomaly_year_monthly_mean_maps, fig.asp=1.8}

pco2_product_coarse_monthly <-
  pco2_product_coarse %>%
  group_by(year, month, lon, lat) %>%
  summarise(across(where(is.numeric),
                   ~ mean(.))) %>%
  ungroup()

pco2_product_coarse_monthly <-
  pco2_product_coarse_monthly %>% 
  pivot_longer(-c(year, month, lon, lat))

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly %>%
  drop_na() %>% 
  anomaly_determination(lon, lat, month)

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly_regression %>% 
  drop_na()


pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}},
         !(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Monthly means", {{year_anom}})) +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )

pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}},
         name %in% name_divergent) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Monthly means", {{year_anom}})) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )
  
```

### Trends

```{r change_1990_anomaly_year_monthly_mean_maps, fig.asp=1.8}

pco2_product_coarse_monthly_regression %>%
  group_by(name) %>%
  filter(year %in% c(min(year), max(year))) %>%
  ungroup() %>%
  select(-c(value, resid)) %>%
  arrange(year) %>%
  group_by(lon, lat, name, month) %>%
  mutate(change = fit - lag(fit),
         period = paste(lag(year), year, sep = "-")) %>%
  ungroup() %>%
  filter(!is.na(change)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = change)) +
      labs(title =  paste("Change: ", .x$period)) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap(~ month, ncol = 2)
  )

```

### {{year_anom}} anomaly

```{r anomaly_anomaly_year_monthly_mean_maps, fig.asp=1.8}

pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(title = paste({{year_anom}}, "anomaly")) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )

```


```{r write_anomaly_anomaly_year_monthly_mean_maps}

pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}}) %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_map_monthly.csv"))

```



# Hovmoeller plots


The following Hovmoeller plots show the value of each variable as provided through the pCO2 product, as well as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Hovmoeller plots are first presented as annual means, and than as monthly means. Note that the predictions for the monthly Hovmoeller plots are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.


## Annual means

### Absolute

```{r hovmoeller_annual_absolute, fig.asp=0.5}

pco2_product_hovmoeller_monthly_annual <-
  pco2_product %>%
  select(-c(lon, time, month, biome)) %>%
  group_by(year, lat) %>%
  summarise(across(-c(fgco2, area),
                   ~ weighted.mean(., area, na.rm = TRUE)),
            across(fgco2,
                   ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>%
  ungroup() %>%
  rename(fgco2_hov = fgco2) %>% 
  filter(fgco2_hov != 0)

pco2_product_hovmoeller_monthly_annual <-
  pco2_product_hovmoeller_monthly_annual %>%
  pivot_longer(-c(year, lat)) %>% 
  drop_na()

pco2_product_hovmoeller_monthly_annual %>%
  filter(!(name %in% name_divergent)) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, lat, fill = value)) +
      geom_raster() +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Annual means",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )

pco2_product_hovmoeller_monthly_annual %>%
  filter(name %in% name_divergent) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, lat, fill = value)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Annual means",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )


```

### Anomalies


```{r hovmoeller_annual_anomaly, fig.asp=0.5}

pco2_product_hovmoeller_monthly_annual_regression <-
  pco2_product_hovmoeller_monthly_annual %>%
  anomaly_determination(lat) %>% 
  filter(!is.na(resid))

  
pco2_product_hovmoeller_monthly_annual_regression %>%
  # filter(name == "mld") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Annual mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )


```


## Monthly means

### Absolute

```{r hovmoeller_monthly_absolute, fig.asp=0.5}

pco2_product_hovmoeller_monthly <-
  pco2_product %>%
  select(-c(lon, time, biome)) %>%
  group_by(year, month, lat) %>%
  summarise(across(-c(fgco2, area),
                   ~ weighted.mean(., area, na.rm = TRUE)),
            across(fgco2,
                   ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>%
  ungroup() %>%
  rename(fgco2_hov = fgco2) %>% 
  filter(fgco2_hov != 0)


pco2_product_hovmoeller_monthly <-
  pco2_product_hovmoeller_monthly %>%
  pivot_longer(-c(year, month, lat)) %>% 
  drop_na()

pco2_product_hovmoeller_monthly <-
  pco2_product_hovmoeller_monthly %>% 
  mutate(decimal = year + (month-1) / 12)

pco2_product_hovmoeller_monthly %>%
  filter(!(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = value)) +
      geom_raster() +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      labs(title = "Monthly means",
           y = "Latitude") +
      coord_cartesian(expand = 0) +
      theme(axis.title.x = element_blank())
  )

pco2_product_hovmoeller_monthly %>%
  filter(name %in% name_divergent) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = value)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      labs(title = "Monthly means",
           y = "Latitude") +
      coord_cartesian(expand = 0) +
      theme(axis.title.x = element_blank())
  )


```

### Anomalies

```{r hovmoeller_monthly_anomalies, fig.asp=0.5}

pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly %>%
  select(-c(decimal)) %>% 
  anomaly_determination(lat, month) %>% 
  filter(!is.na(resid))

  
pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly_regression %>%
  mutate(decimal = year + (month - 1) / 12)
  
pco2_product_hovmoeller_monthly_regression %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )
  



```

```{r write_hovmoeller_monthly_anomalies}

pco2_product_hovmoeller_monthly_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_hovmoeller_monthly.csv"))

```



### Anomalies since 2021

```{r hovmoeller_monthly_anomalies_recent_years, fig.asp=0.5}

pco2_product_hovmoeller_monthly_regression %>%
  filter(year >= 2021) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )

```


# Regional means and integrals

The following plots show biome- or global- averaged/integrated values of each variable as provided through the pCO2 product, as well as the anomalies from the prediction of a linear/quadratic fit to the data from 1990 to `r {{year_anom}}-1`.

Anomalies are first presented relative to the predicted annual mean of each year, hence preserving the seasonality. Furthermore, anomalies are presented relative to the predicted monthly mean values, such that the mean seasonality is removed.


```{r compute_global_means_and_integrals}

pco2_product_monthly_global <-
  pco2_product %>%
  filter(!is.na(fgco2)) %>% 
  select(-c(lon, lat, year, month, biome)) %>% 
  group_by(time) %>%
  summarise(across(-c(fgco2, area),
                   ~ weighted.mean(., area, na.rm = TRUE)),
            across(fgco2,
                   ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>%
  ungroup()

pco2_product_monthly_biome <-
  pco2_product %>%
  filter(!is.na(fgco2)) %>% 
  select(-c(lon, lat, year, month)) %>% 
  group_by(time, biome) %>%
  summarise(across(-c(fgco2, area),
                   ~ weighted.mean(., area, na.rm = TRUE)),
            across(fgco2,
                   ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>%
  ungroup()

pco2_product_monthly_biome_super <-
  pco2_product %>%
  filter(!is.na(fgco2)) %>% 
  mutate(
    biome = case_when(
      str_detect(biome, "NA-") ~ "North Atlantic",
      str_detect(biome, "NP-") ~ "North Pacific",
      str_detect(biome, "SO-") ~ "Southern Ocean",
      TRUE ~ "other"
    )
  ) %>%
  filter(biome != "other") %>%
  select(-c(lon, lat, year, month)) %>%
  group_by(time, biome) %>%
  summarise(across(-c(fgco2, area),
                   ~ weighted.mean(., area, na.rm = TRUE)),
            across(fgco2,
                   ~ sum(. * area, na.rm = TRUE) * 12.01 * 1e-15)) %>%
  ungroup()

pco2_product_monthly <-
  bind_rows(pco2_product_monthly_global %>%
              mutate(biome = "Global"),
            pco2_product_monthly_biome,
            pco2_product_monthly_biome_super)

rm(
  pco2_product_monthly_global,
  pco2_product_monthly_biome,
  pco2_product_monthly_biome_super
)


pco2_product_monthly <-
  pco2_product_monthly %>% 
  filter(!is.na(biome))

pco2_product_monthly <-
  pco2_product_monthly %>%
  rename(fgco2_int = fgco2)

pco2_product_monthly <-
  pco2_product_monthly %>%
  mutate(year = year(time),
         month = month(time),
         .after = time)

pco2_product_monthly <-
  pco2_product_monthly %>%
  pivot_longer(-c(time, year, month, biome))


```


## Absolute values

### Overview

```{r figure_height}

fig.height <- pco2_product_monthly %>% 
  distinct(name) %>% 
  nrow()

fig.height <- (fig.height + 2) * 0.1

```



```{r absolute_global_means_and_integrals_overview, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% "Global") %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```

```{r absolute_biome_means_and_integrals_overview_biomes, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```

```{r absolute_biome_means_and_integrals_overview_biomes_super, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```


### Selected biomes

```{r absolute_global_means_and_integrals_key_biomes, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = paste("Absolute values |", .x$biome)) +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )
  )

```

### Super biomes

```{r absolute_global_means_and_integrals_key_biomes_super, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = paste("Absolute values |", .x$biome)) +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )
  )

```

## Anomalies

### Annual mean trends

```{r annual_mean_trends, fig.asp=fig.height}

pco2_product_annual <-
  pco2_product_monthly %>%
  group_by(year, biome, name) %>%
  summarise(value = mean(value)) %>%
  ungroup()
  
pco2_product_annual %>% 
  filter(biome %in% "Global",
         year <= {{year_anom}}) %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point() +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nprior", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )
  

pco2_product_annual %>% 
  filter(biome %in% key_biomes,
         year <= {{year_anom}}) %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point(size = 0.2) +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nprior", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_annual %>% 
  filter(biome %in% super_biomes,
         year <= {{year_anom}}) %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point(size = 0.2) +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nprior", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_annual_regression <-
  pco2_product_annual %>%
  anomaly_determination(biome)
  

pco2_product_annual_regression %>%
  filter(biome %in% "Global") %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(year < {{year_anom}}-1),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )
  

pco2_product_annual_regression %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(year < {{year_anom}}-1),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_regression %>%
  filter(biome %in% super_biomes) %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(year < {{year_anom}}-1),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_regression %>%
  filter(biome != "global") %>%
  ggplot(aes(biome, resid)) +
  geom_hline(yintercept = 0) +
  geom_jitter(data = . %>% filter(year < {{year_anom}}-1),
             aes(fill = year),
             shape = 21, width = 0.2) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | All biomes") +
  facet_grid(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )


```


```{r write_biome_annual_regression}

pco2_product_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_annual_regression.csv"))

```



```{r anomalies_from_annual_mean_trends_overview, fig.asp=fig.height}


pco2_product_annual_detrended <-
  full_join(pco2_product_monthly,
            pco2_product_annual_regression %>% select(-c(value, resid))) %>%
  mutate(resid = value - fit)

pco2_product_annual_detrended %>% 
  filter(biome %in% "Global") %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )

pco2_product_annual_detrended %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )

```


```{r anomalies_from_annual_mean_trends_key_biomes, fig.asp=fig.height}

pco2_product_annual_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted annual mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```


```{r anomalies_from_annual_mean_trends_key_biomes_super, fig.asp=fig.height}

pco2_product_annual_detrended %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted annual mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```



```{r write_biome_annual_detrended}

pco2_product_annual_detrended %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_annual_detrended.csv"))

```



### Monthly mean trends

```{r monthly_mean_trends, fig.asp=fig.height}

pco2_product_monthly %>% 
  filter(biome %in% "Global",
         year <= {{year_anom}}) %>%
  mutate(month = as.factor(month)) %>% 
  ggplot(aes(year, value, col = month)) +
  # geom_point() +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              se = FALSE,
              fullrange = TRUE) +
  geom_smooth(
    data = . %>% filter(year < {{year_anom}},
                        name %in% name_quadratic_fit),
    method = "lm",
    fullrange = TRUE,
    formula = y ~ x + I(x ^ 2),
    se = FALSE
  ) +
  scale_color_scico_d(palette = "romaO", 
    name = paste("Regression fit\n prior", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Monthly mean trends | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_monthly %>% 
  filter(biome %in% key_biomes,
         year <= {{year_anom}}) %>%
  mutate(month = as.factor(month)) %>% 
  ggplot(aes(year, value, col = month)) +
  # geom_point() +
  geom_smooth(data = . %>% filter(year < {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              se = FALSE) +
  geom_smooth(
    data = . %>% filter(year < {{year_anom}},
                        name %in% name_quadratic_fit),
    method = "lm",
    fullrange = TRUE,
    formula = y ~ x + I(x ^ 2),
    se = FALSE
  ) +
  scale_color_scico_d(palette = "romaO",
    name = paste("Regression fit\n prior", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Monthly mean trends | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_monthly_regression <-
  pco2_product_monthly %>%
  anomaly_determination(biome, month)


pco2_product_monthly_regression %>%
  filter(biome %in% "Global") %>%
  group_split(month) %>%
  head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, resid)) +
      geom_hline(yintercept = 0) +
      geom_path() +
      geom_point(
        data = . %>% filter(year < {{year_anom}}-1),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1980, 2020, 20)) +
      labs(title = "Residual from fit to monthly means (actual - predicted) | Global",
           subtitle = paste("Month:", .x$month)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )

pco2_product_monthly_regression %>%
  filter(biome %in% key_biomes) %>%
  group_split(month) %>%
  head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, resid)) +
      geom_hline(yintercept = 0) +
      geom_path() +
      geom_point(
        data = . %>% filter(year < {{year_anom}}-1),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1980, 2020, 20)) +
      labs(title = "Residual from fit to monthly means (actual - predicted) | Selected biomes",
           subtitle = paste("Month:", .x$month)) +
      facet_grid(
        name ~ biome,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```


```{r anomalies_from_monthly_mean_trends_overview, fig.asp=fig.height}


pco2_product_monthly_detrended <-
  full_join(pco2_product_monthly,
            pco2_product_monthly_regression %>% select(-c(value, resid, time))) %>%
  mutate(resid = value - fit)

pco2_product_monthly_detrended %>% 
  filter(biome %in% "Global") %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Global") +
  facet_wrap(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    strip.position = "left",
    ncol = 2
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_monthly_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_monthly_detrended %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(year < {{year_anom}}-1),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected super biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

```


```{r anomalies_from_monthly_mean_trends_key_biomes, fig.asp=fig.height}

pco2_product_monthly_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted monthly mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```

```{r anomalies_from_monthly_mean_trends_key_biomes_super, fig.asp=fig.height}

pco2_product_monthly_detrended %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(year < {{year_anom}}-1),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted monthly mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```

# Flux anomaly correlation


The following plots aim to unravel the correlation between biome- or globally- integrated monthly flux anomalies and the corresponding anomalies of the means/integrals of each other variable.

Anomalies are first presented are first presented in absolute units. Due to the different flux magnitudes, we need to plot the globally and biome-integrated fluxes separately. Secondly, we normalize the anomalies to the monthly spread (expressed as standard deviation) of the anomalies from 1990 to `r {{year_anom}}-1`.

## Annual anomalies

### Absolute

```{r anomalies_correlation_absolute_global_annual, fig.asp=fig.height}

pco2_product_annual_regression %>%
  filter(biome == "Global") %>%
  select(-c(value, fit)) %>% 
  pivot_wider(values_from = resid) %>% 
  pivot_longer(-c(year, biome, fgco2_int))  %>%
  ggplot(aes(value, fgco2_int)) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(year < {{year_anom}}),
             aes(fill = year),
             shape = 21) +
  geom_smooth(
    data = . %>% filter(year < {{year_anom}}),
    method = "lm",
    se = FALSE,
    fullrange = TRUE,
    aes(col = paste("Regression fit\n prior", {{year_anom}}))
  ) +
  scale_color_grey() +
  scale_fill_grayC()+
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  labs(title = "Globally integrated fluxes",
       y = labels_breaks("fgco2_int")$i_legend_title) +
  facet_wrap(
    ~ name,
    scales = "free_x",
    labeller = labeller(name = x_axis_labels),
    strip.position = "bottom",
    ncol = 2
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.y = element_markdown(),
    axis.title.x = element_blank(),
    legend.title = element_blank()
  )


```

## Monthly anomalies

### Absolute

```{r anomalies_correlation_absolute_global_monthly, fig.asp=fig.height}


pco2_product_monthly_detrended_anomaly <-
  pco2_product_monthly_detrended %>%
  select(year, month, biome, name, resid) %>%
  pivot_wider(names_from = name,
              values_from = resid)


pco2_product_monthly_detrended_anomaly %>%
  filter(biome == "Global") %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  ggplot(aes(value, fgco2_int)) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(year < {{year_anom}}),
             aes(col = paste(min(year), max(year), sep = "-")),
             alpha = 0.2) +
  geom_smooth(
    data = . %>% filter(year < {{year_anom}}),
    aes(col = paste(min(year), max(year), sep = "-")),
    method = "lm",
    se = FALSE,
    fullrange = TRUE
  )  +
  scale_color_grey(name = "") +
  new_scale_color() +
  geom_path(data = . %>% filter(year > {{year_anom}}-1),
            aes(col = as.factor(month), group = 1))  +
  geom_point(data = . %>% filter(year > {{year_anom}}-1),
             aes(fill =  as.factor(month)),
             shape = 21,
             size = 3)  +
  scale_color_scico_d(palette = "buda",
                     guide = guide_legend(reverse = TRUE,
                                          order = 1),
                     name = paste("Month\nof", {{year_anom}})) +
  scale_fill_scico_d(palette = "buda",
                     guide = guide_legend(reverse = TRUE,
                                          order = 1),
                     name = paste("Month\nof", {{year_anom}})) +
  labs(title = "Globally integrated fluxes",
       y = labels_breaks("fgco2_int")$i_legend_title) +
  facet_wrap(
    ~ name,
    scales = "free_x",
    labeller = labeller(name = x_axis_labels),
    strip.position = "bottom",
    ncol = 2
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.y = element_markdown(),
    axis.title.x = element_blank()
  )


```

```{r anomalies_correlation_absolute_biome_monthly, fig.asp=1.8}

pco2_product_monthly_detrended_anomaly %>%
  filter(!(biome %in% c(super_biomes, "Global"))) %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year > {{year_anom}}-1),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year > {{year_anom}}-1),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3, scales = "free") +
      labs(
        title = "Biome integrated fluxes",
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(.x %>% distinct(name))$i_legend_title
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```

```{r anomalies_correlation_absolute_super_biome_monthly, fig.asp=0.5}

pco2_product_monthly_detrended_anomaly %>%
  filter(biome %in% super_biomes) %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year > {{year_anom}}-1),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year > {{year_anom}}-1),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3, scales = "free_x") +
      labs(
        title = "Super biome integrated fluxes",
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(.x %>% distinct(name))$i_legend_title
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```


```{r write_biome_monthly_detrended_anomaly}

pco2_product_monthly_detrended_anomaly %>%
  pivot_longer(-c(month, biome, year)) %>%
  write_csv(paste0(
    "../data/",
    "{{product_name}}","_","{{year_anom}}",
    "_biome_monthly_detrended_anomaly.csv"
  ))

```


### Relative to spread

```{r anomalies_correlation_realtive_to_spread_monthly, fig.asp=2}


pco2_product_monthly_detrended_anomaly_spread <-
  pco2_product_monthly_detrended_anomaly %>%
  pivot_longer(-c(month, biome, year)) %>%
  filter(year < {{year_anom}}) %>%
  group_by(month, biome, name) %>%
  summarise(spread = sd(value, na.rm = TRUE)) %>%
  ungroup()



pco2_product_monthly_detrended_anomaly_relative <-
  full_join(
    pco2_product_monthly_detrended_anomaly_spread,
    pco2_product_monthly_detrended_anomaly %>%
      pivot_longer(-c(month, biome, year))
  )

pco2_product_monthly_detrended_anomaly_relative <-
  pco2_product_monthly_detrended_anomaly_relative %>%
  mutate(value = value / spread) %>%
  select(-spread) %>%
  pivot_wider() %>%
  pivot_longer(-c(month, biome, year, fgco2_int))



pco2_product_monthly_detrended_anomaly_relative %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_vline(xintercept = 0) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year < {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year > {{year_anom}}-1),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year > {{year_anom}}-1),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3) +
      coord_fixed() +
      labs(
        title = "Biome integrated fluxes normalized to spread",
        y = str_split_i(labels_breaks("fgco2_int")$i_legend_title, "<br>", i = 1),
        x = str_split_i(labels_breaks(.x %>% distinct(name))$i_legend_title, "<br>", i = 1)
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```


