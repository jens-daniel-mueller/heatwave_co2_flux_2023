# {{year_anom}} anomalies

## Detection

For the detection of anomalies at any point in time and space, we fit regression models and compare the fitted to the actual value.

We use linear regression models for all parameters, except for `r print(name_quadratic_fit)`, which are approximated with quadratic fits.

The regression models are fitted to all data since `r print(paste(start_year))`, except {{year_anom}}.


```{r anomaly_detection_regression}

anomaly_determination <- function(df,...) {
  
  group_by <- quos(...)
  # group_by <- quos(lon, lat)
  # df <- pco2_product_coarse_annual
  
  # Linear regression models

  df_lm <-
    df %>%
    filter(year != {{year_anom}},
           !(name %in% name_quadratic_fit)) %>%
    drop_na() %>%
    nest(data = -c(name, !!!group_by)) %>%
    mutate(fit = map(data, ~ flm(
      formula = value ~ year, data = .x
    )))
  
  df_lm <-
    left_join(
      df_lm %>%
        unnest_wider(fit) %>%
        select(name, !!!group_by,
               intercept = `(Intercept)`,  slope = year) %>%
        mutate(intercept = as.vector(intercept),
               slope = as.vector(slope)),
      df
    ) %>%
    mutate(fit = intercept + year * slope) %>%
    select(name, !!!group_by, year, fit, value) %>%
    mutate(resid = value - fit)

  # df_lm <-
  #   df %>%
  #   filter(year != {{year_anom}},
  #          !(name %in% name_quadratic_fit)) %>%
  #   drop_na() %>% 
  #   nest(data = -c(name, !!!group_by)) %>%
  #   mutate(
  #     fit = map(data, ~ lm(value ~ year, data = .x)),
  #     tidied = map(fit, tidy),
  #     augmented = map(fit, augment)
  #   )
  # 
  # 
  # df_lm_year_anom <-
  #   full_join(
  #     df_lm %>%
  #       unnest(tidied) %>%
  #       select(name, !!!group_by, term, estimate) %>%
  #       pivot_wider(names_from = term,
  #                   values_from = estimate) %>%
  #       mutate(fit = `(Intercept)` + year * {{year_anom}}) %>%
  #       select(name, !!!group_by, fit) %>%
  #       mutate(year = {{year_anom}}),
  #     df %>%
  #       filter(year == {{year_anom}},
  #              !(name %in% name_quadratic_fit))
  #   ) %>%
  #   mutate(resid = value - fit)
  # 
  # 
  # df_lm <-
  #   bind_rows(
  #     df_lm %>%
  #       unnest(augmented) %>%
  #       select(name, !!!group_by, year, value, fit = .fitted, resid = .resid),
  #     df_lm_year_anom
  #   )
  # 
  # rm(df_lm_year_anom)
  
  # Quadratic regression models
  
  if(any(df %>% distinct(name) %>% pull() %in% name_quadratic_fit)){
  
  df_quadratic <-
    df %>%
    filter(year != {{year_anom}},
           name %in% name_quadratic_fit) %>%
    drop_na() %>% 
    nest(data = -c(name, !!!group_by)) %>%
    mutate(
      fit = map(data, ~ flm(
        formula = value ~ year + I(year ^ 2), data = .x))
    )
  
  df_quadratic <-
    left_join(
      df_quadratic %>%
        unnest_wider(fit) %>%
        select(name, !!!group_by,
               intercept = `(Intercept)`, slope = year, slope_squared = `I(year^2)`) %>%
        mutate(intercept = as.vector(intercept),
               slope = as.vector(slope),
               slope_squared = as.vector(slope_squared)),
      df
    ) %>%
    mutate(fit = intercept + year * slope + year^2 * slope_squared) %>%
    select(name, !!!group_by, year, fit, value) %>%
    mutate(resid = value - fit)
  
  
  # df_quadratic <-
  #   df %>%
  #   filter(year != {{year_anom}},
  #          name %in% name_quadratic_fit) %>%
  #   nest(data = -c(name, !!!group_by)) %>%
  #   mutate(
  #     fit = map(data, ~ lm(value ~ year + I(year ^ 2), data = .x)),
  #     tidied = map(fit, tidy),
  #     augmented = map(fit, augment)
  #   )
  # 
  # df_quadratic_year_anom <-
  #   full_join(
  #     df_quadratic %>%
  #       unnest(tidied) %>%
  #       select(name, !!!group_by, term, estimate) %>%
  #       pivot_wider(names_from = term,
  #                   values_from = estimate) %>%
  #       mutate(fit = `(Intercept)` + year * {{year_anom}} + `I(year^2)` * {{year_anom}} ^ 2) %>%
  #       select(name, !!!group_by, fit) %>%
  #       mutate(year = {{year_anom}}),
  #     df %>%
  #       filter(year == {{year_anom}},
  #              name %in% name_quadratic_fit)
  #   ) %>%
  #   mutate(resid = value - fit)
  # 
  # 
  # df_quadratic <-
  #   bind_rows(
  #     df_quadratic %>%
  #       unnest(augmented) %>%
  #       select(name, !!!group_by, year, value, fit = .fitted, resid = .resid),
  #     df_quadratic_year_anom
  #   )
  # 
  # rm(df_quadratic_year_anom)
  
  # Join linear and quadratic regression results
  
  df_regression <-
    bind_rows(df_lm,
              df_quadratic)
  
  rm(df_lm,
     df_quadratic)
  
  } else{
    
    df_regression <- df_lm
    
    rm(df_lm)
  }
  
  df_regression <-
    df_regression %>%
    arrange(year)
  
  
  return(df_regression)
  
}

```

```{r anomaly_detection_recent_climatology, eval=FALSE}

anomaly_determination <- function(df,...) {
  
  group_by <- quos(...)
  # group_by <- quos(biome)
  # group_by <- quos(lon, lat)
  # df <- pco2_product_coarse_annual
  
  # Climatoligcal mean
  
  df_mean <-
    df %>%
    filter(year < {{year_anom}},
           year >= {{year_anom}}-5) %>%
    group_by(name, !!!group_by) %>%
    summarize(
      fit = mean(value, na.rm = TRUE)
    ) %>% 
    ungroup()
  
  
  df_mean <-
    full_join(
      df_mean,
      df
    ) %>%
    mutate(resid = value - fit)
  
  return(df_mean)
  
}

```

# Maps

The following maps show the absolute state of each variable in {{year_anom}} as provided through the pCO2 product, the change in that variable from 1990 to {{year_anom}}, as well es the anomalies in {{year_anom}}. Changes and anomalies are determined based on the predicted value of a linear regression model fit to the data from 1990 to `r {{year_anom}}-1`.

Maps are first presented as annual means, and than as monthly means. Note that the {{year_anom}} predictions for the monthly maps are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

Note: The increase the computational speed, I regridded all maps to 5X5Â° grid.

## Annual means

### {{year_anom}} absolute

```{r {{year_anom}}_annual_mean_maps, fig.asp=0.5}

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual %>%
  drop_na() %>% 
  anomaly_determination(lon, lat)

pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>%
  drop_na()

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         !(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Annual mean", {{year_anom}})) +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown())
  )

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}},
         name %in% name_divergent) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = value)) +
         labs(title = paste("Annual mean", {{year_anom}})) +
         scale_fill_divergent(
           name = labels_breaks(.x %>% distinct(name))) +
         theme(legend.title = element_markdown())
  )
  
```

### Trends

```{r {{year_anom}}_change_annual_mean_maps, fig.asp=0.5}


pco2_product_coarse_annual_regression <-
  pco2_product_coarse_annual_regression %>%
  group_by(name) %>%
  filter(year %in% c(min(year), max(year), {{year_anom}})) %>%
  ungroup()

pco2_product_coarse_annual_regression %>%
  select(-c(value, resid)) %>%
  filter(year %in% c(min(year), max(year))) %>%
  arrange(year) %>%
  group_by(lon, lat, name) %>%
  mutate(change = fit - lag(fit),
         period = paste(lag(year), year, sep = "-")) %>%
  ungroup() %>%
  filter(!is.na(change)) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = change)) +
      labs(title =  paste("Change: ",.x$period)) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown())
  )

```

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_annual_mean_maps, fig.asp=0.5}

pco2_product_coarse_annual_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>% 
  # head(1) %>%
  map( ~ map +
         geom_tile(data = .x,
                   aes(lon, lat, fill = resid)) +
         labs(title =  paste({{year_anom}},"anomaly")) +
         scale_fill_divergent(
           name = labels_breaks(.x %>% distinct(name))) +
         theme(legend.title = element_markdown())
  )

```


```{r write_anomaly_anomaly_year_annual_mean_maps}

pco2_product_coarse_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_map_annual.csv"))

```




## Monthly means

### {{year_anom}} absolute

```{r {{year_anom}}_monthly_mean_maps, fig.asp=1.6}

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly %>%
  drop_na() %>% 
  anomaly_determination(lon, lat, month)

pco2_product_coarse_monthly_regression <-
  pco2_product_coarse_monthly_regression %>% 
  drop_na()


pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}},
         !(name %in% name_divergent)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Monthly means", {{year_anom}})) +
      scale_fill_viridis_c(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )

pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}},
         name %in% name_divergent) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = value)) +
      labs(title = paste("Monthly means", {{year_anom}})) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )
  
```

### Trends

```{r {{year_anom}}_change_monthly_mean_maps, fig.asp=1.6}

pco2_product_coarse_monthly_regression %>%
  group_by(name) %>%
  filter(year %in% c(min(year), max(year))) %>%
  ungroup() %>%
  select(-c(value, resid)) %>%
  arrange(year) %>%
  group_by(lon, lat, name, month) %>%
  mutate(change = fit - lag(fit),
         period = paste(lag(year), year, sep = "-")) %>%
  ungroup() %>%
  filter(!is.na(change)) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = change)) +
      labs(title =  paste("Change: ", .x$period)) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap(~ month, ncol = 2)
  )

```

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_monthly_mean_maps, fig.asp=1.6}

pco2_product_coarse_monthly_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = resid)) +
      labs(title = paste({{year_anom}}, "anomaly")) +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      facet_wrap( ~ month, ncol = 2)
  )

```


```{r write_anomaly_anomaly_year_monthly_mean_maps}

pco2_product_coarse_monthly_regression %>%
  # filter(year == {{year_anom}}) %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_map_monthly.csv"))

```



# Hovmoeller plots

The following Hovmoeller plots show the anomalies from the prediction of the linear/quadratic fits.

Hovmoeller plots are first presented as annual means, and than as monthly means. Note that the predictions for the monthly Hovmoeller plots are done individually for each month, such the mean seasonal anomaly from the annual mean is removed.

## {{year_anom}} annual anomalies

```{r {{year_anom}}_hovmoeller_annual_anomaly, fig.asp=0.5}

pco2_product_hovmoeller_monthly_annual_regression <-
  pco2_product_hovmoeller_monthly_annual %>%
  anomaly_determination(lat) %>% 
  filter(!is.na(resid))

  
pco2_product_hovmoeller_monthly_annual_regression %>%
  # filter(name == "mld") %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Annual mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )


```


## {{year_anom}} monthly anomalies

```{r {{year_anom}}_hovmoeller_monthly_anomalies, fig.asp=0.5}

pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly %>%
  select(-c(decimal)) %>% 
  anomaly_determination(lat, month) %>% 
  filter(!is.na(resid))

  
pco2_product_hovmoeller_monthly_regression <-
  pco2_product_hovmoeller_monthly_regression %>%
  mutate(decimal = year + (month - 1) / 12)
  
pco2_product_hovmoeller_monthly_regression %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )
  



```

```{r write_hovmoeller_monthly_anomalies}

pco2_product_hovmoeller_monthly_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_anomaly_hovmoeller_monthly.csv"))

```



### Three years prior {{year_anom}}

```{r {{year_anom}}_hovmoeller_monthly_anomalies_recent_years, fig.asp=0.5}

pco2_product_hovmoeller_monthly_regression %>%
  filter(between(year, {{year_anom}}-2, {{year_anom}})) %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decimal, lat, fill = resid)) +
      geom_raster() +
      scale_fill_divergent(name = labels_breaks(.x %>% distinct(name))) +
      theme(legend.title = element_markdown()) +
      coord_cartesian(expand = 0) +
      labs(title = "Monthly mean anomalies",
           y = "Latitude") +
      theme(axis.title.x = element_blank())
  )

```


# Regional means and integrals

The following plots show regionally averaged (or integrated) values of each variable as provided through the pCO2 product, as well as the anomalies from the prediction of a linear/quadratic fit.

Anomalies are first presented relative to the predicted annual mean of each year, hence preserving the seasonality. Furthermore, anomalies are presented relative to the predicted monthly mean values, such that the mean seasonality is removed.


## {{year_anom}} absolute values

### Global

```{r figure_height}

fig.height <- pco2_product_monthly %>% 
  distinct(name) %>% 
  nrow()

fig.height <- (fig.height + 2) * 0.1

```



```{r {{year_anom}}_absolute_means_and_integrals_global, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% "Global") %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```

### Selected biomes

```{r {{year_anom}}_absolute_means_and_integrals_overview_biomes, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```


```{r {{year_anom}}_absolute_means_and_integrals_key_biomes, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = paste("Absolute values |", .x$biome)) +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )
  )

```

### Super biomes


```{r {{year_anom}}_absolute_means_and_integrals_overview_biomes_super, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, value, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Absolute values | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )


```


```{r {{year_anom}}_absolute_means_and_integrals_key_biomes_super, fig.asp=fig.height}

pco2_product_monthly %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, value, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = paste("Absolute values |", .x$biome)) +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_blank()
  )
  )

```

## {{year_anom}} anomalies

### Annual mean trends

```{r {{year_anom}}_annual_mean_trends, fig.asp=fig.height}

pco2_product_annual <-
  pco2_product_monthly %>%
  group_by(year, biome, name) %>%
  summarise(value = mean(value)) %>%
  ungroup()
  
pco2_product_annual %>% 
  filter(biome %in% "Global") %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point(data = . %>% filter(year != {{year_anom}})) +
  geom_point(data = . %>% filter(year == {{year_anom}}),
             shape = 1) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nexcl.", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )
  

pco2_product_annual %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point(data = . %>% filter(year != {{year_anom}}),
             size = 0.2) +
  geom_point(data = . %>% filter(year == {{year_anom}}),
             shape = 1) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nexcl.", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_annual %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point(data = . %>% filter(year != {{year_anom}}),
             size = 0.2) +
  geom_point(data = . %>% filter(year == {{year_anom}}),
             shape = 1) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              aes(col = "linear"),
              se = FALSE) +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  name %in% name_quadratic_fit),
              method = "lm",
              fullrange = TRUE,
              formula = y ~ x + I(x^2),
              aes(col = "quadratic"),
              se = FALSE) +
  scale_color_brewer(
    palette = "Set1",
    name = paste("Regression fit\nexcl.", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Annual mean trends | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_annual_regression <-
  pco2_product_annual %>%
  anomaly_determination(biome)
  

pco2_product_annual_regression %>%
  filter(biome %in% "Global") %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )
  

pco2_product_annual_regression %>%
  filter(biome %in% key_biomes) %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_regression %>%
  filter(biome %in% super_biomes) %>%
  ggplot(aes(year, resid)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = year),
             shape = 21) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_regression %>%
  filter(biome != "global") %>%
  ggplot(aes(biome, resid)) +
  geom_hline(yintercept = 0) +
  geom_jitter(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = year),
             shape = 21, width = 0.2) +
  scale_fill_grayC() +
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  labs(title = "Residual from fit to annual means (actual - predicted) | All biomes") +
  facet_grid(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )


```


```{r write_biome_annual_regression}

pco2_product_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_annual_regression.csv"))

```



```{r {{year_anom}}_anomalies_from_annual_mean_trends_overview, fig.asp=fig.height}


pco2_product_annual_detrended <-
  full_join(pco2_product_monthly,
            pco2_product_annual_regression %>% select(-c(value, resid))) %>%
  mutate(resid = value - fit)

pco2_product_annual_detrended %>% 
  filter(biome %in% "Global") %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_annual_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )

pco2_product_annual_detrended %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted annual mean | Selected super biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  )

```


```{r {{year_anom}}_anomalies_from_annual_mean_trends_key_biomes, fig.asp=fig.height}

pco2_product_annual_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted annual mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```


```{r {{year_anom}}_anomalies_from_annual_mean_trends_key_biomes_super, fig.asp=fig.height}

pco2_product_annual_detrended %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted annual mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```



```{r write_biome_annual_detrended}

pco2_product_annual_detrended %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_annual_detrended.csv"))

```



### Monthly mean trends

```{r {{year_anom}}_monthly_mean_trends, fig.asp=fig.height}

pco2_product_monthly %>% 
  filter(biome %in% "Global") %>%
  mutate(month = as.factor(month)) %>% 
  ggplot(aes(year, value, col = month)) +
  # geom_point() +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              se = FALSE,
              fullrange = TRUE) +
  geom_smooth(
    data = . %>% filter(year != {{year_anom}},
                        name %in% name_quadratic_fit),
    method = "lm",
    fullrange = TRUE,
    formula = y ~ x + I(x ^ 2),
    se = FALSE
  ) +
  scale_color_scico_d(palette = "romaO", 
    name = paste("Regression fit\nexcl.", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Monthly mean trends | Global") +
  facet_wrap(name ~ .,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             strip.position = "left",
             ncol = 2) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_monthly %>% 
  filter(biome %in% key_biomes) %>%
  mutate(month = as.factor(month)) %>% 
  ggplot(aes(year, value, col = month)) +
  # geom_point() +
  geom_smooth(data = . %>% filter(year != {{year_anom}},
                                  !(name %in% name_quadratic_fit)),
              method = "lm",
              fullrange = TRUE,
              se = FALSE) +
  geom_smooth(
    data = . %>% filter(year != {{year_anom}},
                        name %in% name_quadratic_fit),
    method = "lm",
    fullrange = TRUE,
    formula = y ~ x + I(x ^ 2),
    se = FALSE
  ) +
  scale_color_scico_d(palette = "romaO",
    name = paste("Regression fit\nexcl.", {{year_anom}})) +
  scale_x_continuous(breaks = seq(1980, 2020, 20)) +
  labs(title = "Monthly mean trends | Selected biomes") +
  facet_grid(name ~ biome,
             scales = "free_y",
             labeller = labeller(name = x_axis_labels),
             switch = "y") +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title = element_blank()
  )

pco2_product_monthly_regression <-
  pco2_product_monthly %>%
  anomaly_determination(biome, month)


pco2_product_monthly_regression %>%
  filter(biome %in% "Global") %>%
  group_split(month) %>%
  head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, resid)) +
      geom_hline(yintercept = 0) +
      geom_path() +
      geom_point(
        data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1980, 2020, 20)) +
      labs(title = "Residual from fit to monthly means (actual - predicted) | Global",
           subtitle = paste("Month:", .x$month)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )

pco2_product_monthly_regression %>%
  filter(biome %in% key_biomes) %>%
  group_split(month) %>%
  head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, resid)) +
      geom_hline(yintercept = 0) +
      geom_path() +
      geom_point(
        data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = year),
        shape = 21
      ) +
      scale_fill_grayC() +
      new_scale_fill() +
      geom_point(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(fill = as.factor(year)),
        shape = 21,
        size = 2
      )  +
      scale_fill_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1980, 2020, 20)) +
      labs(title = "Residual from fit to monthly means (actual - predicted) | Selected biomes",
           subtitle = paste("Month:", .x$month)) +
      facet_grid(
        name ~ biome,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        switch = "y"
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  )


```


```{r write_biome_monthly_regression}

pco2_product_monthly_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_monthly_regression.csv"))

```



### Global

```{r {{year_anom}}_anomalies_from_monthly_mean_trends_global, fig.asp=fig.height}


pco2_product_monthly_detrended <-
  full_join(pco2_product_monthly,
            pco2_product_monthly_regression %>% select(-c(value, resid))) %>%
  mutate(resid = value - fit)

pco2_product_monthly_detrended %>% 
  filter(biome %in% "Global") %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Global") +
  facet_wrap(
    name ~ .,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    strip.position = "left",
    ncol = 2
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_monthly_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

pco2_product_monthly_detrended %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected super biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

```

### Selected biomes

```{r {{year_anom}}_anomalies_from_monthly_mean_trends__key_biomes_overview, fig.asp=fig.height}

pco2_product_monthly_detrended %>% 
  filter(biome %in% key_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

```


```{r {{year_anom}}_anomalies_from_monthly_mean_trends_key_biomes, fig.asp=fig.height}

pco2_product_monthly_detrended %>%
  filter(biome %in% key_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted monthly mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```

### Super biomes

```{r {{year_anom}}_anomalies_from_monthly_mean_trends_biomes_super_overview, fig.asp=fig.height}


pco2_product_monthly_detrended %>% 
  filter(biome %in% super_biomes) %>%
  ggplot(aes(month, resid, group = as.factor(year))) +
  geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = year)) +
  scale_color_grayC() +
  new_scale_color() +
  geom_path(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
            aes(col = as.factor(year)),
            linewidth = 1) +
  scale_color_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
  labs(title = "Anomalies from predicted monthly mean | Selected super biomes") +
  facet_grid(
    name ~ biome,
    scales = "free_y",
    labeller = labeller(name = x_axis_labels),
    switch = "y"
  ) +
  theme(
    strip.text.y.left = element_markdown(),
    strip.placement = "outside",
    strip.background.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank()
  )

```


```{r {{year_anom}}_anomalies_from_monthly_mean_trends_biomes_super, fig.asp=fig.height}

pco2_product_monthly_detrended %>%
  filter(biome %in% super_biomes) %>%
  group_split(biome) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(month, resid, group = as.factor(year))) +
      geom_path(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
                aes(col = year)) +
      scale_color_grayC() +
      new_scale_color() +
      geom_path(
        data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
        aes(col = as.factor(year)),
        linewidth = 1
      ) +
      scale_color_manual(
        values = c("orange", "red"),
        guide = guide_legend(reverse = TRUE,
                             order = 1)
      ) +
      scale_x_continuous(breaks = seq(1, 12, 3), expand = c(0, 0)) +
      labs(title = paste("Anomalies from predicted monthly mean |", .x$biome)) +
      facet_wrap(
        name ~ .,
        scales = "free_y",
        labeller = labeller(name = x_axis_labels),
        strip.position = "left",
        ncol = 2
      ) +
      theme(
        strip.text.y.left = element_markdown(),
        strip.placement = "outside",
        strip.background.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()
      )
  )


```


```{r write_biome_monthly_detrended}

pco2_product_monthly_detrended %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_biome_monthly_detrended.csv"))

```




# {{year_anom}} anomaly correlation


The following plots aim to unravel the correlation between regionally integrated monthly flux anomalies and the corresponding anomalies of the means/integrals of each other variable.

Anomalies are first presented are first presented in absolute units. Due to the different flux magnitudes, we need to plot integrated fluxes separately for each region. Secondly, we normalize the monthly anomalies to the spread (expressed as standard deviation) of the residuals from the fit.

## Annual anomalies

### Absolute

```{r {{year_anom}}_anomalies_correlation_absolute_global_annual, fig.asp=fig.height}

pco2_product_annual_regression %>%
  filter(biome == "Global") %>%
  select(-c(value, fit)) %>% 
  pivot_wider(values_from = resid) %>% 
  pivot_longer(-c(year, biome, fgco2_int))  %>%
  ggplot(aes(value, fgco2_int)) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = year),
             shape = 21) +
  geom_smooth(
    data = . %>% filter(!between(year, {{year_anom}}-1, {{year_anom}})),
    method = "lm",
    se = FALSE,
    fullrange = TRUE,
    aes(col = paste("Regression fit\nexcl.", {{year_anom}}))
  ) +
  scale_color_grey() +
  scale_fill_grayC()+
  new_scale_fill() +
  geom_point(data = . %>% filter(between(year, {{year_anom}}-1, {{year_anom}})),
             aes(fill = as.factor(year)),
             shape = 21, size = 2)  +
  scale_fill_manual(values = c("orange", "red"),
                     guide = guide_legend(reverse = TRUE,
                                          order = 1)) +
  labs(title = "Globally integrated fluxes",
       y = labels_breaks("fgco2_int")$i_legend_title) +
  facet_wrap(
    ~ name,
    scales = "free_x",
    labeller = labeller(name = x_axis_labels),
    strip.position = "bottom",
    ncol = 2
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.y = element_markdown(),
    axis.title.x = element_blank(),
    legend.title = element_blank()
  )


```

## Monthly anomalies

### Absolute

```{r {{year_anom}}_anomalies_correlation_absolute_global_monthly, fig.asp=fig.height}


pco2_product_monthly_detrended_anomaly <-
  pco2_product_monthly_detrended %>%
  select(year, month, biome, name, resid) %>%
  pivot_wider(names_from = name,
              values_from = resid)


pco2_product_monthly_detrended_anomaly %>%
  filter(biome == "Global") %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  ggplot(aes(value, fgco2_int)) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(year != {{year_anom}}),
             aes(col = paste(min(year), max(year), sep = "-")),
             alpha = 0.2) +
  geom_smooth(
    data = . %>% filter(year != {{year_anom}}),
    aes(col = paste(min(year), max(year), sep = "-")),
    method = "lm",
    se = FALSE,
    fullrange = TRUE
  )  +
  scale_color_grey(name = "") +
  new_scale_color() +
  geom_path(data = . %>% filter(year == {{year_anom}}),
            aes(col = as.factor(month), group = 1))  +
  geom_point(data = . %>% filter(year == {{year_anom}}),
             aes(fill =  as.factor(month)),
             shape = 21,
             size = 3)  +
  scale_color_scico_d(palette = "buda",
                     guide = guide_legend(reverse = TRUE,
                                          order = 1),
                     name = paste("Month\nof", {{year_anom}})) +
  scale_fill_scico_d(palette = "buda",
                     guide = guide_legend(reverse = TRUE,
                                          order = 1),
                     name = paste("Month\nof", {{year_anom}})) +
  labs(title = "Globally integrated fluxes",
       y = labels_breaks("fgco2_int")$i_legend_title) +
  facet_wrap(
    ~ name,
    scales = "free_x",
    labeller = labeller(name = x_axis_labels),
    strip.position = "bottom",
    ncol = 2
  ) +
  theme(
    strip.text.x.bottom = element_markdown(),
    strip.placement = "outside",
    strip.background.x = element_blank(),
    axis.title.y = element_markdown(),
    axis.title.x = element_blank()
  )


```

```{r {{year_anom}}_anomalies_correlation_absolute_biome_monthly, fig.asp=1.8}

pco2_product_monthly_detrended_anomaly %>%
  filter(!(biome %in% c(super_biomes, "Global"))) %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3, scales = "free") +
      labs(
        title = "Biome integrated fluxes",
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(.x %>% distinct(name))$i_legend_title
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```

```{r {{year_anom}}_anomalies_correlation_absolute_super_biome_monthly, fig.asp=0.5}

pco2_product_monthly_detrended_anomaly %>%
  filter(biome %in% super_biomes) %>%
  pivot_longer(-c(year, month, biome, fgco2_int))  %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3, scales = "free_x") +
      labs(
        title = "Super biome integrated fluxes",
        y = labels_breaks("fgco2_int")$i_legend_title,
        x = labels_breaks(.x %>% distinct(name))$i_legend_title
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```


### Relative to spread

```{r {{year_anom}}_anomalies_correlation_realtive_to_spread_monthly, fig.asp=2}


pco2_product_monthly_detrended_anomaly_spread <-
  pco2_product_monthly_detrended_anomaly %>%
  pivot_longer(-c(month, biome, year)) %>%
  filter(year != {{year_anom}}) %>%
  group_by(month, biome, name) %>%
  summarise(spread = sd(value, na.rm = TRUE)) %>%
  ungroup()



pco2_product_monthly_detrended_anomaly_relative <-
  full_join(
    pco2_product_monthly_detrended_anomaly_spread,
    pco2_product_monthly_detrended_anomaly %>%
      pivot_longer(-c(month, biome, year))
  )

pco2_product_monthly_detrended_anomaly_relative <-
  pco2_product_monthly_detrended_anomaly_relative %>%
  mutate(value = value / spread) %>%
  select(-spread) %>%
  pivot_wider() %>%
  pivot_longer(-c(month, biome, year, fgco2_int))



pco2_product_monthly_detrended_anomaly_relative %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(value, fgco2_int)) +
      geom_vline(xintercept = 0) +
      geom_hline(yintercept = 0) +
      geom_point(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        alpha = 0.2
      ) +
      geom_smooth(
        data = . %>% filter(year != {{year_anom}}),
        aes(col = paste(min(year), max(year), sep = "-")),
        method = "lm",
        se = FALSE,
        fullrange = TRUE
      )  +
      scale_color_grey(name = "") +
      new_scale_color() +
      geom_path(data = . %>% filter(year == {{year_anom}}),
                aes(col = as.factor(month), group = 1))  +
      geom_point(
        data = . %>% filter(year == {{year_anom}}),
        aes(fill = as.factor(month)),
        shape = 21,
        size = 3
      )  +
      scale_color_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      scale_fill_scico_d(
        palette = "buda",
        guide = guide_legend(reverse = TRUE,
                             order = 1),
        name = paste("Month\nof", {{year_anom}})
      ) +
      facet_wrap( ~ biome, ncol = 3) +
      coord_fixed() +
      labs(
        title = "Biome integrated fluxes normalized to spread",
        y = str_split_i(labels_breaks("fgco2_int")$i_legend_title, "<br>", i = 1),
        x = str_split_i(labels_breaks(.x %>% distinct(name))$i_legend_title, "<br>", i = 1)
      ) +
      theme(axis.title.x = element_markdown(),
            axis.title.y = element_markdown())
  )


```


# Zonal mean sections

The following analysis is available for GOBMs only.

## Annual means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_zonal_mean_sections_annual, fig.asp=1, eval=model}

pco2_product_zonal_mean_annual <-   pco2_product_zonal_mean %>%
  pivot_longer(-c(region, depth, lat, time, year, month)) %>%
  group_by(region, lat, depth, year, name) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  drop_na() %>%
  mutate(region = str_to_title(region))

pco2_product_zonal_mean_annual_regression <-
  pco2_product_zonal_mean_annual %>% 
  anomaly_determination(region, lat, depth)

pco2_product_zonal_mean_annual_regression %>%
  filter(year == {{year_anom}}) %>%
  group_split(name) %>%
  # head(3) %>%
  map(
    ~ ggplot(data = .x) +
      geom_contour_filled(aes(lat, depth, z = resid)) +
      scale_fill_discrete_divergingx(name = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      guides(fill = guide_colorsteps(
        barheight = unit(8, "cm"),
        show.limits = TRUE
      )) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      scale_x_continuous(breaks = seq(-100, 100, 20)) +
      coord_cartesian(expand = 0) +
      facet_wrap( ~ region, ncol = 1) +
      labs(y = "Depth (m)") +
      theme(legend.title = element_markdown())
  )

```


```{r write_anomaly_anomaly_year_zonal_mean_sections_annual, eval=model}

pco2_product_zonal_mean_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_zonal_mean_sections_annual.csv"))

```

# Biome profiles

The following analysis is available for GOBMs only.

## Annual means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_annual, fig.asp=1, eval=model}

pco2_product_profiles_annual <-   pco2_product_profiles %>%
  pivot_longer(-c(biome, depth, time, year, month)) %>%
  group_by(biome, depth, year, name) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  drop_na()

pco2_product_profiles_annual_regression <-
  pco2_product_profiles_annual %>% 
  anomaly_determination(biome, depth)

pco2_product_profiles_annual_regression %>%
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_path(aes(resid, depth, group = year), col = "grey30", alpha = 0.5) +
      geom_path(data = .x %>% filter(year == {{year_anom}}),
                aes(resid, depth, col = as.factor(year)),
                linewidth = 1) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50,100,200,400)) +
      facet_wrap( ~ biome) +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```


```{r write_anomaly_year_profiles_annual, eval=model}

pco2_product_profiles_annual_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_profiles_annual.csv"))

```

## Monthly means

### {{year_anom}} anomaly

```{r {{year_anom}}_anomaly_profiles_monthly, fig.asp=1, eval=model}

pco2_product_profiles_monthly <-   pco2_product_profiles %>%
  pivot_longer(-c(biome, depth, time, year, month)) %>%
  group_by(biome, depth, year, month, name) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  drop_na()

pco2_product_profiles_monthly_regression <-
  pco2_product_profiles_monthly %>% 
  anomaly_determination(biome, depth, month)

pco2_product_profiles_monthly_regression %>%
  filter(year == {{year_anom}}) %>% 
  group_split(name) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x) +
      geom_vline(xintercept = 0) +
      geom_path(aes(resid, depth, col = as.factor(month)),
                linewidth = 1) +
      scale_color_scico_d(palette = "hawaii") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(50, 100, 200, 400)) +
      facet_wrap(~ biome,
                 scales = "free_x") +
      labs(y = "Depth (m)",
           x = labels_breaks(.x %>% distinct(name))$i_legend_title) +
      theme(legend.title = element_blank(),
            axis.title.x = element_markdown())
  )

```


```{r write_anomaly_year_profiles_monthly, eval=model}

pco2_product_profiles_monthly_regression %>%
  write_csv(paste0("../data/","{{product_name}}","_","{{year_anom}}","_profiles_monthly.csv"))

```

